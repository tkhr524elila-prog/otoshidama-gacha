<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1f">
  <title>お年玉ガチャ（スマホゲーム風）</title>

  <style>
    :root{
      --bg0:#050816; --bg1:#090d22; --bg2:#120a2b;
      --text:#eef3ff; --muted:#a9b4da;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;

      --n:#9aa6c8;
      --r:#4be3ff;
      --sr:#ff8a2a;
      --ssr:#ffd54a;
      --ssr2:#ff4bd6;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(124,77,255,.35), transparent 60%),
        radial-gradient(900px 550px at 95% 25%, rgba(75,227,255,.18), transparent 55%),
        radial-gradient(900px 650px at 55% 110%, rgba(255,122,0,.20), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      min-height:100%;
      padding-bottom: calc(98px + env(safe-area-inset-bottom));
      overflow-x:hidden;
    }

    /* ===== top gem ===== */
    .top{
      position:fixed; left:0; right:0; top:0;
      padding: calc(10px + env(safe-area-inset-top)) 12px 10px;
      z-index:30;
      pointer-events:none;
    }
    .topRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      max-width:900px; margin:0 auto;
    }
    .gemBox{
      pointer-events:auto;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.38);
      min-width: 190px;
    }
    .gemIcon{
      width:18px;height:18px;border-radius:6px;
      background: conic-gradient(from 160deg, #4be3ff, #7c4dff, #ff7a00, #4be3ff);
      box-shadow: 0 0 16px rgba(75,227,255,.25);
      transform: rotate(12deg);
      flex:0 0 auto;
    }
    .gemNum{font-weight:1000; letter-spacing:.02em}
    .gemSmall{font-size:11px;color:var(--muted)}

    /* ===== main ===== */
    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 86px 12px 0;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .heroCard{
      border:1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.18));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .heroIn{padding:14px 14px 12px}
    .title{font-weight:1200; letter-spacing:.03em; font-size:16px}
    .sub{font-size:12px;color:var(--muted); margin-top:6px; line-height:1.4}
    .chips{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .chip{
      font-size:12px; font-weight:1000;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    .panel{
      border:1px solid var(--line);
      border-radius: 22px;
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }

    .rateWrap{padding:12px 12px 14px}
    .rateTitle{font-size:12px;color:var(--muted); font-weight:1000}
    .rateTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
      margin-top:10px;
      font-size:13px;
    }
    .rateRow{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
    }
    .rateTable td{
      padding:10px 10px;
      vertical-align:middle;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:1100;
      letter-spacing:.04em;
      text-transform:uppercase;
      min-width: 76px;
      justify-content:center;
    }
    .dot{width:8px;height:8px;border-radius:999px}
    .cN .dot{background:var(--n)}
    .cR .dot{background:var(--r)}
    .cSR .dot{background:var(--sr)}
    .cSSR .dot{background: linear-gradient(135deg, var(--ssr), var(--ssr2)); box-shadow:0 0 14px rgba(255,213,74,.25)}

    .rightText{color:var(--muted); font-size:12px; text-align:right}
    .vals{font-weight:1000; color:var(--text)}
    .noteSmall{font-size:11px;color:var(--muted); margin-top:8px; line-height:1.4}

    /* ===== bottom action ===== */
    .bottom{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index:40;
      background: linear-gradient(180deg, rgba(5,8,22,0), rgba(5,8,22,.88) 35%, rgba(5,8,22,.95));
      backdrop-filter: blur(10px);
    }
    .bottomIn{
      max-width:900px; margin:0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn{
      border:0;
      border-radius: 18px;
      padding: 14px 14px;
      font-weight:1200;
      letter-spacing:.02em;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      transition: transform .08s ease, opacity .12s ease, filter .12s ease;
    }
    .btn:active{transform: scale(.987)}
    .btn[disabled]{opacity:.45; cursor:not-allowed; filter:saturate(.75)}
    .b1{
      background: linear-gradient(180deg, rgba(75,227,255,.95), rgba(124,77,255,.95));
      color:#081022;
    }
    .b10{
      background: linear-gradient(180deg, #ffd54a, #ff7a00);
      color:#081022;
      position:relative;
      overflow:hidden;
    }
    .cost{
      display:inline-flex; align-items:center; gap:6px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.18);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1200;
      color: rgba(10,14,25,.92);
      backdrop-filter: blur(6px);
    }
    .miniGem{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,#4be3ff,#7c4dff)}
    .stamp{
      position:absolute; right:12px; top:10px;
      transform: rotate(-12deg);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1300;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.18);
      color:#0b1022;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      box-shadow: 0 10px 26px rgba(255,122,0,.22);
    }

    /* ===== toast ===== */
    .toast{
      position:fixed;
      left:12px; right:12px;
      top: calc(54px + env(safe-area-inset-top));
      max-width: 900px;
      margin: 0 auto;
      z-index:60;
      display:none;
      pointer-events:none;
    }
    .toast.show{display:block}
    .toastIn{
      pointer-events:auto;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.34);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .toastTitle{font-weight:1200}
    .toastSub{font-size:12px;color:var(--muted); margin-top:2px}
    .toastBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1200;
      cursor:pointer;
      flex:0 0 auto;
    }

    /* ===== modal overlay ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.80);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index:80;
    }
    .overlay.show{display:flex}

    .modal{
      width: min(760px, 100%);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(700px 420px at 28% 10%, rgba(124,77,255,.35), transparent 60%),
        radial-gradient(700px 420px at 75% 90%, rgba(75,227,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
      box-shadow: 0 30px 110px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
    }

    .modalTop{
      padding: 14px 14px 0;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .mTitle{font-weight:1300}
    .mSub{font-size:12px;color:var(--muted); margin-top:6px; line-height:1.35}
    .xbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1200;
      cursor:pointer;
      flex:0 0 auto;
    }

    /* ===== opening area ===== */
    .openArea{padding: 14px}
    .tapHint{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      min-height: 18px;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top: 12px;
    }
    @media(min-width:520px){
      .cards{grid-template-columns: repeat(3, 1fr);}
    }
    @media(min-width:720px){
      .cards{grid-template-columns: repeat(5, 1fr);}
    }

    .card{
      position:relative;
      height: 104px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      transform: translateZ(0);
    }

    .card.back{
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .card.back::before{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, rgba(255,255,255,.0), rgba(255,255,255,.18), rgba(255,255,255,.0));
      animation: spin 1.25s linear infinite;
      opacity: .55;
      mix-blend-mode: screen;
    }
    .card.back::after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,.18) 70%);
    }
    .cardNum{
      position:absolute;
      left:10px; top:10px;
      font-size:11px;
      color: rgba(255,255,255,.75);
      font-weight:1100;
      z-index:2;
    }
    .tap{
      z-index:2;
      font-weight:1300;
      letter-spacing:.06em;
      color: rgba(255,255,255,.92);
      text-shadow: 0 8px 20px rgba(0,0,0,.55);
    }

    /* revealed face */
    .face{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      opacity:0;
      transform: scale(.98);
      transition: opacity .18s ease, transform .18s ease;
      padding: 10px;
      text-align:center;
    }
    .card.opened .face{opacity:1; transform:scale(1)}
    .rarTag{
      font-size:12px;
      font-weight:1300;
      letter-spacing:.10em;
    }
    .amt{
      font-size: 22px;
      font-weight:1400;
      letter-spacing:.02em;
      line-height:1.0;
    }

    /* frame by rarity */
    .card.rN{border-color: rgba(154,166,200,.45)}
    .card.rR{border-color: rgba(75,227,255,.55); box-shadow: 0 14px 46px rgba(75,227,255,.12), 0 14px 40px rgba(0,0,0,.35)}
    .card.rSR{border-color: rgba(255,138,42,.60); box-shadow: 0 14px 50px rgba(255,138,42,.13), 0 14px 40px rgba(0,0,0,.35)}
    .card.rSSR{
      border-color: rgba(255,213,74,.70);
      box-shadow: 0 16px 70px rgba(255,213,74,.18), 0 14px 40px rgba(0,0,0,.35);
    }

    /* SSR: rotate -> crack -> light leak */
    .ssrFx{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
    }
    .card.rSSR.opening .ssrFx{opacity:1}

    .ssrFx .leak{
      position:absolute; inset:-55%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.55),
        rgba(255,214,0,.65),
        rgba(75,227,255,.55),
        rgba(124,77,255,.55),
        rgba(255,122,0,.60),
        rgba(255,0,92,.55),
        rgba(255,0,92,.0)
      );
      filter: blur(10px) saturate(1.25);
      mix-blend-mode: screen;
      animation: spin 1.0s linear infinite;
      opacity:.0;
      transition: opacity .2s ease;
    }
    .card.rSSR.opening .ssrFx .leak{opacity:.95}

    .ssrFx .flash{
      position:absolute; inset:0;
      background: rgba(255,255,255,1);
      opacity:0;
    }
    .card.rSSR.burst .ssrFx .flash{ animation: flash .55s ease; }

    .ssrFx .crackL, .ssrFx .crackR{
      position:absolute;
      top:-10%; bottom:-10%;
      width: 2px;
      background: rgba(255,255,255,.85);
      opacity:0;
      filter: drop-shadow(0 0 10px rgba(255,213,74,.35));
    }
    .ssrFx .crackL{left:47%; transform: rotate(8deg)}
    .ssrFx .crackR{left:53%; transform: rotate(-10deg)}
    .card.rSSR.cracking .ssrFx .crackL,
    .card.rSSR.cracking .ssrFx .crackR{
      opacity:.75;
      animation: crack .38s ease;
    }
    @keyframes crack{
      0%{transform:translateY(-8px) scaleY(.6)}
      100%{transform:translateY(0) scaleY(1)}
    }

    /* SSR "shatter" feel */
    .shard{
      position:absolute;
      width: 10px; height: 16px;
      border-radius: 4px;
      background: rgba(255,255,255,.85);
      opacity:0;
      filter: drop-shadow(0 0 10px rgba(255,213,74,.22));
    }
    .card.rSSR.shatter .shard{
      opacity:1;
      animation: shard 520ms ease-out forwards;
    }
    @keyframes shard{
      0%{transform: translate(0,0) rotate(0deg); opacity:1}
      100%{transform: translate(var(--dx), var(--dy)) rotate(var(--dr)); opacity:0}
    }

    /* rainbow omen bar */
    .omen{
      position:absolute; left:10px; right:10px; bottom:10px;
      height: 10px;
      border-radius:999px;
      background: linear-gradient(90deg, #ff4bd6, #ffd54a, #4be3ff, #7c4dff, #ff7a00);
      opacity:0;
      filter: blur(.2px) saturate(1.2);
      box-shadow: 0 0 16px rgba(255,213,74,.14);
      transition: opacity .18s ease;
    }
    .omen.show{opacity:1}

    @keyframes spin{to{transform: rotate(360deg)}}
    @keyframes flash{0%{opacity:0}12%{opacity:.95}100%{opacity:0}}

    /* ===== total reveal ===== */
    .totalArea{
      margin-top: 14px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 14px;
      overflow:hidden;
      position:relative;
      display:none;
    }
    .totalArea.show{display:block}
    .totalTitle{color:var(--muted); font-size:12px; font-weight:1000}
    .totalMoney{
      margin-top:8px;
      font-size: 42px;
      font-weight:1500;
      letter-spacing:.02em;
      line-height:1.05;
      text-shadow: 0 12px 40px rgba(0,0,0,.6);
    }
    .totalRank{
      margin-top:10px;
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:1200;
      letter-spacing:.08em;
    }
    .totalFx{
      position:absolute; inset:-60%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.45),
        rgba(255,214,0,.50),
        rgba(75,227,255,.45),
        rgba(124,77,255,.45),
        rgba(255,122,0,.50),
        rgba(255,0,92,.45),
        rgba(255,0,92,.0)
      );
      opacity:0;
      animation: spin 1.2s linear infinite;
      mix-blend-mode: screen;
      filter: blur(12px) saturate(1.2);
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .totalArea.ssr .totalFx{opacity:.95}

    .totalFlash{
      position:absolute; inset:0;
      background: rgba(255,255,255,1);
      opacity:0; pointer-events:none;
    }
    .totalArea.boom .totalFlash{animation: flash .55s ease}

    .totalArea.boom .totalMoney{
      animation: pop 700ms cubic-bezier(.2,.9,.2,1) both;
    }
    @keyframes pop{
      0%{transform: scale(.92); opacity:.0}
      20%{transform: scale(1.08); opacity:1}
      100%{transform: scale(1.0); opacity:1}
    }

    /* ===== tiny tools ===== */
    .tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .toolBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1200;
      cursor:pointer;
    }

    /* tap cooldown visual */
    .cool{
      opacity:.7;
      filter:saturate(.8);
      pointer-events:none;
    }
  </style>
</head>

<body>
  <!-- TOP -->
  <div class="top">
    <div class="topRow">
      <div class="gemBox" id="gemBox" title="ジェム">
        <div class="gemIcon"></div>
        <div>
          <div class="gemNum"><span id="gems">0</span> <span class="gemSmall">GEMS</span></div>
          <div class="gemSmall">所持ジェム（左上）</div>
        </div>
      </div>
      <div></div>
    </div>
  </div>

  <!-- TOAST: login bonus -->
  <div class="toast" id="toast">
    <div class="toastIn">
      <div>
        <div class="toastTitle">ログインボーナスが届きました！</div>
        <div class="toastSub">タップして「ジェム3,000個」を受け取ろう</div>
      </div>
      <button class="toastBtn" id="toastBtn">受け取る</button>
    </div>
  </div>

  <div class="wrap">
    <div class="heroCard">
      <div class="heroIn">
        <div class="title">お年玉ガチャ（スマホゲーム風）</div>
        <div class="sub">
          下のボタンで回す → 10連は<strong>SSR確定！</strong> → 1枚ずつ「タップで開封」 → 最後に合計をド派手に表示。<br>
          ※ 10連の最大は<strong>合計30,000円</strong>（SSR=3,000円×10回）。
        </div>

        <div class="chips">
          <div class="chip">1連：300ジェム</div>
          <div class="chip">10連：3000ジェム</div>
          <div class="chip">10連はSSR確定スタンプ</div>
          <div class="chip">タップ受付：0.3秒クールダウン</div>
        </div>

        <div class="tools">
          <button class="toolBtn" id="openRates">提供割合を見る</button>
          <button class="toolBtn" id="resetBtn">初期化（親PIN）</button>
        </div>
      </div>

      <div class="panel" id="ratePanel" style="display:none;">
        <div class="rateWrap">
          <div class="rateTitle">提供割合（ゲームっぽい表）</div>

          <table class="rateTable" aria-label="提供割合">
            <tr class="rateRow">
              <td><span class="pill cSSR"><span class="dot"></span>SSR</span></td>
              <td class="vals">3,000円</td>
              <td class="rightText">※10連は「1枠SSR確定」</td>
            </tr>
            <tr class="rateRow">
              <td><span class="pill cSR"><span class="dot"></span>SR</span></td>
              <td class="vals">1,000円</td>
              <td class="rightText">—</td>
            </tr>
            <tr class="rateRow">
              <td><span class="pill cR"><span class="dot"></span>R</span></td>
              <td class="vals">100 / 300 / 500円</td>
              <td class="rightText">—</td>
            </tr>
            <tr class="rateRow">
              <td><span class="pill cN"><span class="dot"></span>N</span></td>
              <td class="vals">10 / 50円</td>
              <td class="rightText">—</td>
            </tr>
          </table>

          <div class="noteSmall" id="rateNote"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM ACTION -->
  <div class="bottom">
    <div class="bottomIn">
      <button class="btn b1" id="oneBtn">
        <span>1回ガチャ</span>
        <span class="cost"><span class="miniGem"></span>300</span>
      </button>

      <button class="btn b10" id="tenBtn">
        <span>SSR確定！10連ガチャ</span>
        <span class="cost"><span class="miniGem"></span>3000</span>
        <span class="stamp" id="ssrStamp">SSR確定！</span>
      </button>
    </div>
  </div>

  <!-- OVERLAY MODAL -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <div>
          <div class="mTitle" id="mTitle">ガチャ</div>
          <div class="mSub" id="mSub">—</div>
        </div>
        <button class="xbtn" id="closeX">閉じる</button>
      </div>

      <div class="openArea">
        <div class="tapHint" id="tapHint">—</div>

        <div class="cards" id="cards"></div>

        <div class="totalArea" id="totalArea">
          <div class="totalFx"></div>
          <div class="totalFlash"></div>
          <div class="totalTitle" id="totalTitle">合計は……</div>
          <div class="totalMoney" id="totalMoney">¥0</div>
          <div class="totalRank" id="totalRank">READY</div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  設定（数値・確率）
 * ========================= */
const CFG = {
  BONUS_GEMS: 3000,

  COST_ONE: 300,
  COST_TEN: 3000,

  MAX_TOTAL: 30000,

  // 親PIN（開発用）
  PARENT_PIN: "2525",

  // 1連用：期待値 1,000円（10連期待値 10,000円相当）
  // 金額: 確率（合計=1.0）
  // N10 2% / N50 3% / R100 5.85% / R300 14.15% / R500 12% / SR1000 50% / SSR3000 13%
  PROB_ONE: [
    {amt:10,   rar:"N",   p:0.02},
    {amt:50,   rar:"N",   p:0.03},
    {amt:100,  rar:"R",   p:0.0585},
    {amt:300,  rar:"R",   p:0.1415},
    {amt:500,  rar:"R",   p:0.12},
    {amt:1000, rar:"SR",  p:0.50},
    {amt:3000, rar:"SSR", p:0.13},
  ],

  // 10連（SSR確定！）
  // 1枠は必ずSSR=3000円
  // 残り9枠は「SSRなし配布」で期待値をほどよく（※ゲーム感を優先）
  // SR比率高め、R/Nも混ぜる
  PROB_TEN_REST: [
    // ここはSSR無し
    {amt:10,   rar:"N",  p:0.02},
    {amt:50,   rar:"N",  p:0.03},
    {amt:100,  rar:"R",  p:0.0489},
    {amt:300,  rar:"R",  p:0.1178},
    {amt:500,  rar:"R",  p:0.0963},
    {amt:1000, rar:"SR", p:0.6870},
  ],

  TAP_COOLDOWN_MS: 300,
};

/** =========================
 *  永続化
 * ========================= */
const LS = {
  gems: "otg_gems_v2",
  bonusTaken: "otg_bonus_taken_v2",
};

const $ = (id)=>document.getElementById(id);
const yen = (n)=>"¥"+Number(n).toLocaleString("ja-JP");

function getGems(){
  const v = localStorage.getItem(LS.gems);
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}
function setGems(n){
  localStorage.setItem(LS.gems, String(n));
  render();
}
function bonusTaken(){
  return localStorage.getItem(LS.bonusTaken)==="1";
}
function setBonusTaken(){
  localStorage.setItem(LS.bonusTaken,"1");
}

/** =========================
 *  音（WebAudio）+ バイブ
 * ========================= */
let audioCtx;
function beep(seq){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const t0 = audioCtx.currentTime + 0.01;
    seq.forEach(s=>{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = s.type || "sine";
      o.frequency.value = s.f;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0 + s.at);
      g.gain.setValueAtTime(0.0001, t0 + s.at);
      g.gain.exponentialRampToValueAtTime(s.v || 0.12, t0 + s.at + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + s.at + s.d);
      o.stop(t0 + s.at + s.d + 0.03);
    });
  }catch(e){}
}
function vibe(ms){ if (navigator.vibrate) navigator.vibrate(ms); }

const SFX = {
  click(){ beep([{at:0,f:260,d:0.08,v:0.08,type:"square"}]); },
  start(){ beep([{at:0,f:196,d:0.10,v:0.10,type:"square"},{at:0.11,f:247,d:0.10,v:0.10,type:"square"}]); },
  flip(){ beep([{at:0,f:330,d:0.08,v:0.08,type:"sine"}]); },
  omen(){ beep([{at:0,f:523.25,d:0.10,v:0.10,type:"triangle"},{at:0.11,f:659.25,d:0.12,v:0.11,type:"triangle"}]); },
  sr(){ beep([{at:0,f:392,d:0.14,v:0.12},{at:0.14,f:523.25,d:0.18,v:0.13}]); },
  ssr(){
    beep([
      {at:0.00,f:523.25,d:0.14,v:0.14,type:"sawtooth"},
      {at:0.14,f:659.25,d:0.14,v:0.14,type:"sawtooth"},
      {at:0.28,f:783.99,d:0.20,v:0.16,type:"sawtooth"},
      {at:0.50,f:1046.5,d:0.26,v:0.18,type:"sine"}
    ]);
  },
  total(){
    beep([{at:0,f:392,d:0.12,v:0.12,type:"square"},{at:0.12,f:523.25,d:0.12,v:0.12,type:"square"},{at:0.24,f:659.25,d:0.18,v:0.14,type:"square"}]);
  },
  bonus(){
    beep([{at:0,f:523.25,d:0.12,v:0.10,type:"square"},{at:0.12,f:659.25,d:0.12,v:0.11,type:"square"}]);
  }
};

/** =========================
 *  確率抽選
 * ========================= */
function pickByProb(list){
  const r = Math.random();
  let acc = 0;
  for(const it of list){
    acc += it.p;
    if (r <= acc) return {amt:it.amt, rar:it.rar};
  }
  // 念のため最後
  const last = list[list.length-1];
  return {amt:last.amt, rar:last.rar};
}

/** =========================
 *  UI: 提供割合の説明文
 * ========================= */
function calcEV(list){
  return list.reduce((s,it)=>s+it.amt*it.p, 0);
}
function pct(x){ return (x*100).toFixed(2).replace(/\.00$/,"") + "%"; }

function renderRateNote(){
  const ev1 = calcEV(CFG.PROB_ONE);
  const rows1 = CFG.PROB_ONE.map(it=>`${it.rar} ${yen(it.amt)}: ${pct(it.p)}`).join(" / ");

  // 10連残り9枠
  const evRest = calcEV(CFG.PROB_TEN_REST);
  const rowsRest = CFG.PROB_TEN_REST.map(it=>`${it.rar} ${yen(it.amt)}: ${pct(it.p)}`).join(" / ");

  $("rateNote").innerHTML =
    `【1連】期待値：<b>${yen(Math.round(ev1))}</b> / 1回（※設計値）<br>`+
    `<span style="color:var(--muted)">${rows1}</span><br><br>`+
    `【SSR確定10連】1枠SSR固定 + 残り9枠の期待値：<b>${yen(Math.round(evRest))}</b> / 1枚<br>`+
    `<span style="color:var(--muted)">${rowsRest}</span>`;
}

/** =========================
 *  ガチャモーダル（開封体験）
 * ========================= */
let current = null; // {mode, pulls[], idx, opened[], total, cooldownUntil}
let omenShown = false;

function openOverlay(){
  $("overlay").classList.add("show");
}
function closeOverlay(){
  $("overlay").classList.remove("show");
}

function setHint(text){
  $("tapHint").textContent = text;
}

function rarityRank(r){
  return r==="SSR" ? 4 : r==="SR" ? 3 : r==="R" ? 2 : 1;
}
function rankLabel(total){
  if (total >= 30000) return "SSR（MAX）";
  if (total >= 20000) return "SR";
  if (total >= 10000) return "R";
  return "N";
}

function makeCard(i){
  const el = document.createElement("div");
  el.className = "card back";
  el.dataset.index = String(i);

  const num = document.createElement("div");
  num.className = "cardNum";
  num.textContent = (i+1)+"/10";
  el.appendChild(num);

  const tap = document.createElement("div");
  tap.className = "tap";
  tap.textContent = "TAP";
  el.appendChild(tap);

  // omen bar
  const omen = document.createElement("div");
  omen.className = "omen";
  omen.id = "omen-"+i;
  el.appendChild(omen);

  // revealed face
  const face = document.createElement("div");
  face.className = "face";

  const tag = document.createElement("div");
  tag.className = "rarTag";
  tag.id = "tag-"+i;

  const amt = document.createElement("div");
  amt.className = "amt";
  amt.id = "amt-"+i;

  face.appendChild(tag);
  face.appendChild(amt);
  el.appendChild(face);

  // SSR FX container
  const fx = document.createElement("div");
  fx.className = "ssrFx";
  fx.innerHTML = `
    <div class="leak"></div>
    <div class="flash"></div>
    <div class="crackL"></div>
    <div class="crackR"></div>
  `;
  // shards
  for(let s=0;s<10;s++){
    const sh = document.createElement("div");
    sh.className = "shard";
    const dx = (Math.random()*180 - 90).toFixed(0)+"px";
    const dy = (Math.random()*140 - 70).toFixed(0)+"px";
    const dr = (Math.random()*720 - 360).toFixed(0)+"deg";
    sh.style.setProperty("--dx", dx);
    sh.style.setProperty("--dy", dy);
    sh.style.setProperty("--dr", dr);
    fx.appendChild(sh);
  }
  el.appendChild(fx);

  el.addEventListener("click", onCardTap);
  return el;
}

function startTenOpen(pulls){
  current = {
    mode:"TEN",
    pulls,
    idx:0,
    opened: Array(10).fill(false),
    total:0,
    cooldownUntil:0
  };
  omenShown = false;

  $("mTitle").textContent = "SSR確定！10連ガチャ";
  $("mSub").textContent = "1枚ずつタップで開封 → 最後に合計を発表";
  setHint("カードをタップして開封（0.3秒クールダウン）");

  const cards = $("cards");
  cards.innerHTML = "";
  for(let i=0;i<10;i++){
    cards.appendChild(makeCard(i));
  }

  $("totalArea").className = "totalArea";
  $("totalArea").style.display = "none";
  $("totalMoney").textContent = yen(0);
  $("totalRank").textContent = "READY";

  openOverlay();

  // 「SSR確定！」スタンプ演出（モーダル内の見出しで代用）
  SFX.start(); vibe(35);
}

function startOneOpen(pull){
  // 1枚だけの開封は、10枚グリッドの1枚にする（見た目ゲーム寄せ）
  const pulls = [pull, ...Array.from({length:9},()=>({amt:0,rar:"N"}))];
  current = {
    mode:"ONE",
    pulls,
    idx:0,
    opened: Array(10).fill(false),
    total:0,
    cooldownUntil:0
  };
  omenShown = false;

  $("mTitle").textContent = "1回ガチャ";
  $("mSub").textContent = "タップで1枚開封 → すぐ結果";
  setHint("カードをタップして開封（0.3秒クールダウン）");

  const cards = $("cards");
  cards.innerHTML = "";
  for(let i=0;i<10;i++){
    cards.appendChild(makeCard(i));
    if(i>0){
      // ダミー9枚は「ロック」
      const c = cards.children[i];
      c.classList.add("cool");
      c.querySelector(".tap").textContent = "LOCK";
    }
  }

  $("totalArea").className = "totalArea";
  $("totalArea").style.display = "none";
  $("totalMoney").textContent = yen(0);
  $("totalRank").textContent = "READY";

  openOverlay();
  SFX.start(); vibe(20);
}

/** =========================
 *  予兆（A）
 *  次がSSRなら先に虹予兆を出す
 * ========================= */
function maybeShowOmen(nextIndex){
  if (!current || omenShown) return;
  if (nextIndex < 0 || nextIndex >= 10) return;

  // TENのみ「途中でSSR予兆」を強める
  if (current.mode !== "TEN") return;

  const next = current.pulls[nextIndex];
  if (next && next.rar === "SSR"){
    omenShown = true;
    // 虹バー点灯（今のカードの下に）
    const omenEl = $("omen-"+nextIndex);
    if (omenEl){
      omenEl.classList.add("show");
      setHint("……虹の気配がする（次、SSR…？）");
      SFX.omen(); vibe(45);
      setTimeout(()=>{ if(omenEl) omenEl.classList.remove("show"); setHint("カードをタップして開封"); }, 900);
    }
  }
}

/** =========================
 *  カードタップ（B）: 1枚ずつ開封
 * ========================= */
async function onCardTap(e){
  if (!current) return;

  const now = Date.now();
  if (now < current.cooldownUntil) return; // 0.3秒クールダウン
  current.cooldownUntil = now + CFG.TAP_COOLDOWN_MS;

  const idx = Number(e.currentTarget.dataset.index);
  if (!Number.isFinite(idx)) return;

  // 1回ガチャのLOCK
  if (current.mode==="ONE" && idx!==0) return;

  // まだそのカードの番でなければ（“順番に開封”）
  if (idx !== current.idx) {
    // 次をタップしても順番じゃないなら案内だけ
    setHint("左上から順番に開封してね（次は "+(current.idx+1)+" 枚目）");
    SFX.click();
    return;
  }

  const cardEl = e.currentTarget;
  if (current.opened[idx]) return;

  // 次がSSRなら予兆（A）
  maybeShowOmen(idx);

  const pull = current.pulls[idx];
  current.opened[idx] = true;

  // 開封演出
  await revealCard(cardEl, pull, idx);

  // 合計更新
  current.total += pull.amt;
  if (current.total > CFG.MAX_TOTAL) current.total = CFG.MAX_TOTAL;

  // 次へ
  current.idx += 1;

  // 全部開けたら「溜め → 合計ドン」
  if (current.idx >= (current.mode==="ONE" ? 1 : 10)){
    await totalReveal(current.total);
  }else{
    setHint("次のカードをタップ（"+(current.idx+1)+"/10）");
  }
}

function rarColor(r){
  return r==="SSR" ? "var(--ssr)" : r==="SR" ? "var(--sr)" : r==="R" ? "var(--r)" : "var(--n)";
}

async function revealCard(cardEl, pull, idx){
  // back → opening
  cardEl.classList.remove("back");
  cardEl.classList.add("opened");

  // rarity frame
  const r = pull.rar;
  cardEl.classList.add("r"+r);

  // basic flip SFX
  SFX.flip(); vibe(18);

  // fill face
  $("tag-"+idx).textContent = r;
  $("tag-"+idx).style.color = rarColor(r);
  $("amt-"+idx).textContent = yen(pull.amt);

  // SSR special: rotate -> crack -> shatter -> flash
  if (r==="SSR"){
    cardEl.classList.add("opening");
    // “回転”
    cardEl.animate(
      [{transform:"rotateY(0deg) scale(1)"},{transform:"rotateY(360deg) scale(1.05)"}],
      {duration:520, easing:"cubic-bezier(.2,.9,.2,1)"}
    );
    await wait(220);

    // “割れる（ヒビ）”
    cardEl.classList.add("cracking");
    await wait(220);

    // “破片”
    cardEl.classList.add("shatter");
    await wait(200);

    // “光が漏れる（フラッシュ）”
    cardEl.classList.add("burst");
    SFX.ssr(); vibe(120);

    await wait(320);
    cardEl.classList.remove("opening","cracking","shatter","burst");
  }else if (r==="SR"){
    SFX.sr(); vibe(55);
    cardEl.animate([{transform:"scale(1)"},{transform:"scale(1.05)"},{transform:"scale(1)"}],{duration:420, easing:"ease-out"});
  }else{
    // N/Rは軽め
    cardEl.animate([{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],{duration:240, easing:"ease-out"});
  }
}

async function totalReveal(total){
  setHint("……合計は…………");
  await wait(650);

  const area = $("totalArea");
  area.className = "totalArea";
  area.style.display = "block";

  // 合計のレアリティは「合計額」でランク付け
  const label = rankLabel(total);
  $("totalTitle").textContent = "合計は…………";
  $("totalMoney").textContent = "……";
  $("totalRank").textContent = "—";

  await wait(520);

  // 派手ドン
  const isSSR = (total >= 30000);
  if (isSSR) area.classList.add("ssr");
  area.classList.add("boom");
  $("totalMoney").textContent = yen(total);
  $("totalRank").textContent = label;

  SFX.total(); vibe(isSSR ? 180 : 90);

  // もう一段フラッシュ感
  if (isSSR){
    await wait(140);
    area.classList.remove("boom"); void area.offsetWidth;
    area.classList.add("boom");
  }

  setHint("結果確定！ 閉じるで戻る");
}

/** =========================
 *  ログインボーナス（通知→タップで受取）
 * ========================= */
function showToast(){
  $("toast").classList.add("show");
}
function hideToast(){
  $("toast").classList.remove("show");
}

function openBonusFlow(){
  // 受け取り確認（OKで受取）
  const ok = confirm("ログインボーナス：ジェム3,000個を受け取りますか？");
  if (!ok) return;
  if (bonusTaken()){
    alert("ログインボーナスは受け取り済みです");
    hideToast();
    return;
  }
  setBonusTaken();
  setGems(getGems() + CFG.BONUS_GEMS);
  SFX.bonus(); vibe(55);
  hideToast();
  alert("ジェム3,000個を受け取りました！");
}

/** =========================
 *  回す（ボタン）
 * ========================= */
function ensureGems(cost){
  if (getGems() < cost){
    alert("ジェムが足りません");
    return false;
  }
  setGems(getGems() - cost);
  return true;
}

function doOne(){
  if (!ensureGems(CFG.COST_ONE)) return;
  const pull = pickByProb(CFG.PROB_ONE);
  startOneOpen(pull);
}

function doTen(){
  if (!ensureGems(CFG.COST_TEN)) return;

  // 10連：1枠SSR確定 + 残り9枠は PROB_TEN_REST
  const pulls = Array.from({length:10}, ()=>({amt:0,rar:"N"}));
  const ssrPos = Math.floor(Math.random()*10);
  pulls[ssrPos] = {amt:3000, rar:"SSR"};

  for(let i=0;i<10;i++){
    if (i===ssrPos) continue;
    pulls[i] = pickByProb(CFG.PROB_TEN_REST);
  }

  startTenOpen(pulls);
}

/** =========================
 *  初期化（親PIN）
 * ========================= */
function resetAll(){
  const pin = prompt("親PINを入力してください");
  if (pin===null) return;
  if (pin !== CFG.PARENT_PIN){
    alert("PINが違います");
    return;
  }
  localStorage.removeItem(LS.gems);
  localStorage.removeItem(LS.bonusTaken);
  render();
  alert("初期化しました（ログインボーナスも受け取り直せます）");
}

/** =========================
 *  描画
 * ========================= */
function render(){
  $("gems").textContent = getGems();
  $("oneBtn").disabled = getGems() < CFG.COST_ONE;
  $("tenBtn").disabled = getGems() < CFG.COST_TEN;

  // 未受取ならトーストを出す（開いたら通知→タップで受取）
  if (!bonusTaken()){
    showToast();
  }else{
    hideToast();
  }
}

function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

/** =========================
 *  イベント
 * ========================= */
function init(){
  renderRateNote();
  render();

  $("openRates").addEventListener("click", ()=>{
    const p = $("ratePanel");
    const show = (p.style.display==="none");
    p.style.display = show ? "block" : "none";
    $("openRates").textContent = show ? "提供割合を閉じる" : "提供割合を見る";
    SFX.click();
  });

  $("resetBtn").addEventListener("click", resetAll);

  $("toastBtn").addEventListener("click", openBonusFlow);
  $("toast").addEventListener("click", openBonusFlow);

  $("oneBtn").addEventListener("click", ()=>{ SFX.click(); doOne(); });
  $("tenBtn").addEventListener("click", ()=>{ SFX.click(); doTen(); });

  $("closeX").addEventListener("click", ()=>{ current=null; closeOverlay(); });
  $("overlay").addEventListener("click", (e)=>{ if (e.target === $("overlay")) { current=null; closeOverlay(); } });

  // iOSで音が鳴らない対策：最初のタップでAudioContext起動
  document.addEventListener("pointerdown", ()=>{
    if (!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    }
  }, {once:true});
}
init();
</script>
</body>
</html>
