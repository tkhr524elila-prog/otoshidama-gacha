<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ff7a00">
  <title>お年玉ガチャ（1連/10連）</title>
  <style>
    :root{
      --bg1:#070b18; --bg2:#140a2b;
      --text:#eef3ff; --muted:#a9b4da;
      --accent:#ff7a00; --gold:#ffd54a;
      --cyan:#00e5ff; --vio:#7c4dff;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(124,77,255,.30), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(0,229,255,.22), transparent 55%),
        radial-gradient(900px 600px at 60% 110%, rgba(255,122,0,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: clamp(12px, 3.5vw, 22px);
      padding-bottom: calc(clamp(12px, 3.5vw, 22px) + env(safe-area-inset-bottom));
      min-height:100%;
    }
    .wrap{max-width:760px;margin:0 auto;display:flex;flex-direction:column;gap:14px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .title{font-weight:1100;letter-spacing:.03em}
    .sub{font-size:12px;color:var(--muted);line-height:1.25}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--text);font-weight:1000;
    }

    .gem{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      min-width:210px;justify-content:space-between;
    }
    .gemL{display:flex;align-items:center;gap:10px}
    .gemIcon{
      width:18px;height:18px;border-radius:6px;
      background: conic-gradient(from 160deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      box-shadow: 0 0 18px rgba(0,229,255,.34);
      transform: rotate(12deg);
    }
    .gemCount{font-weight:1100}
    .gemSmall{font-size:11px;color:var(--muted)}

    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.16));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cardIn{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input, textarea{
      width:100%;
      color:var(--text);
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:84px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:6px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:0;cursor:pointer;
      border-radius:16px;
      padding:14px 16px;
      font-weight:1100;
      letter-spacing:.02em;
      color:#091021;
      background: linear-gradient(180deg, #ffd54a, #ff7a00);
      box-shadow: 0 16px 32px rgba(255,122,0,.30);
      display:flex;align-items:center;gap:10px;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;-webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: scale(.985)}
    .btn[disabled]{opacity:.45;cursor:not-allowed;filter:saturate(.75)}
    .btn2{
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      background: rgba(0,0,0,.16);
      box-shadow:none;
    }
    .costBadge{
      margin-left:auto;
      display:flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--text);
    }
    .miniGem{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,var(--cyan),var(--vio));}

    .resultPanel{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .money{font-size:44px;font-weight:1200;letter-spacing:.02em;line-height:1.05}
    .rarity{
      display:inline-flex;align-items:center;gap:8px;
      margin-top:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;font-weight:1100;
      text-transform:uppercase;
    }
    .rarDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25)}
    .smallnote{font-size:11px;color:var(--muted);margin-top:10px}

    /* Toast */
    .toastWrap{
      position:fixed;left:0;right:0;top:10px;
      display:flex;justify-content:center;
      pointer-events:none;z-index:80;
    }
    .toast{
      pointer-events:auto;
      width:min(680px, calc(100% - 24px));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      box-shadow: 0 22px 90px rgba(0,0,0,.55);
      padding:12px 12px;
      display:flex;align-items:center;gap:10px;
      transform: translateY(-16px);
      opacity:0;
      transition: transform .22s ease, opacity .22s ease;
    }
    .toast.show{transform: translateY(0); opacity:1}
    .toastIcon{
      width:38px;height:38px;border-radius:14px;
      background: conic-gradient(from 160deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      box-shadow: 0 0 18px rgba(0,229,255,.20);
      flex:0 0 auto;
    }
    .toastTxt{flex:1 1 auto;min-width:0}
    .toastTop{font-weight:1200;font-size:13px}
    .toastBot{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .toastBtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:1200;
      cursor:pointer;
    }

    /* Overlay / Modal (スマホ最適化：高さ制限＋スクロール) */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.78);
      display:none;align-items:center;justify-content:center;
      padding:14px;z-index:60;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(760px, 100%);
      max-height: calc(100dvh - 24px);
      overflow:hidden;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(700px 400px at 30% 10%, rgba(124,77,255,.38), transparent 60%),
        radial-gradient(700px 400px at 70% 90%, rgba(0,229,255,.28), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: 0 30px 110px rgba(0,0,0,.70);
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .modalIn{
      padding:16px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalTitle{font-weight:1200;font-size:16px}
    .modalSub{font-size:12px;color:var(--muted);margin-top:6px}

    /* Gacha stage */
    .stage{
      margin-top:12px;
      height: min(360px, 52dvh);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      position:relative;overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .beam{
      position:absolute;inset:-40%;
      background: conic-gradient(from 180deg, rgba(255,213,74,.0), rgba(255,213,74,.45), rgba(255,122,0,.0));
      animation: beam 1.05s linear infinite;
      mix-blend-mode: screen;
      opacity:0;
    }
    @keyframes beam{to{transform: rotate(360deg)}}
    .orb{
      width:128px;height:128px;border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.16) 30%, rgba(0,0,0,.0) 60%),
        conic-gradient(from 140deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      filter:saturate(1.25);
      box-shadow: 0 0 50px rgba(124,77,255,.30), 0 0 90px rgba(0,229,255,.18);
      animation: float 1.7s ease-in-out infinite;
    }
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-11px)}}
    .spinny .orb{animation: spin 0.95s linear infinite}
    .spinny .beam{opacity:.9}
    @keyframes spin{to{transform: rotate(360deg)}}

    .rainbow{
      position:absolute;inset:-60%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.55),
        rgba(255,214,0,.55),
        rgba(0,229,255,.55),
        rgba(124,77,255,.55),
        rgba(255,122,0,.55),
        rgba(255,0,92,.55),
        rgba(255,0,92,.0)
      );
      opacity:0;
      filter: blur(10px) saturate(1.25);
      animation: spin 1.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .rainbow.show{opacity:.95}
    .flash{
      position:absolute;inset:0;background: rgba(255,255,255,1);
      opacity:0;pointer-events:none;
    }
    .flash.on{animation: flash 0.55s ease}
    @keyframes flash{0%{opacity:0}12%{opacity:.95}100%{opacity:0}}

    .chars{position:absolute;inset:0;pointer-events:none}
    .char{
      position:absolute;bottom:12px;
      width:164px;height:192px;border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
      opacity:0; transform: translateY(10px);
      transition: opacity .22s ease, transform .22s ease;
    }
    .char.show{opacity:1;transform: translateY(0)}
    .char.left{left:12px}
    .char.right{right:12px}
    .charFace{
      position:absolute;left:14px;top:14px;
      width:54px;height:54px;border-radius:16px;
      background: linear-gradient(135deg, rgba(255,255,255,.20), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.10);
    }
    .charFace::before,.charFace::after{
      content:"";position:absolute;top:20px;width:8px;height:10px;border-radius:6px;background:rgba(255,255,255,.75);
    }
    .charFace::before{left:15px}
    .charFace::after{right:15px}
    .charName{position:absolute;left:78px;top:16px;font-weight:1200;font-size:12px}
    .charRole{position:absolute;left:78px;top:36px;font-weight:1000;font-size:11px;color:var(--muted)}
    .bubble{
      position:absolute;left:12px;right:12px;top:78px;
      padding:10px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size:12px;line-height:1.35;
    }
    .bubble small{color:var(--muted)}

    .tapHint{
      position:absolute;left:50%;top:12px;transform:translateX(-50%);
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      font-size:12px;font-weight:1100;
      color: var(--text);
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .tapHint.show{opacity:1}

    .reveal{
      position:absolute;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:6px;text-align:center;padding:16px;
      opacity:0;transform: scale(.98);
      transition: opacity .22s ease, transform .22s ease;
    }
    .reveal.show{opacity:1;transform:scale(1)}
    .revealMoney{font-size:54px;font-weight:1300}
    .revealRarity{font-size:14px;font-weight:1200;letter-spacing:.08em}
    .rollSummary{margin-top:8px;font-size:12px;color:var(--muted);max-width:620px}
    .pills{
      display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:10px;
      max-height: 92px;
      overflow:auto;
      padding:2px 4px;
    }
    .pill{
      font-size:11px;font-weight:1100;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color: var(--text);
    }
    .pill.ssr{border-color: rgba(255,213,74,.45);box-shadow: 0 0 24px rgba(255,213,74,.18)}
    .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden}

    .footerRow{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
    .okbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1200;
      cursor:pointer;
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .wrap{gap:12px}
      .topbar{flex-direction:column;align-items:flex-start}
      .gem{min-width:unset;width:100%;justify-content:flex-start}
      .money{font-size:40px}
      .char{width:132px;height:156px}
      .bubble{top:64px;font-size:11px}
      .charName{left:70px;font-size:11px}
      .charRole{left:70px;top:33px;font-size:10px}
      .revealMoney{font-size:48px}
    }
  </style>
</head>

<body>
  <div class="toastWrap">
    <div class="toast" id="toast">
      <div class="toastIcon"></div>
      <div class="toastTxt">
        <div class="toastTop">ログインボーナス</div>
        <div class="toastBot">3000ジェムが届いています。タップで受け取る</div>
      </div>
      <button class="toastBtn" id="toastBtn">受け取る</button>
    </div>
  </div>

  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">お年玉ガチャ（1連 / 10連）</div>
        <div class="sub">
          <span class="badge">1連：300ジェム</span>
          <span class="badge">10連：3000ジェム</span>
          <span class="badge">SSRで最大30,000円</span>
        </div>
      </div>
      <div class="gem">
        <div class="gemL">
          <div class="gemIcon"></div>
          <div>
            <div class="gemCount"><span id="gems">--</span> <span class="gemSmall">GEMS</span></div>
            <div class="gemSmall">所持ジェム</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardIn">
        <div class="actions" style="margin-top:0">
          <button class="btn btn2" id="resetBtn">初期化（親PIN）</button>
        </div>

        <label style="margin-top:10px;">候補金額（カンマ区切り）</label>
        <input id="candidates" />
        <div class="hint">SSRは 3,000円（虹演出）。SSRが含まれる10連は途中で“虹予兆”が出ます。</div>

        <label style="margin-top:10px;">確率（任意：金額:重み）</label>
        <textarea id="weights"></textarea>
        <div class="hint">重みが大きいほど出やすい。空なら均等。</div>

        <div class="actions">
          <button class="btn" id="oneBtn">
            1連を回す
            <span class="costBadge"><span class="miniGem"></span>-300</span>
          </button>
          <button class="btn" id="tenBtn">
            10連を回す
            <span class="costBadge"><span class="miniGem"></span>-3000</span>
          </button>
        </div>

        <div class="resultPanel">
          <div class="money" id="money">¥---</div>
          <div class="rarity" id="rarity"><span class="rarDot"></span><span id="rarText">READY</span></div>
          <div class="smallnote">※ ジェムが足りないと回せません</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="rainbow" id="rainbow"></div>
      <div class="flash" id="flash"></div>
      <div class="confetti" id="confetti"></div>
      <div class="modalIn">
        <div class="modalTitle" id="modalTitle">召喚中…</div>
        <div class="modalSub" id="modalSub">演出中</div>

        <div class="stage spinny" id="stage">
          <div class="beam" aria-hidden="true"></div>
          <div class="orb" aria-hidden="true"></div>

          <div class="tapHint" id="tapHint">タップで開封（1/10）</div>

          <div class="chars">
            <div class="char left" id="charL">
              <div class="charFace"></div>
              <div class="charName">召喚士 ハヤブサ</div>
              <div class="charRole">煽り担当</div>
              <div class="bubble" id="lineL">いくぞ…</div>
            </div>
            <div class="char right" id="charR">
              <div class="charFace"></div>
              <div class="charName">精霊 ミオ</div>
              <div class="charRole">運命担当</div>
              <div class="bubble" id="lineR">虹、見たい？</div>
            </div>
          </div>

          <div class="reveal" id="reveal">
            <div class="revealRarity" id="revealRarity">R</div>
            <div class="revealMoney" id="revealMoney">¥---</div>
            <div class="rollSummary" id="rollSummary">—</div>
            <div class="pills" id="pills"></div>
            <div class="modalSub">スクショ推奨</div>
          </div>
        </div>

        <div class="footerRow">
          <button class="okbtn" id="closeBtn" disabled>OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CFG = {
      BONUS_GEMS: 3000,
      COST_1: 300,
      COST_10: 3000,
      MAX_TENROLL_PAYOUT: 30000,
      SSR_AMOUNT: 3000,
      PARENT_PIN: "2525",
      CANDIDATES: "500,1000,2000,3000",
      WEIGHTS: `500:55
1000:30
2000:12
3000:3`
    };

    const LS = {
      gems: "otg5_gems_v1",
      bonusTaken: "otg5_bonus_taken_v1"
    };

    const $ = (id) => document.getElementById(id);
    const yen = (n) => "¥" + Number(n).toLocaleString("ja-JP");

    function getGems(){
      const v = localStorage.getItem(LS.gems);
      if (!v) return 0;
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function setGems(n){
      localStorage.setItem(LS.gems, String(n));
      render();
    }

    function parseCandidates() {
      const raw = $("candidates").value.trim();
      const arr = raw.split(",").map(s => s.trim()).filter(Boolean).map(Number).filter(n => Number.isFinite(n) && n >= 0);
      return arr.length ? arr : [500,1000,2000,3000];
    }
    function parseWeights() {
      const text = $("weights").value.trim();
      if (!text) return null;
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const map = new Map();
      for (const line of lines) {
        const [a,b] = line.split(":").map(s => s.trim());
        const amount = Number(a);
        const w = Number(b);
        if (Number.isFinite(amount) && Number.isFinite(w) && w > 0) map.set(amount, w);
      }
      return map.size ? map : null;
    }
    function weightedPick(cands, weightMap) {
      if (!weightMap) return cands[Math.floor(Math.random() * cands.length)];
      const items = cands.map(a => ({ a, w: weightMap.get(a) ?? 1 })).filter(x => x.w > 0);
      const total = items.reduce((s,x) => s + x.w, 0);
      let r = Math.random() * total;
      for (const it of items) {
        r -= it.w;
        if (r <= 0) return it.a;
      }
      return items[items.length - 1].a;
    }

    function setDot(r){
      const dot = $("rarity").querySelector(".rarDot");
      dot.style.background =
        r==="SSR" ? "rgba(255,213,74,.95)" :
        r==="SR" ? "rgba(255,122,0,.95)" :
        r==="R" ? "rgba(0,229,255,.95)" :
        r==="N" ? "rgba(168,179,214,.65)" :
        "rgba(255,255,255,.25)";
    }
    function rarityFromPayout(p){
      if (p >= 30000) return "SSR";
      if (p >= 20000) return "SR";
      if (p >= 10000) return "R";
      return "N";
    }

    // WebAudio
    let audioCtx;
    function beep(seq){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const t0 = audioCtx.currentTime + 0.01;
        seq.forEach((s)=>{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = s.type || "sine";
          o.frequency.value = s.f;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(audioCtx.destination);
          o.start(t0 + s.at);
          g.gain.setValueAtTime(0.0001, t0 + s.at);
          g.gain.exponentialRampToValueAtTime(s.v || 0.12, t0 + s.at + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + s.at + s.d);
          o.stop(t0 + s.at + s.d + 0.03);
        });
      }catch(e){}
    }
    function vibe(ms){ if (navigator.vibrate) navigator.vibrate(ms); }
    function sfxBonus(){ beep([{at:0,f:523.25,d:0.12,v:0.10,type:"square"},{at:0.12,f:659.25,d:0.12,v:0.11,type:"square"}]); }
    function sfxStart(){ beep([{at:0,f:196,d:0.10,v:0.10,type:"square"},{at:0.10,f:247,d:0.10,v:0.10,type:"square"}]); }
    function sfxTap(){ beep([{at:0,f:220,d:0.06,v:0.07,type:"sine"}]); }
    function sfxDrum(){ beep([{at:0,f:110,d:0.07,v:0.08,type:"sine"},{at:0.08,f:98,d:0.08,v:0.08,type:"sine"}]); }
    function sfxSSR(){
      beep([
        {at:0.00,f:523.25,d:0.14,v:0.14,type:"sawtooth"},
        {at:0.14,f:659.25,d:0.14,v:0.14,type:"sawtooth"},
        {at:0.28,f:783.99,d:0.22,v:0.16,type:"sawtooth"},
        {at:0.52,f:1046.5,d:0.25,v:0.18,type:"sine"}
      ]);
    }
    function sfxNormal(r){
      if (r==="SR") beep([{at:0,f:392,d:0.14,v:0.12},{at:0.14,f:523.25,d:0.20,v:0.13}]);
      else if (r==="R") beep([{at:0,f:330,d:0.14,v:0.10},{at:0.14,f:440,d:0.18,v:0.11}]);
      else beep([{at:0,f:262,d:0.12,v:0.08}]);
    }
    function flash(){
      const f = $("flash");
      f.classList.remove("on"); void f.offsetWidth; f.classList.add("on");
    }
    function confettiBurst(kind){
      const wrap = $("confetti");
      wrap.innerHTML = "";
      const count = kind==="SSR" ? 70 : (kind==="SR" ? 36 : (kind==="R" ? 22 : 12));
      for(let i=0;i<count;i++){
        const el = document.createElement("div");
        el.style.position="absolute";
        el.style.top="-24px";
        el.style.left = (Math.random()*100) + "%";
        const w = 6 + Math.random()*10;
        const h = 10 + Math.random()*18;
        el.style.width = w+"px";
        el.style.height = h+"px";
        el.style.borderRadius = "4px";
        const col =
          kind==="SSR" ? ["rgba(255,0,92,.95)","rgba(255,214,0,.95)","rgba(0,229,255,.95)","rgba(124,77,255,.95)","rgba(255,122,0,.95)"][Math.floor(Math.random()*5)]
          : kind==="SR" ? (Math.random()<.5 ? "rgba(255,213,74,.95)" : "rgba(255,122,0,.95)")
          : kind==="R" ? (Math.random()<.5 ? "rgba(0,229,255,.95)" : "rgba(255,255,255,.85)")
          : (Math.random()<.5 ? "rgba(255,255,255,.75)" : "rgba(168,179,214,.75)");
        el.style.background = col;

        const dur = 800 + Math.random()*900;
        const rot = Math.random()*360;
        const drift = (Math.random()*140 - 70);
        el.animate(
          [
            { transform:`translate(0px,-10px) rotate(${rot}deg)`, opacity:1 },
            { transform:`translate(${drift}px,360px) rotate(${rot+700}deg)`, opacity:0.95 }
          ],
          { duration: dur, delay: Math.random()*180, easing: "linear", fill:"forwards" }
        );
        wrap.appendChild(el);
      }
    }

    const LINES_L = {
      start: ["いくぞ…", "覚悟はいいか？", "最大値を掴め。"],
      mid: ["…来い、SSR（3,000円）", "1つずつ開けるぞ。", "運命を見せてみろ。"],
      hint: ["……気配が違う。", "虹の匂いがする。", "今のは…前兆だ。"],
      end: ["よし、受け取れ。", "スクショしろ。", "次はジェムがある時だけだ。"]
    };
    const LINES_R = {
      start: ["順番にいくよ。", "ドキドキするね。", "虹、見たい？"],
      mid: ["まだまだ、いける。", "次、開けるよ。", "集中して。"],
      hint: ["見えた？…虹の予兆。", "SSRが近いかも。", "運命、動いた。"],
      end: ["おめでとう。", "これが今回の結果。", "保存してね。"]
    };
    function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function showToastIfNeeded(){
      const taken = localStorage.getItem(LS.bonusTaken) === "1";
      if (!taken){
        setTimeout(()=>$("toast").classList.add("show"), 350);
      }else{
        $("toast").classList.remove("show");
      }
    }
    function hideToast(){ $("toast").classList.remove("show"); }
    function applyBonus(){
      const taken = localStorage.getItem(LS.bonusTaken) === "1";
      if (taken) return;
      localStorage.setItem(LS.bonusTaken, "1");
      setGems(getGems() + CFG.BONUS_GEMS);
      sfxBonus(); vibe(40);
      confettiBurst("SSR");
      hideToast();
    }

    function showOverlay(){ $("overlay").classList.add("show"); }
    function hideOverlay(){ $("overlay").classList.remove("show"); }

    function renderResult(amount, rar){
      $("money").textContent = yen(amount);
      $("rarText").textContent = rar;
      setDot(rar);
    }
    function render(){
      const g = getGems();
      $("gems").textContent = g;
      $("oneBtn").disabled = g < CFG.COST_1;
      $("tenBtn").disabled = g < CFG.COST_10;
    }

    // ====== Tap-to-open state ======
    let openState = null;

    function setTapHint(text, show){
      $("tapHint").textContent = text;
      $("tapHint").classList.toggle("show", !!show);
    }

    async function startCinematic(pulls, mode){
      showOverlay();
      $("closeBtn").disabled = true;
      $("reveal").classList.remove("show");
      $("stage").classList.add("spinny");
      $("confetti").innerHTML = "";
      $("rainbow").classList.remove("show");
      $("pills").innerHTML = "";

      $("charL").classList.add("show");
      $("charR").classList.add("show");

      $("modalTitle").textContent = mode==="10" ? "10連：開封準備…" : "1連：召喚準備…";
      $("modalSub").textContent = mode==="10" ? "タップで1個ずつ開封" : "タップで結果表示";

      $("lineL").textContent = randPick(LINES_L.start);
      $("lineR").textContent = randPick(LINES_R.start);

      sfxStart(); vibe(25);

      // ちょい溜め演出
      for(let i=0;i<6;i++){
        await new Promise(r=>setTimeout(r, 120));
        sfxDrum();
        if(i%2===0) vibe(10);
      }

      // 開封フェーズへ
      $("stage").classList.remove("spinny");
      openState = {
        mode,
        pulls,
        idx: 0,
        hasSSR: pulls.includes(CFG.SSR_AMOUNT),
        rainbowShown: false,
        finished: false
      };

      setTapHint(mode==="10" ? "タップで開封（1/10）" : "タップで開封（1/1）", true);
      $("modalTitle").textContent = mode==="10" ? "10連：開封中…" : "1連：開封中…";
      $("modalSub").textContent = "ステージをタップして進める";

      // 途中煽りを先に一回
      $("lineL").textContent = randPick(LINES_L.mid);
      $("lineR").textContent = randPick(LINES_R.mid);
    }

    function rainbowPremonition(){
      // “予兆”は強すぎない範囲で（虹＋軽フラッシュ）
      $("rainbow").classList.add("show");
      flash();
      sfxNormal("R");
      vibe(35);
      confettiBurst("R");
      setTimeout(()=>{ $("rainbow").classList.remove("show"); }, 850);
      $("lineL").textContent = randPick(LINES_L.hint);
      $("lineR").textContent = randPick(LINES_R.hint);
    }

    function finishReveal(){
      const mode = openState.mode;
      const pulls = openState.pulls;

      let resultAmount;
      if (mode==="1"){
        resultAmount = pulls[0];
      }else{
        const max = Math.max(...pulls);
        resultAmount = Math.min(max * 10, CFG.MAX_TENROLL_PAYOUT);
      }

      const rar = (mode==="10")
        ? rarityFromPayout(resultAmount)
        : (pulls[0] >= 3000 ? "SSR" : (pulls[0] >= 2000 ? "SR" : (pulls[0] >= 1000 ? "R" : "N")));

      // 本演出
      if (rar==="SSR"){
        $("rainbow").classList.add("show");
        flash(); setTimeout(flash, 180); setTimeout(flash, 360);
        sfxSSR(); vibe(140);
      }else{
        sfxNormal(rar);
        vibe(rar==="SR" ? 80 : (rar==="R" ? 45 : 25));
      }
      confettiBurst(rar);

      $("revealMoney").textContent = yen(resultAmount);
      $("revealRarity").textContent = `${rar}（結果）`;

      $("rollSummary").textContent = (mode==="10")
        ? `10回の結果：${pulls.map(yen).join(" / ")}（最大値×10で確定）`
        : `結果：${yen(pulls[0])}`;

      $("lineL").textContent = randPick(LINES_L.end);
      $("lineR").textContent = randPick(LINES_R.end);

      $("reveal").classList.add("show");
      $("closeBtn").disabled = false;
      setTapHint("", false);

      renderResult(resultAmount, rar);
      render();
      openState.finished = true;
    }

    function onStageTap(){
      if (!openState || openState.finished) return;

      sfxTap();
      vibe(10);

      const { mode, pulls } = openState;

      // 途中でSSRが含まれてる時だけ、5回目あたりで“虹予兆”
      if (mode==="10" && openState.hasSSR && !openState.rainbowShown && openState.idx === 4){
        openState.rainbowShown = true;
        rainbowPremonition();
      }

      // 1つ開封
      const v = pulls[openState.idx];
      const pill = document.createElement("div");
      pill.className = "pill" + (v===CFG.SSR_AMOUNT ? " ssr" : "");
      pill.textContent = yen(v);
      $("pills").appendChild(pill);

      openState.idx++;

      if (mode==="10"){
        setTapHint(`タップで開封（${openState.idx+1}/10）`, true);
        $("modalSub").textContent = `開封：${openState.idx} / 10（タップで次へ）`;
      }else{
        setTapHint(`タップで確定`, true);
        $("modalSub").textContent = `開封：1 / 1`;
      }

      // 全部開け終わったら結果確定
      if ((mode==="10" && openState.idx >= 10) || (mode==="1" && openState.idx >= 1)){
        finishReveal();
      }
    }

    function doOne(){
      const g = getGems();
      if (g < CFG.COST_1){
        alert("ジェムが足りません（1連は300ジェム必要）");
        return;
      }
      setGems(g - CFG.COST_1);

      const cands = parseCandidates();
      const weightMap = parseWeights();
      const v = weightedPick(cands, weightMap);

      startCinematic([v], "1");
    }

    function doTen(){
      const g = getGems();
      if (g < CFG.COST_10){
        alert("ジェムが足りません（10連は3000ジェム必要）");
        return;
      }
      setGems(g - CFG.COST_10);

      const cands = parseCandidates();
      const weightMap = parseWeights();
      const pulls = Array.from({length:10}, ()=>weightedPick(cands, weightMap));

      startCinematic(pulls, "10");
    }

    function resetAll(){
      const pin = prompt("親PINを入力してください");
      if (pin === null) return;
      if (pin !== CFG.PARENT_PIN){
        alert("PINが違います");
        return;
      }
      localStorage.removeItem(LS.gems);
      localStorage.removeItem(LS.bonusTaken);
      renderResult(0, "READY");
      render();
      showToastIfNeeded();
      alert("初期化しました（ログインボーナスが再表示されます）");
    }

    function init(){
      $("candidates").value = CFG.CANDIDATES;
      $("weights").value = CFG.WEIGHTS;

      $("oneBtn").addEventListener("click", doOne);
      $("tenBtn").addEventListener("click", doTen);
      $("resetBtn").addEventListener("click", resetAll);

      $("toast").addEventListener("click", applyBonus);
      $("toastBtn").addEventListener("click", (e)=>{ e.stopPropagation(); applyBonus(); });

      $("closeBtn").addEventListener("click", ()=>{ openState=null; hideOverlay(); });
      $("overlay").addEventListener("click", (e)=>{ if (e.target === $("overlay")) { openState=null; hideOverlay(); }});

      $("stage").addEventListener("click", onStageTap);

      render();
      showToastIfNeeded();
    }
    init();
  </script>
</body>
</html>
