<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ff7a00" />
  <title>お年玉ガチャ</title>

  <style>
    :root{
      --bg1:#070b18; --bg2:#140a2b;
      --text:#eef3ff; --muted:#a9b4da;
      --accent:#ff7a00; --gold:#ffd54a;
      --cyan:#00e5ff; --vio:#7c4dff;
      --line: rgba(255,255,255,.12);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 20px;

      --n:#a8b3d6; --r:#00e5ff; --sr:#ff7a00; --ssr:#ffd54a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(124,77,255,.30), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(0,229,255,.22), transparent 55%),
        radial-gradient(900px 600px at 60% 110%, rgba(255,122,0,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: 14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      overflow-x:hidden;
    }

    .app{
      max-width: 760px;
      margin: 0 auto;
      min-height: calc(100dvh - 14px - env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:12px;
      position:relative;
    }

    /* HUD */
    .hud{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.16));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      width: fit-content;
    }
    .gemIcon{
      width:18px;height:18px;border-radius:6px;
      background: conic-gradient(from 160deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      box-shadow: 0 0 18px rgba(0,229,255,.28);
      transform: rotate(10deg);
    }
    .gemText{line-height:1.1}
    .gemCount{font-weight:1100; letter-spacing:.02em}
    .gemSub{font-size:11px;color:var(--muted);margin-top:2px}

    /* Info card */
    .infoCard{
      flex: 1 1 auto;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
      padding: 14px;
    }
    .title{font-weight:1200; letter-spacing:.03em; font-size:16px}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-size:12px;font-weight:1100;
    }
    .badge.ssr{
      border-color: rgba(255,213,74,.45);
      box-shadow: 0 0 24px rgba(255,213,74,.14);
    }
    .infoBody{
      margin-top:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      padding:12px;
    }
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px}
    input, textarea{
      width:100%;
      color:var(--text);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{min-height:84px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:8px}
    .ghostBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color: var(--text);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
      margin-top:10px;
    }

    /* Bottom buttons */
    .bottomBar{
      position:sticky;
      bottom: calc(10px + env(safe-area-inset-bottom));
      display:flex;
      gap:12px;
      align-items:stretch;
    }
    .gachaBtn{
      flex: 1 1 0;
      border:0;
      border-radius: 20px;
      padding:14px 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      transition: transform .08s ease, opacity .12s ease;
    }
    .gachaBtn:active{transform: scale(.99)}
    .gachaBtn[disabled]{opacity:.45; cursor:not-allowed}
    .gachaL{
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(0,0,0,.18));
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
    }
    .gachaR{
      background: linear-gradient(180deg, #ffd54a, #ff7a00);
      color: #08101f;
      font-weight:1200;
    }
    .btnTitle{font-weight:1200}
    .btnSub{font-size:11px; opacity:.9; margin-top:2px}
    .costPill{
      display:flex; align-items:center; gap:6px;
      padding:8px 10px;border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;
      color: var(--text);
      font-weight:1100;
    }
    .gachaR .costPill{
      background: rgba(255,255,255,.25);
      border-color: rgba(0,0,0,.10);
      color:#08101f;
    }
    .miniGem{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,var(--cyan),var(--vio));}

    /* Toast */
    .toastWrap{
      position:fixed; left:0; right:0; top:10px;
      display:flex; justify-content:center;
      pointer-events:none; z-index:90;
    }
    .toast{
      pointer-events:auto;
      width:min(680px, calc(100% - 24px));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      box-shadow: 0 22px 90px rgba(0,0,0,.55);
      padding:12px;
      display:flex; align-items:center; gap:10px;
      transform: translateY(-16px);
      opacity:0;
      transition: transform .22s ease, opacity .22s ease;
    }
    .toast.show{transform: translateY(0); opacity:1}
    .toastIcon{
      width:38px;height:38px;border-radius:14px;
      background: conic-gradient(from 160deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      box-shadow: 0 0 18px rgba(0,229,255,.20);
      flex:0 0 auto;
    }
    .toastTxt{flex:1 1 auto;min-width:0}
    .toastTop{font-weight:1200;font-size:13px}
    .toastBot{font-size:12px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .toastBtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:1200;
      cursor:pointer;
    }

    /* Overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 12px;
      z-index:80;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(760px,100%);
      max-height: calc(100dvh - 24px);
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(700px 400px at 30% 10%, rgba(124,77,255,.38), transparent 60%),
        radial-gradient(700px 400px at 70% 90%, rgba(0,229,255,.28), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: 0 30px 110px rgba(0,0,0,.70);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .rainbow{
      position:absolute;inset:-60%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.55),
        rgba(255,214,0,.55),
        rgba(0,229,255,.55),
        rgba(124,77,255,.55),
        rgba(255,122,0,.55),
        rgba(255,0,92,.55),
        rgba(255,0,92,.0)
      );
      opacity:0;
      filter: blur(10px) saturate(1.25);
      animation: spin 1.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .rainbow.show{opacity:.95}
    @keyframes spin{to{transform: rotate(360deg)}}
    .flash{
      position:absolute; inset:0;
      background: rgba(255,255,255,1);
      opacity:0; pointer-events:none;
    }
    .flash.on{animation: flash .55s ease}
    @keyframes flash{0%{opacity:0}12%{opacity:.95}100%{opacity:0}}

    .modalIn{
      padding: 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      position:relative;
      z-index:2;
    }
    .mTitle{font-weight:1200;font-size:15px}
    .mSub{font-size:12px;color:var(--muted);margin-top:4px}

    .stage{
      margin-top:12px;
      height: min(420px, 58dvh);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .beam{
      position:absolute;inset:-40%;
      background: conic-gradient(from 180deg, rgba(255,213,74,.0), rgba(255,213,74,.45), rgba(255,122,0,.0));
      animation: beam 1.05s linear infinite;
      mix-blend-mode: screen;
      opacity:0;
    }
    @keyframes beam{to{transform: rotate(360deg)}}
    .orb{
      width:128px;height:128px;border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.16) 30%, rgba(0,0,0,.0) 60%),
        conic-gradient(from 140deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      filter:saturate(1.25);
      box-shadow: 0 0 50px rgba(124,77,255,.30), 0 0 90px rgba(0,229,255,.18);
      animation: float 1.7s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-11px)}}
    .spinny .orb{animation: spin 0.95s linear infinite}
    .spinny .beam{opacity:.9}

    .tapHint{
      position:absolute;left:50%;top:12px;transform:translateX(-50%);
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      font-size:12px;font-weight:1100;
      opacity:0;
      transition: opacity .18s ease;
      pointer-events:none;
      white-space:nowrap;
    }
    .tapHint.show{opacity:1}

    /* SSR確定スタンプ */
    .stamp{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%) rotate(-10deg) scale(.9);
      padding:14px 16px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 2px solid rgba(255,213,74,.75);
      box-shadow: 0 0 35px rgba(255,213,74,.22);
      font-weight:1300;
      letter-spacing:.12em;
      text-transform:uppercase;
      opacity:0;
      pointer-events:none;
    }
    .stamp.show{animation: stamp .85s ease forwards}
    @keyframes stamp{
      0%{opacity:0; transform: translate(-50%,-50%) rotate(-12deg) scale(.6)}
      22%{opacity:1; transform: translate(-50%,-50%) rotate(-12deg) scale(1.06)}
      55%{opacity:1; transform: translate(-50%,-50%) rotate(-12deg) scale(1.0)}
      100%{opacity:0; transform: translate(-50%,-60%) rotate(-12deg) scale(.96)}
    }

    /* Card reveal */
    .cardWrap{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      gap:10px;
      padding:16px;
      opacity:0;
      transform: scale(.98);
      transition: opacity .18s ease, transform .18s ease;
    }
    .cardWrap.show{opacity:1; transform: scale(1)}
    .card{
      width: min(320px, 86%);
      aspect-ratio: 3 / 4;
      border-radius: 22px;
      background: rgba(0,0,0,.18);
      border: 2px solid rgba(255,255,255,.14);
      box-shadow: 0 24px 80px rgba(0,0,0,.45);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.18), transparent 50%);
      transform: rotate(10deg);
      opacity:.8;
    }
    .cardGlow{
      position:absolute; inset:-60%;
      opacity:0;
      filter: blur(10px) saturate(1.2);
      mix-blend-mode: screen;
      animation: spin 1.2s linear infinite;
    }
    .cardFrame{
      position:absolute; inset:10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
    }
    .rarText{
      position:absolute; top:14px; left:14px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:1300;
      letter-spacing:.12em;
      font-size:12px;
    }
    .money{
      position:absolute; left:0; right:0;
      top:50%; transform: translateY(-50%);
      text-align:center;
      font-weight:1400;
      font-size: 46px;
      text-shadow: 0 10px 30px rgba(0,0,0,.55);
      padding: 0 12px;
    }
    .tapNext{
      font-size:12px; color: var(--muted);
      text-align:center;
      margin-top:2px;
    }
    .pills{
      display:flex; flex-wrap:wrap;
      gap:6px; justify-content:center;
      max-height: 88px;
      overflow:auto;
      padding: 2px 4px;
      width: 100%;
    }
    .pill{
      font-size:11px;font-weight:1100;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color: var(--text);
    }
    .pill.ssr{border-color: rgba(255,213,74,.55); box-shadow: 0 0 20px rgba(255,213,74,.14)}

    /* rarity color states for card */
    .card.n{border-color: rgba(168,179,214,.35)}
    .card.r{border-color: rgba(0,229,255,.55); box-shadow: 0 0 40px rgba(0,229,255,.10), 0 24px 80px rgba(0,0,0,.45)}
    .card.sr{border-color: rgba(255,122,0,.65); box-shadow: 0 0 45px rgba(255,122,0,.12), 0 24px 80px rgba(0,0,0,.45)}
    .card.ssr{border-color: rgba(255,213,74,.80); box-shadow: 0 0 55px rgba(255,213,74,.18), 0 24px 80px rgba(0,0,0,.45)}
    .card.ssr .cardGlow{opacity:.85; background: conic-gradient(from 180deg,
      rgba(255,0,92,.0), rgba(255,0,92,.55),
      rgba(255,214,0,.55),
      rgba(0,229,255,.55),
      rgba(124,77,255,.55),
      rgba(255,122,0,.55),
      rgba(255,0,92,.55),
      rgba(255,0,92,.0)
    );}
    .card.sr .cardGlow{opacity:.65; background: conic-gradient(from 180deg, rgba(255,213,74,.0), rgba(255,213,74,.5), rgba(255,122,0,.0));}
    .card.r .cardGlow{opacity:.55; background: conic-gradient(from 180deg, rgba(0,229,255,.0), rgba(0,229,255,.55), rgba(124,77,255,.0));}
    .card.n .cardGlow{opacity:.22; background: conic-gradient(from 180deg, rgba(168,179,214,.0), rgba(168,179,214,.35), rgba(168,179,214,.0));}

    /* Total badge */
    .totalBadge{
      position:absolute;
      right:12px; top:12px;
      padding:8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      font-size:12px;
      font-weight:1200;
      display:flex;
      align-items:center;
      gap:8px;
      opacity:0;
      transform: translateY(-4px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
    }
    .totalBadge.show{opacity:1; transform: translateY(0)}
    .dot{width:8px;height:8px;border-radius:999px;background: rgba(255,255,255,.3)}
    .dot.ssr{background: rgba(255,213,74,.95)}
    .dot.sr{background: rgba(255,122,0,.95)}
    .dot.r{background: rgba(0,229,255,.95)}
    .dot.n{background: rgba(168,179,214,.65)}

    .footerRow{
      display:flex; gap:10px;
      justify-content:flex-end;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .okbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1200;
      cursor:pointer;
    }

    @media (max-width: 520px){
      .money{font-size:42px}
    }
  </style>
</head>

<body>
  <!-- Login bonus toast -->
  <div class="toastWrap">
    <div class="toast" id="toast">
      <div class="toastIcon"></div>
      <div class="toastTxt">
        <div class="toastTop">ログインボーナス</div>
        <div class="toastBot">3000ジェムが届いています。タップで受け取る</div>
      </div>
      <button class="toastBtn" id="toastBtn">受け取る</button>
    </div>
  </div>

  <div class="app">
    <div class="hud">
      <div class="gemIcon"></div>
      <div class="gemText">
        <div class="gemCount"><span id="gems">--</span> GEMS</div>
        <div class="gemSub">所持ジェム</div>
      </div>
    </div>

    <div class="infoCard">
      <div class="title">お年玉ガチャ</div>
      <div class="badges">
        <div class="badge">1回：300ジェム</div>
        <div class="badge ssr">SSR確定！10連：3000ジェム</div>
        <div class="badge">SSR=3,000円</div>
        <div class="badge">最大30,000円（10連合計）</div>
      </div>

      <div class="infoBody">
        <div class="hint">
          ・10連は <b>SSR(3,000円)が必ず1回</b> 入ります<br/>
          ・開封は <b>タップで1個ずつ</b> → 最後に「合計は……」の溜め
        </div>

        <label>候補金額（カンマ区切り）</label>
        <input id="candidates" />

        <label>確率（任意：金額:重み）</label>
        <textarea id="weights"></textarea>

        <button class="ghostBtn" id="resetBtn">初期化（親PIN）</button>
      </div>
    </div>

    <div class="bottomBar">
      <button class="gachaBtn gachaL" id="oneBtn">
        <div>
          <div class="btnTitle">1回ガチャ</div>
          <div class="btnSub">タップで開封</div>
        </div>
        <div class="costPill"><span class="miniGem"></span>-300</div>
      </button>

      <button class="gachaBtn gachaR" id="tenBtn">
        <div>
          <div class="btnTitle">SSR確定！10連</div>
          <div class="btnSub">カード演出</div>
        </div>
        <div class="costPill"><span class="miniGem"></span>-3000</div>
      </button>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="rainbow" id="rainbow"></div>
      <div class="flash" id="flash"></div>

      <div class="modalIn">
        <div class="mTitle" id="mTitle">召喚中…</div>
        <div class="mSub" id="mSub">ステージをタップして進める</div>

        <div class="stage spinny" id="stage">
          <div class="beam"></div>
          <div class="orb"></div>

          <div class="tapHint" id="tapHint">タップで開封</div>
          <div class="stamp" id="stamp">SSR確定！</div>

          <div class="totalBadge" id="totalBadge">
            <span class="dot" id="totalDot"></span>
            <span id="totalText">TOTAL</span>
          </div>

          <!-- Card UI -->
          <div class="cardWrap" id="cardWrap">
            <div class="card n" id="card">
              <div class="cardGlow" id="cardGlow"></div>
              <div class="cardFrame"></div>
              <div class="rarText" id="rarText">N</div>
              <div class="money" id="money">¥---</div>
            </div>

            <div class="tapNext" id="tapNext">タップで次へ</div>

            <div class="pills" id="pills"></div>
          </div>
        </div>

        <div class="footerRow">
          <button class="okbtn" id="closeBtn" disabled>OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CFG = {
      BONUS_GEMS: 3000,
      COST_1: 300,
      COST_10: 3000,
      SSR_AMOUNT: 3000,
      MAX_TOTAL: 30000,
      PARENT_PIN: "2525",
      CANDIDATES: "500,1000,2000,3000",
      WEIGHTS: `500:55
1000:30
2000:12
3000:3`,
      TAP_COOLDOWN_MS: 300
    };

    const LS = {
      gems: "otg7_gems_v1",
      bonusTaken: "otg7_bonus_taken_v1"
    };

    const $ = (id) => document.getElementById(id);
    const yen = (n) => "¥" + Number(n).toLocaleString("ja-JP");

    function getGems(){
      const v = localStorage.getItem(LS.gems);
      if (!v) return 0;
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function setGems(n){
      localStorage.setItem(LS.gems, String(n));
      render();
    }

    function parseCandidates() {
      const raw = $("candidates").value.trim();
      const arr = raw.split(",").map(s => s.trim()).filter(Boolean).map(Number).filter(n => Number.isFinite(n) && n >= 0);
      return arr.length ? arr : [500,1000,2000,3000];
    }
    function parseWeights() {
      const text = $("weights").value.trim();
      if (!text) return null;
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const map = new Map();
      for (const line of lines) {
        const [a,b] = line.split(":").map(s => s.trim());
        const amount = Number(a);
        const w = Number(b);
        if (Number.isFinite(amount) && Number.isFinite(w) && w > 0) map.set(amount, w);
      }
      return map.size ? map : null;
    }
    function weightedPick(cands, weightMap) {
      if (!weightMap) return cands[Math.floor(Math.random() * cands.length)];
      const items = cands.map(a => ({ a, w: weightMap.get(a) ?? 1 })).filter(x => x.w > 0);
      const total = items.reduce((s,x) => s + x.w, 0);
      let r = Math.random() * total;
      for (const it of items) {
        r -= it.w;
        if (r <= 0) return it.a;
      }
      return items[items.length - 1].a;
    }

    // rarity for each pull (card frame)
    function rarityOfValue(v){
      // このアプリ仕様では最大が3000なので、3000=SSR。それ以外は段階分け。
      if (v >= 3000) return "SSR";
      if (v >= 2000) return "SR";
      if (v >= 1000) return "R";
      return "N";
    }

    function totalRarity(total){
      if (total >= 30000) return "ssr";
      if (total >= 20000) return "sr";
      if (total >= 10000) return "r";
      return "n";
    }

    // WebAudio (simple)
    let audioCtx;
    function beep(seq){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const t0 = audioCtx.currentTime + 0.01;
        seq.forEach((s)=>{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = s.type || "sine";
          o.frequency.value = s.f;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(audioCtx.destination);
          o.start(t0 + s.at);
          g.gain.setValueAtTime(0.0001, t0 + s.at);
          g.gain.exponentialRampToValueAtTime(s.v || 0.12, t0 + s.at + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + s.at + s.d);
          o.stop(t0 + s.at + s.d + 0.03);
        });
      }catch(e){}
    }
    function vibe(ms){ if (navigator.vibrate) navigator.vibrate(ms); }

    const sfx = {
      start(){ beep([{at:0,f:196,d:0.10,v:0.10,type:"square"},{at:0.10,f:247,d:0.10,v:0.10,type:"square"}]); },
      tap(){ beep([{at:0,f:220,d:0.06,v:0.07,type:"sine"}]); },
      drum(){ beep([{at:0,f:110,d:0.07,v:0.08,type:"sine"},{at:0.08,f:98,d:0.08,v:0.08,type:"sine"}]); },
      ssr(){
        beep([
          {at:0.00,f:523.25,d:0.14,v:0.14,type:"sawtooth"},
          {at:0.14,f:659.25,d:0.14,v:0.14,type:"sawtooth"},
          {at:0.28,f:783.99,d:0.22,v:0.16,type:"sawtooth"},
          {at:0.52,f:1046.5,d:0.25,v:0.18,type:"sine"}
        ]);
      },
      reveal(){ beep([{at:0,f:392,d:0.14,v:0.12},{at:0.14,f:523.25,d:0.18,v:0.13}]); },
      bonus(){ beep([{at:0,f:523.25,d:0.12,v:0.10,type:"square"},{at:0.12,f:659.25,d:0.12,v:0.11,type:"square"}]); }
    };

    function flash(){
      const f = $("flash");
      f.classList.remove("on"); void f.offsetWidth; f.classList.add("on");
    }

    function showToastIfNeeded(){
      const taken = localStorage.getItem(LS.bonusTaken) === "1";
      if (!taken) setTimeout(()=>$("toast").classList.add("show"), 350);
      else $("toast").classList.remove("show");
    }
    function hideToast(){ $("toast").classList.remove("show"); }
    function applyBonus(){
      const taken = localStorage.getItem(LS.bonusTaken) === "1";
      if (taken) return;
      localStorage.setItem(LS.bonusTaken, "1");
      setGems(getGems() + CFG.BONUS_GEMS);
      sfx.bonus(); vibe(40);
      hideToast();
    }

    function render(){
      const g = getGems();
      $("gems").textContent = g;
      $("oneBtn").disabled = g < CFG.COST_1;
      $("tenBtn").disabled = g < CFG.COST_10;
    }

    function showOverlay(){
      $("overlay").classList.add("show");
    }
    function hideOverlay(){
      $("overlay").classList.remove("show");
    }

    function setTapHint(text, show){
      $("tapHint").textContent = text;
      $("tapHint").classList.toggle("show", !!show);
    }
    function showStamp(){
      const st = $("stamp");
      st.classList.remove("show");
      void st.offsetWidth;
      st.classList.add("show");
    }

    function setTotalBadge(text, rar){
      $("totalText").textContent = text;
      const dot = $("totalDot");
      dot.className = "dot " + rar;
      $("totalBadge").classList.add("show");
    }
    function hideTotalBadge(){ $("totalBadge").classList.remove("show"); }

    function setCard(value){
      const rar = rarityOfValue(value);
      const card = $("card");
      const rarText = $("rarText");
      card.className = "card " + rar.toLowerCase();
      rarText.textContent = rar;
      $("money").textContent = yen(value);

      // SSRなら虹強化
      if (rar === "SSR"){
        $("rainbow").classList.add("show");
        flash(); setTimeout(flash, 160);
        sfx.ssr(); vibe(120);
      }else{
        $("rainbow").classList.remove("show");
        sfx.reveal();
        vibe(rar === "SR" ? 60 : (rar === "R" ? 35 : 18));
      }
    }

    function addPill(value){
      const p = document.createElement("div");
      p.className = "pill" + (value === CFG.SSR_AMOUNT ? " ssr" : "");
      p.textContent = yen(value);
      $("pills").appendChild(p);
    }

    // ===== Tap flow =====
    let state = null;
    let tapLockedUntil = 0;

    function canTap(){
      const now = Date.now();
      if (now < tapLockedUntil) return false;
      tapLockedUntil = now + CFG.TAP_COOLDOWN_MS;
      return true;
    }

    async function startCinematic(pulls, mode){
      showOverlay();
      $("closeBtn").disabled = true;
      $("totalBadge").classList.remove("show");
      $("pills").innerHTML = "";
      $("cardWrap").classList.remove("show");
      $("rainbow").classList.remove("show");

      $("stage").classList.add("spinny");
      $("mTitle").textContent = mode === "10" ? "SSR確定！10連ガチャ" : "1回ガチャ";
      $("mSub").textContent = "ステージをタップして進める";
      setTapHint("召喚中…", true);

      // SSR確定スタンプ（10連だけ最初にドン）
      if (mode === "10"){
        showStamp();
        sfx.ssr(); vibe(60);
      }

      sfx.start(); vibe(25);
      for(let i=0;i<6;i++){
        await new Promise(r=>setTimeout(r, 110));
        sfx.drum();
        if (i%2===0) vibe(10);
      }
      $("stage").classList.remove("spinny");

      // 開封UIを表示
      $("cardWrap").classList.add("show");
      setTapHint(mode === "10" ? "タップで開封（1/10）" : "タップで開封（1/1）", true);
      $("tapNext").textContent = "タップで開封";

      state = {
        mode,
        pulls,
        idx: 0,
        opened: [],
        finished: false,
        readyTotal: false
      };
    }

    async function totalReveal(){
      $("tapNext").textContent = "合計へ…";
      $("mSub").textContent = "合計は・・・・・・";
      setTapHint("タップで合計表示", true);

      // ため演出（タップ不要で進む）
      flash(); vibe(35);
      for(let i=0;i<8;i++){
        await new Promise(r=>setTimeout(r, 140));
        sfx.drum();
        if (i%2===0) vibe(10);
      }

      const totalRaw = state.opened.reduce((s,x)=>s+x,0);
      const total = Math.min(totalRaw, CFG.MAX_TOTAL);
      const rar = totalRarity(total);

      if (rar === "ssr"){
        $("rainbow").classList.add("show");
        flash(); setTimeout(flash, 180); setTimeout(flash, 360);
        sfx.ssr(); vibe(140);
      }else{
        $("rainbow").classList.remove("show");
        sfx.reveal(); vibe(rar==="sr" ? 80 : (rar==="r" ? 45 : 25));
      }

      setTotalBadge("合計 " + yen(total), rar);
      $("mSub").textContent = "スクショ推奨：今回の合計";
      $("closeBtn").disabled = false;
      state.finished = true;
      setTapHint("", false);
      $("tapNext").textContent = "OKで戻る";
    }

    function onStageTap(){
      if (!state || state.finished) return;

      // 連打防止
      if (!canTap()) return;

      sfx.tap();
      vibe(10);

      if (state.readyTotal){
        // 合計表示へ
        state.readyTotal = false;
        totalReveal();
        return;
      }

      const v = state.pulls[state.idx];
      state.opened.push(v);
      addPill(v);
      setCard(v);

      state.idx++;

      if (state.mode === "10"){
        if (state.idx < 10){
          setTapHint(`タップで開封（${state.idx+1}/10）`, true);
          $("mSub").textContent = "次へ（タップ）";
        }else{
          // 全部開封完了 → 次のタップで合計へ
          $("mSub").textContent = "全て開封完了";
          $("tapNext").textContent = "タップで合計へ";
          setTapHint("タップで合計へ", true);
          state.readyTotal = true;
        }
      }else{
        // 1回はここで終了
        $("mSub").textContent = "OKで戻る";
        $("closeBtn").disabled = false;
        state.finished = true;
        setTapHint("", false);
        $("tapNext").textContent = "OKで戻る";
      }
    }

    function doOne(){
      const g = getGems();
      if (g < CFG.COST_1){
        alert("ジェムが足りません（1回は300ジェム必要）");
        return;
      }
      setGems(g - CFG.COST_1);

      const cands = parseCandidates();
      const w = parseWeights();
      const v = weightedPick(cands, w);

      startCinematic([v], "1");
    }

    function doTen(){
      const g = getGems();
      if (g < CFG.COST_10){
        alert("ジェムが足りません（10連は3000ジェム必要）");
        return;
      }
      setGems(g - CFG.COST_10);

      const cands = parseCandidates();
      const w = parseWeights();

      let pulls = Array.from({length:10}, ()=>weightedPick(cands, w));

      // SSR確定：どこか1枠を必ず3000にする
      if (!pulls.includes(CFG.SSR_AMOUNT)){
        pulls[Math.floor(Math.random()*10)] = CFG.SSR_AMOUNT;
      }

      startCinematic(pulls, "10");
    }

    function resetAll(){
      const pin = prompt("親PINを入力してください");
      if (pin === null) return;
      if (pin !== CFG.PARENT_PIN){
        alert("PINが違います");
        return;
      }
      localStorage.removeItem(LS.gems);
      localStorage.removeItem(LS.bonusTaken);
      alert("初期化しました（ログインボーナスが再表示されます）");
      render();
      showToastIfNeeded();
    }

    function init(){
      $("candidates").value = CFG.CANDIDATES;
      $("weights").value = CFG.WEIGHTS;

      $("oneBtn").addEventListener("click", doOne);
      $("tenBtn").addEventListener("click", doTen);
      $("resetBtn").addEventListener("click", resetAll);

      $("toast").addEventListener("click", applyBonus);
      $("toastBtn").addEventListener("click", (e)=>{ e.stopPropagation(); applyBonus(); });

      $("closeBtn").addEventListener("click", ()=>{ state=null; hideOverlay(); });

      $("stage").addEventListener("click", onStageTap);

      $("overlay").addEventListener("click", (e)=>{
        if (e.target === $("overlay")) { state=null; hideOverlay(); }
      });

      render();
      showToastIfNeeded();
    }
    init();
  </script>
</body>
</html>
