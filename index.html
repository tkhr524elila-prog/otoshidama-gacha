<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1022">
  <title>æœ€å¤§30000å†† ãŠå¹´ç‰ã‚¬ãƒãƒ£ï¼</title>
  <style>
    :root{
      --text:#eef3ff; --muted:#b9c3ea;
      --glass: rgba(10,12,24,.55);
      --glass2: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.12);
      --shadow: 0 22px 70px rgba(0,0,0,.55);
      --radius: 18px;

      --n:#9aa6c6;
      --r:#2dd4ff;
      --sr:#ff8a00;
      --ssr:#ffd54a;

      --btn1: linear-gradient(180deg,#3b82f6,#2563eb);
      --btn2: linear-gradient(180deg,#ffd54a,#ff7a00);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        linear-gradient(180deg, rgba(0,0,0,.48), rgba(0,0,0,.78)),
        url('bg.jpg') center/cover no-repeat fixed;
      padding: 14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
    }
    .wrap{max-width:820px;margin:0 auto;min-height:100%;display:flex;flex-direction:column;gap:14px}

    /* Top HUD */
    .hud{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .gems{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .gemIcon{
      width:22px;height:22px;border-radius:8px;
      background: url('gem.png') center/cover no-repeat;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.45));
    }
    .gems b{font-weight:1000}
    .gems small{display:block;color:var(--muted);font-size:11px;margin-top:2px;line-height:1}

    /* Center popup card */
    .popup{
      margin-top:4px;
      border-radius: 24px;
      border:1px solid var(--line);
      background:
        radial-gradient(900px 420px at 20% 10%, rgba(255,213,74,.18), transparent 55%),
        radial-gradient(900px 420px at 85% 20%, rgba(45,212,255,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.28));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }
    .popupIn{padding:18px 16px 16px}
    .title{
      font-size:18px;
      font-weight:1100;
      letter-spacing:.02em;
      line-height:1.25;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .maxBadge{
      display:inline-flex;align-items:center;gap:8px;
      margin-top:10px;
      padding:8px 12px;border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      font-weight:1000;
      font-size:12px;
    }
    .maxBadge .dot{
      width:10px;height:10px;border-radius:999px;background: var(--ssr);
      box-shadow: 0 0 18px rgba(255,213,74,.35);
    }

    /* rates table */
    .rates{
      margin-top:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .ratesHead{
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .ratesHead b{font-weight:1100}
    .ratesHead span{font-size:11px;color:var(--muted)}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{padding:10px 12px;text-align:left}
    th{color:var(--muted);font-weight:900;background: rgba(255,255,255,.04)}
    tr+tr td{border-top:1px solid rgba(255,255,255,.07)}
    .tag{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:1100;
    }
    .tag i{width:10px;height:10px;border-radius:999px;display:inline-block}
    .iN{background:var(--n)}
    .iR{background:var(--r)}
    .iSR{background:var(--sr)}
    .iSSR{background:var(--ssr)}

    /* bottom buttons */
    .bottomBar{
      margin-top:auto;
      display:flex;gap:12px;
      position:sticky;
      bottom: calc(12px + env(safe-area-inset-bottom));
    }
    .btn{
      flex:1;
      border:0;
      border-radius: 20px;
      padding:16px 16px;
      color:#091022;
      font-weight:1200;
      letter-spacing:.02em;
      cursor:pointer;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      min-height:64px;
      display:flex;flex-direction:column;align-items:flex-start;justify-content:center;
      gap:4px;
      overflow:hidden;
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .btnOne{background: var(--btn1)}
    .btnTen{background: var(--btn2)}
    .btnTitle{font-size:16px}
    .btnSub{font-size:11px;font-weight:1000;opacity:.9}
    .cost{
      position:absolute;right:12px;top:12px;
      padding:6px 10px;border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;
      font-size:12px;font-weight:1100;
      display:flex;align-items:center;gap:8px;
    }
    .cost .miniGem{
      width:14px;height:14px;border-radius:6px;
      background: url('gem.png') center/cover no-repeat;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,.35));
    }

    /* Stamp (avoid overlap) */
    .stampWrap{
      position:absolute;
      left:10px;
      top:10px;
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:none;
    }
    .stampImg{
      width:110px;
      transform: rotate(-12deg);
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .tenHint{
      font-size:11px;
      font-weight:1200;
      color:#112;
      background: rgba(255,255,255,.75);
      padding:6px 10px;
      border-radius:999px;
      transform: rotate(-6deg);
    }

    /* Reset area bottom */
    .footer{
      margin-top:14px;
      display:flex;justify-content:center;
    }
    .resetBtn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1100;
      cursor:pointer;
      backdrop-filter: blur(8px);
    }

    /* Toast (login bonus notify) */
    .toast{
      position:fixed;
      left:12px; right:12px;
      top:12px;
      max-width:820px;
      margin:0 auto;
      z-index:80;
      display:none;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.35));
      backdrop-filter: blur(10px);
      box-shadow: 0 22px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .toast.show{display:block}
    .toastIn{
      padding:12px 12px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .toastL{display:flex;gap:12px;align-items:center}
    .toastGem{width:40px;height:40px;border-radius:14px;background: url('gem.png') center/cover no-repeat;}
    .toastTitle{font-weight:1200}
    .toastSub{font-size:12px;color:var(--muted);margin-top:2px}
    .toastTap{font-size:12px;font-weight:1200;color:#fff;opacity:.9}

    /* Overlay for gacha */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center;justify-content:center;
      padding:14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      z-index:70;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(860px, 100%);
      max-height: min(92vh, 920px);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 420px at 20% 10%, rgba(255,213,74,.18), transparent 55%),
        radial-gradient(900px 420px at 85% 20%, rgba(45,212,255,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.30));
      box-shadow: 0 30px 120px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .modalTop{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .modalTop b{font-weight:1200}
    .modalTop span{font-size:12px;color:var(--muted)}
    .modalBody{
      padding:12px;
      overflow:auto; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã« */
      -webkit-overflow-scrolling: touch;
      position:relative;
      flex:1;
    }
    .modalFooter{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:flex-end;gap:10px;
      background: rgba(0,0,0,.18);
    }
    .ok{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1200;
      cursor:pointer;
    }

    /* Illustration characters in modal */
    .ill{
      position:absolute;
      bottom:-6px;
      width:min(40vw, 280px);
      pointer-events:none;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.65));
      opacity:.95;
    }
    .illL{ left:-10px; }
    .illR{ right:-10px; transform: scaleX(-1); }

    /* Grid cards for 10-pull */
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      padding-bottom: 10px;
    }
    @media (max-width: 520px){
      .grid{grid-template-columns:1fr;gap:10px}
      .ill{opacity:.55}
    }

    .gcard{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.24);
      min-height:118px;
      position:relative;
      overflow:hidden;
      padding:12px;
      display:flex;flex-direction:column;justify-content:space-between;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .gcard.back::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(900px 340px at 20% 10%, rgba(255,255,255,.08), transparent 60%);
      opacity:.55;
    }
    .gcard.back::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:14px;
      background: url('card_back.png') center/cover no-repeat;
      border:1px solid rgba(255,255,255,.18);
      opacity:.95;
    }
    .gcard .meta{
      position:relative;
      display:flex;justify-content:space-between;align-items:center;
      color:var(--muted);
      font-size:12px;font-weight:1100;
    }
    .gcard .tap{
      position:relative;
      font-size:14px;
      font-weight:1200;
      letter-spacing:.08em;
      opacity:.92;
    }

    /* opened card */
    .gcard.open{
      cursor:default;
      background: rgba(0,0,0,.30);
    }
    .rar{
      position:relative;
      font-weight:1300;
      letter-spacing:.10em;
      font-size:14px;
    }
    .amt{
      position:relative;
      font-size:34px;
      font-weight:1300;
      line-height:1.05;
    }
    .frameN{border-color: rgba(154,166,198,.55)}
    .frameR{border-color: rgba(45,212,255,.55); box-shadow: 0 0 34px rgba(45,212,255,.12)}
    .frameSR{border-color: rgba(255,138,0,.55); box-shadow: 0 0 34px rgba(255,138,0,.14)}
    .frameSSR{border-color: rgba(255,213,74,.70); box-shadow: 0 0 46px rgba(255,213,74,.18)}
    .rarN{color: rgba(154,166,198,.95)}
    .rarR{color: rgba(45,212,255,.95)}
    .rarSR{color: rgba(255,138,0,.95)}
    .rarSSR{color: rgba(255,213,74,.98)}

    /* Tap hint - only while back */
    .gcard.back .tap{
      animation: pulse 1.0s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{opacity:.55; transform: translateY(0)}
      50%{opacity:1; transform: translateY(-1px)}
    }

    /* Rainbow premonition */
    .premonition{
      display:none;
      margin-bottom:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:
        conic-gradient(from 180deg,
          rgba(255,0,92,.28), rgba(255,214,0,.28),
          rgba(0,229,255,.28), rgba(124,77,255,.28),
          rgba(255,122,0,.28), rgba(255,0,92,.28)
        );
      padding:10px 12px;
      font-weight:1200;
      text-align:center;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    .premonition.show{display:block}
    .premonition small{display:block;color:#0b1022;font-weight:1100;opacity:.9}

    /* SSR reveal anime: rotate -> crack -> light */
    .ssrFX{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:0;
    }
    .gcard.open.frameSSR .ssrFX{
      opacity:1;
    }
    .ssrLight{
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.45),
        rgba(255,214,0,.55),
        rgba(0,229,255,.45),
        rgba(124,77,255,.45),
        rgba(255,122,0,.55),
        rgba(255,0,92,.45),
        rgba(255,0,92,.0)
      );
      filter: blur(10px) saturate(1.25);
      mix-blend-mode: screen;
      animation: spin 1.2s linear infinite;
      opacity:.95;
    }
    @keyframes spin{to{transform: rotate(360deg)}}
    .ssrCrack{
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 50% 55%, rgba(255,255,255,.85), rgba(255,255,255,.0) 60%),
        linear-gradient(135deg, rgba(255,255,255,.0), rgba(255,255,255,.55), rgba(255,255,255,.0));
      opacity:0;
      animation: crack 700ms ease forwards;
    }
    @keyframes crack{
      0%{opacity:0; transform: scale(.85) rotate(0deg)}
      35%{opacity:.25; transform: scale(1.02) rotate(6deg)}
      70%{opacity:.55; transform: scale(1.05) rotate(-4deg)}
      100%{opacity:.18; transform: scale(1.10) rotate(2deg)}
    }
    .ssrBurst{
      position:absolute; inset:0;
      background: rgba(255,255,255,1);
      opacity:0;
      animation: burst 650ms ease forwards;
    }
    @keyframes burst{
      0%{opacity:0}
      12%{opacity:.95}
      100%{opacity:0}
    }

    /* Total reveal */
    .totalBox{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      padding:12px;
      text-align:center;
    }
    .totalLead{
      font-size:14px;font-weight:1200;letter-spacing:.08em;
      color:var(--muted);
    }
    .totalAmt{
      margin-top:8px;
      font-size:52px;
      font-weight:1400;
      letter-spacing:.02em;
      line-height:1;
      text-shadow: 0 12px 40px rgba(0,0,0,.55);
    }
    .totalAmt.pop{
      animation: pop 520ms ease forwards;
    }
    @keyframes pop{
      0%{transform: scale(.92); opacity:.2}
      45%{transform: scale(1.06); opacity:1}
      100%{transform: scale(1.0); opacity:1}
    }

    /* confetti (simple) */
    .confetti{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div class="gems" aria-label="æ‰€æŒã‚¸ã‚§ãƒ ">
        <div class="gemIcon" aria-hidden="true"></div>
        <div>
          <div><b id="gems">0</b> <span style="font-weight:1000;opacity:.9">GEMS</span></div>
          <small>æ‰€æŒã‚¸ã‚§ãƒ </small>
        </div>
      </div>
      <div style="color:var(--muted);font-size:12px;font-weight:1100">â€» 10é€£ã¯åˆè¨ˆæœ€å¤§30,000å††</div>
    </div>

    <div class="popup">
      <div class="popupIn">
        <div class="title">æœ€å¤§30,000å†† ãŠå¹´ç‰ã‚¬ãƒãƒ£ï¼</div>
        <div class="sub">
          1å›ã”ã¨ã«é‡‘é¡ãŒç¢ºå®š â†’ 10å›é–‹å° â†’ æœ€å¾Œã«åˆè¨ˆã‚’ãƒ‰æ´¾æ‰‹ã«è¡¨ç¤ºã€‚<br>
          10é€£ã¯<strong>SSRç¢ºå®š</strong>ï¼ˆ3,000å††ãŒæœ€ä½1æšï¼‰ã€‚
        </div>

        <div class="maxBadge"><span class="dot"></span> 10é€£åˆè¨ˆ æœ€å¤§ <strong>Â¥30,000</strong>ï¼ˆSSRÃ—10ï¼‰</div>

        <div class="rates">
          <div class="ratesHead">
            <b>æä¾›å‰²åˆ</b>
            <span>ï¼ˆåŒãƒ©ãƒ³ã‚¯å†…ã¯å‡ç­‰ï¼‰</span>
          </div>
          <table>
            <thead>
              <tr>
                <th>ãƒ¬ã‚¢ãƒªãƒ†ã‚£</th>
                <th>é‡‘é¡</th>
                <th>ç¢ºç‡</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="tag"><i class="iSSR"></i>SSR</span></td>
                <td>Â¥3,000</td>
                <td><span id="pSSR">--</span>%</td>
              </tr>
              <tr>
                <td><span class="tag"><i class="iSR"></i>SR</span></td>
                <td>Â¥1,000 / Â¥2,000</td>
                <td><span id="pSR">--</span>%</td>
              </tr>
              <tr>
                <td><span class="tag"><i class="iR"></i>R</span></td>
                <td>Â¥300 / Â¥500</td>
                <td><span id="pR">--</span>%</td>
              </tr>
              <tr>
                <td><span class="tag"><i class="iN"></i>N</span></td>
                <td>Â¥10 / Â¥50 / Â¥100</td>
                <td><span id="pN">--</span>%</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="sub" style="margin-top:10px">
          10é€£ã®é€”ä¸­ã§SSRãŒçœ ã£ã¦ã„ã‚‹ã¨â€¦ <strong>è™¹äºˆå…†</strong>ãŒ1å›ã ã‘å‡ºã‚‹ã€‚
        </div>
      </div>
    </div>

    <!-- bottom buttons -->
    <div class="bottomBar">
      <button class="btn btnOne" id="btnOne">
        <div class="btnTitle">1å›ã‚¬ãƒãƒ£</div>
        <div class="btnSub">1å›ï¼š300ã‚¸ã‚§ãƒ </div>
        <div class="cost"><span class="miniGem"></span><span>-300</span></div>
      </button>

      <button class="btn btnTen" id="btnTen">
        <div class="stampWrap" id="stampWrap" style="display:none;">
          <img class="stampImg" src="ssr_stamp.png" alt="SSRç¢ºå®š">
          <div class="tenHint">SSRç¢ºå®šï¼</div>
        </div>
        <div class="btnTitle">SSRç¢ºå®šï¼10é€£ã‚¬ãƒãƒ£</div>
        <div class="btnSub">10é€£ï¼š3000ã‚¸ã‚§ãƒ ï¼ˆ1æšãšã¤é–‹å°ï¼‰</div>
        <div class="cost"><span class="miniGem"></span><span>-3000</span></div>
      </button>
    </div>

    <!-- reset at page bottom -->
    <div class="footer">
      <button class="resetBtn" id="resetBtn">åˆæœŸåŒ–ï¼ˆè¦ªPINï¼‰</button>
    </div>
  </div>

  <!-- Login bonus toast -->
  <div class="toast" id="toast" role="button" aria-label="ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹é€šçŸ¥">
    <div class="toastIn" id="toastTap">
      <div class="toastL">
        <div class="toastGem" aria-hidden="true"></div>
        <div>
          <div class="toastTitle">ãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ç²å¾—ï¼</div>
          <div class="toastSub">ã‚¿ãƒƒãƒ—ã§ã‚¸ã‚§ãƒ 3,000å€‹ã‚’å—ã‘å–ã‚‹</div>
        </div>
      </div>
      <div class="toastTap">TAP</div>
    </div>
  </div>

  <!-- Gacha overlay -->
  <div class="overlay" id="overlay" aria-modal="true" role="dialog">
    <div class="modal">
      <img class="ill illL" src="dragon_spirit.png" alt="">
      <img class="ill illR" src="summoner.png" alt="">

      <div class="modalTop">
        <div>
          <b id="modalTitle">ã‚¬ãƒãƒ£çµæœ</b>
          <div><span id="modalSub">ã‚¿ãƒƒãƒ—ã§1æšãšã¤é–‹å°</span></div>
        </div>
        <span id="step">-</span>
      </div>

      <div class="modalBody" id="modalBody">
        <div class="premonition" id="premonition">
          ğŸŒˆ è™¹ã®æ°—é…ãŒã™ã‚‹â€¦â€¦<small>ï¼ˆSSRãŒçœ ã£ã¦ã„ã‚‹ï¼‰</small>
        </div>

        <div class="grid" id="grid"></div>

        <div class="totalBox" id="totalBox" style="display:none;">
          <div class="totalLead" id="totalLead">åˆè¨ˆã¯ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»</div>
          <div class="totalAmt" id="totalAmt">Â¥---</div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="ok" id="closeBtn">é–‰ã˜ã‚‹</button>
      </div>

      <div class="confetti" id="confetti"></div>
    </div>
  </div>

  <script>
    /********************
     * Config
     ********************/
    const CFG = {
      BONUS_GEMS: 3000,
      COST_ONE: 300,
      COST_TEN: 3000,
      PARENT_PIN: "2525",
      TAP_COOLDOWN_MS: 300,

      // Amounts (same rarity = equal probability)
      AMOUNTS: {
        N:  [10, 50, 100],
        R:  [300, 500],
        SR: [1000, 2000],
        SSR:[3000]
      },

      // Rarity probabilities (sum=1)
      // tuned for "gamey" and high expected value
      // EV per pull â‰ˆ 1000 (so 10-pull EV â‰ˆ 10000)
      PROB: {
        SSR: 0.09,
        SR:  0.39,
        R:   0.35,
        N:   0.17
      }
    };

    const LS = {
      gems: "otg_gems_v2",
      bonusTaken: "otg_bonus_taken_v2"
    };

    const $ = (id) => document.getElementById(id);
    const yen = (n) => "Â¥" + Number(n).toLocaleString("ja-JP");

    /********************
     * State helpers
     ********************/
    function getGems(){
      const v = localStorage.getItem(LS.gems);
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function setGems(n){
      localStorage.setItem(LS.gems, String(Math.max(0, Math.floor(n))));
      renderHUD();
    }
    function bonusTaken(){
      return localStorage.getItem(LS.bonusTaken) === "1";
    }
    function setBonusTaken(){
      localStorage.setItem(LS.bonusTaken, "1");
    }

    function renderHUD(){
      $("gems").textContent = getGems();
      $("btnOne").disabled = getGems() < CFG.COST_ONE;
      $("btnTen").disabled = getGems() < CFG.COST_TEN;
    }

    function renderRates(){
      $("pSSR").textContent = (CFG.PROB.SSR*100).toFixed(1);
      $("pSR").textContent  = (CFG.PROB.SR*100).toFixed(1);
      $("pR").textContent   = (CFG.PROB.R*100).toFixed(1);
      $("pN").textContent   = (CFG.PROB.N*100).toFixed(1);
    }

    /********************
     * Audio / vibe (no files)
     ********************/
    let audioCtx;
    function beep(seq){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const t0 = audioCtx.currentTime + 0.01;
        seq.forEach((s)=>{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = s.type || "sine";
          o.frequency.value = s.f;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(audioCtx.destination);
          o.start(t0 + s.at);
          g.gain.setValueAtTime(0.0001, t0 + s.at);
          g.gain.exponentialRampToValueAtTime(s.v || 0.12, t0 + s.at + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + s.at + s.d);
          o.stop(t0 + s.at + s.d + 0.03);
        });
      }catch(e){}
    }
    function vibe(ms){ if (navigator.vibrate) navigator.vibrate(ms); }

    const sfx = {
      tap(){ beep([{at:0,f:392,d:0.08,v:0.08,type:"square"}]); },
      open(){ beep([{at:0,f:262,d:0.10,v:0.09},{at:0.10,f:330,d:0.10,v:0.09}]); },
      sr(){ beep([{at:0,f:440,d:0.14,v:0.12,type:"sawtooth"},{at:0.14,f:659.25,d:0.16,v:0.12,type:"sawtooth"}]); },
      ssr(){
        beep([
          {at:0.00,f:523.25,d:0.14,v:0.14,type:"sawtooth"},
          {at:0.14,f:659.25,d:0.14,v:0.14,type:"sawtooth"},
          {at:0.28,f:783.99,d:0.22,v:0.16,type:"sawtooth"},
          {at:0.52,f:1046.5,d:0.25,v:0.18,type:"sine"}
        ]);
      },
      total(){ beep([{at:0,f:330,d:0.12,v:0.10},{at:0.12,f:392,d:0.12,v:0.11},{at:0.24,f:523.25,d:0.18,v:0.12}]); }
    };

    /********************
     * Gacha logic
     ********************/
    function pickRarity(){
      const r = Math.random();
      const pSSR = CFG.PROB.SSR;
      const pSR  = pSSR + CFG.PROB.SR;
      const pR   = pSR  + CFG.PROB.R;
      if (r < pSSR) return "SSR";
      if (r < pSR)  return "SR";
      if (r < pR)   return "R";
      return "N";
    }

    function pickAmount(rarity){
      const arr = CFG.AMOUNTS[rarity];
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function rollOne(){
      const rar = pickRarity();
      const amt = pickAmount(rar);
      return { rar, amt };
    }

    function ensureTenSSR(results){
      if (results.some(x => x.rar === "SSR")) return results;
      // upgrade 1 random to SSR
      const i = Math.floor(Math.random() * results.length);
      results[i] = { rar: "SSR", amt: 3000 };
      return results;
    }

    /********************
     * UI - Overlay
     ********************/
    let tapLock = false;
    function canTap(){
      if (tapLock) return false;
      tapLock = true;
      setTimeout(()=> tapLock=false, CFG.TAP_COOLDOWN_MS);
      return true;
    }

    function showOverlay(title, sub){
      $("modalTitle").textContent = title;
      $("modalSub").textContent = sub;
      $("overlay").classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function hideOverlay(){
      $("overlay").classList.remove("show");
      document.body.style.overflow = "";
      $("confetti").innerHTML = "";
    }

    function frameClass(rar){
      return rar==="SSR" ? "frameSSR" : rar==="SR" ? "frameSR" : rar==="R" ? "frameR" : "frameN";
    }
    function rarClass(rar){
      return rar==="SSR" ? "rarSSR" : rar==="SR" ? "rarSR" : rar==="R" ? "rarR" : "rarN";
    }

    function confettiBurst(kind){
      const wrap = $("confetti");
      wrap.innerHTML = "";
      const count = kind==="SSR" ? 80 : (kind==="SR" ? 40 : 18);
      for(let i=0;i<count;i++){
        const el = document.createElement("div");
        el.style.position="absolute";
        el.style.top="-30px";
        el.style.left = (Math.random()*100) + "%";
        const w = 6 + Math.random()*10;
        const h = 10 + Math.random()*18;
        el.style.width = w+"px";
        el.style.height = h+"px";
        el.style.borderRadius = "4px";
        const col =
          kind==="SSR" ? ["rgba(255,0,92,.95)","rgba(255,214,0,.95)","rgba(0,229,255,.95)","rgba(124,77,255,.95)","rgba(255,122,0,.95)"][Math.floor(Math.random()*5)]
          : kind==="SR" ? (Math.random()<.5 ? "rgba(255,213,74,.95)" : "rgba(255,138,0,.95)")
          : "rgba(255,255,255,.85)";
        el.style.background = col;

        const dur = 900 + Math.random()*900;
        const rot = Math.random()*360;
        const drift = (Math.random()*160 - 80);
        el.animate(
          [
            { transform:`translate(0px,-10px) rotate(${rot}deg)`, opacity:1 },
            { transform:`translate(${drift}px,420px) rotate(${rot+760}deg)`, opacity:0.95 }
          ],
          { duration: dur, delay: Math.random()*180, easing: "linear", fill:"forwards" }
        );
        wrap.appendChild(el);
      }
    }

    /********************
     * Session for opening cards
     ********************/
    let session = null; // { mode, results, opened[], totalShown, rainbowShown }
    function buildGrid(results){
      const grid = $("grid");
      grid.innerHTML = "";
      results.forEach((_, idx)=>{
        const card = document.createElement("div");
        card.className = "gcard back";
        card.dataset.idx = String(idx);
        card.innerHTML = `
          <div class="meta">
            <span>${idx+1}/10</span>
            <span> </span>
          </div>
          <div class="tap">TAP</div>
        `;
        card.addEventListener("click", ()=> onTapCard(idx));
        grid.appendChild(card);
      });
      $("totalBox").style.display = "none";
      $("premonition").classList.remove("show");
      $("modalBody").scrollTop = 0;
    }

    function updateStep(){
      const opened = session.opened.filter(Boolean).length;
      $("step").textContent = `${opened}/10 é–‹å°`;
    }

    function showRainbowPremonitionIfNeeded(){
      if (session.rainbowShown) return;
      const openedCount = session.opened.filter(Boolean).length;
      if (openedCount < 2) return; // æ—©ã™ãã‚‹ã¨ãƒã‚¿ãƒãƒ¬æ„Ÿ
      const remain = session.results.filter((_,i)=>!session.opened[i]);
      const hasSSR = remain.some(x => x.rar === "SSR");
      if (!hasSSR) return;

      // ä¸€å›ã ã‘è™¹äºˆå…†
      session.rainbowShown = true;
      $("premonition").classList.add("show");
      sfx.ssr(); vibe(80);
      setTimeout(()=> $("premonition").classList.remove("show"), 1400);
    }

    function openCardEl(cardEl, result){
      cardEl.classList.remove("back");
      cardEl.classList.add("open", frameClass(result.rar));
      cardEl.innerHTML = `
        <div class="ssrFX">
          <div class="ssrLight" style="display:${result.rar==="SSR"?"block":"none"}"></div>
          <div class="ssrBurst" style="display:${result.rar==="SSR"?"block":"none"}"></div>
          <div class="ssrCrack" style="display:${result.rar==="SSR"?"block":"none"}"></div>
        </div>
        <div class="meta">
          <span>ç¢ºå®š</span>
          <span class="rar ${rarClass(result.rar)}">${result.rar}</span>
        </div>
        <div class="amt">${yen(result.amt)}</div>
      `;
    }

    async function showTotal(){
      const total = session.results.reduce((s,x)=> s + x.amt, 0);
      $("totalBox").style.display = "block";
      $("totalLead").textContent = "åˆè¨ˆã¯ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»";
      $("totalAmt").textContent = "Â¥---";
      $("totalAmt").classList.remove("pop");

      // æºœã‚
      await new Promise(r=>setTimeout(r, 700));
      $("totalAmt").textContent = yen(total);
      $("totalAmt").classList.add("pop");
      sfx.total(); vibe(70);
      confettiBurst(total >= 20000 ? "SSR" : (total >= 12000 ? "SR" : "R"));
    }

    async function onTapCard(idx){
      if (!session) return;
      if (!canTap()) return;

      const grid = $("grid");
      const cardEl = grid.querySelector(`.gcard[data-idx="${idx}"]`);
      if (!cardEl) return;
      if (session.opened[idx]) return;

      session.opened[idx] = true;

      // SFX by rarity
      const result = session.results[idx];
      if (result.rar === "SSR"){ sfx.ssr(); vibe(120); }
      else if (result.rar === "SR"){ sfx.sr(); vibe(55); }
      else { sfx.open(); vibe(25); }

      openCardEl(cardEl, result);
      updateStep();

      // rainbow premonition (once) while SSR still remaining
      showRainbowPremonitionIfNeeded();

      // if all opened => show total
      const openedCount = session.opened.filter(Boolean).length;
      if (openedCount === session.results.length){
        await showTotal();
      }
    }

    /********************
     * Start gacha
     ********************/
    function startOne(){
      if (getGems() < CFG.COST_ONE){
        alert("ã‚¸ã‚§ãƒ ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ1å›ã¯300ã‚¸ã‚§ãƒ ï¼‰");
        return;
      }
      setGems(getGems() - CFG.COST_ONE);

      const r = rollOne();
      // 1å›ã¯â€œå³é–‹å°â€æ¼”å‡º
      showOverlay("1å›ã‚¬ãƒãƒ£", "çµæœãŒç¢ºå®šï¼");
      session = {
        mode:"one",
        results:[r],
        opened:[false],
        rainbowShown:true
      };

      // single grid style (still reuse)
      $("grid").innerHTML = "";
      const single = document.createElement("div");
      single.className = "gcard back";
      single.style.minHeight = "160px";
      single.style.maxWidth = "520px";
      single.style.margin = "0 auto";
      single.innerHTML = `
        <div class="meta"><span>1/1</span><span> </span></div>
        <div class="tap">TAP</div>
      `;
      single.addEventListener("click", async ()=>{
        if (!canTap()) return;
        if (session.opened[0]) return;
        session.opened[0] = true;

        if (r.rar === "SSR"){ sfx.ssr(); vibe(120); confettiBurst("SSR"); }
        else if (r.rar === "SR"){ sfx.sr(); vibe(55); confettiBurst("SR"); }
        else { sfx.open(); vibe(25); }

        openCardEl(single, r);
        $("step").textContent = "1/1 é–‹å°";
        $("totalBox").style.display = "block";
        $("totalLead").textContent = "çµæœã¯â€¦â€¦";
        $("totalAmt").textContent = yen(r.amt);
        $("totalAmt").classList.add("pop");
      });
      $("grid").appendChild(single);

      $("totalBox").style.display = "none";
      $("premonition").classList.remove("show");
      $("step").textContent = "0/1 é–‹å°";
      $("modalBody").scrollTop = 0;

      renderHUD();
    }

    function startTen(){
      if (getGems() < CFG.COST_TEN){
        alert("ã‚¸ã‚§ãƒ ãŒè¶³ã‚Šã¾ã›ã‚“ï¼ˆ10é€£ã¯3000ã‚¸ã‚§ãƒ ï¼‰");
        return;
      }
      setGems(getGems() - CFG.COST_TEN);

      // Create 10 results + SSR guarantee
      let results = Array.from({length:10}, ()=> rollOne());
      results = ensureTenSSR(results);

      showOverlay("SSRç¢ºå®šï¼10é€£ã‚¬ãƒãƒ£", "ã‚¿ãƒƒãƒ—ã§1æšãšã¤é–‹å°ï¼ˆ0.3ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰");
      session = {
        mode:"ten",
        results,
        opened: Array(10).fill(false),
        rainbowShown:false
      };

      buildGrid(results);
      updateStep();

      // show SSR guarantee stamp animation on the button (quick flash)
      $("stampWrap").style.display = "flex";
      setTimeout(()=>{ $("stampWrap").style.display = "none"; }, 1200);

      // also start with a little â€œstampâ€ feel
      sfx.tap(); vibe(25);

      renderHUD();
    }

    /********************
     * Login bonus toast
     ********************/
    function maybeShowBonusToast(){
      if (bonusTaken()) return;
      // show once on first load
      $("toast").classList.add("show");
    }
    function takeBonus(){
      if (bonusTaken()) return;
      setBonusTaken();
      setGems(getGems() + CFG.BONUS_GEMS);
      $("toast").classList.remove("show");
      confettiBurst("SSR");
      sfx.ssr(); vibe(90);
    }

    /********************
     * Reset
     ********************/
    function resetAll(){
      const pin = prompt("è¦ªPINã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      if (pin === null) return;
      if (pin !== CFG.PARENT_PIN){
        alert("PINãŒé•ã„ã¾ã™");
        return;
      }
      localStorage.removeItem(LS.gems);
      localStorage.removeItem(LS.bonusTaken);
      session = null;
      $("toast").classList.remove("show");
      hideOverlay();
      renderHUD();
      maybeShowBonusToast();
      alert("åˆæœŸåŒ–ã—ã¾ã—ãŸï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒœãƒ¼ãƒŠã‚¹ã‚‚å—ã‘å–ã‚Šç›´ã›ã¾ã™ï¼‰");
    }

    /********************
     * Init
     ********************/
    function init(){
      renderRates();
      renderHUD();
      maybeShowBonusToast();

      $("btnOne").addEventListener("click", startOne);
      $("btnTen").addEventListener("click", startTen);

      $("toastTap").addEventListener("click", takeBonus);

      $("resetBtn").addEventListener("click", resetAll);

      $("closeBtn").addEventListener("click", ()=> {
        session = null;
        hideOverlay();
      });

      // click outside modal closes
      $("overlay").addEventListener("click", (e)=>{
        if (e.target === $("overlay")) {
          session = null;
          hideOverlay();
        }
      });
    }
    init();
  </script>
</body>
</html>
