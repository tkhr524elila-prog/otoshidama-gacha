<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" />
  <title>最大30,000円 お年玉ガチャ！</title>

  <style>
    :root{
      --bg:#070b18;
      --line: rgba(255,255,255,.12);
      --text:#eef3ff;
      --muted:#a7b1d6;
      --gold:#ffd54a;
      --ssr:#ffd54a;
      --sr:#ff8a2a;
      --r:#00d9ff;
      --n:#8ea0c9;
      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --radius: 18px;
      --cool: 300ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background: var(--bg);
      overflow-x:hidden;
    }

    /* 背景 */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(180deg, rgba(0,0,0,.58), rgba(0,0,0,.78)),
        url("assets/bg.jpg");
      background-size: cover;
      background-position: center;
      filter:saturate(1.05);
      z-index:-3;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(900px 600px at 50% 25%, rgba(255,213,74,.10), transparent 60%),
        radial-gradient(900px 700px at 20% 85%, rgba(0,217,255,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 85%, rgba(124,77,255,.14), transparent 60%);
      z-index:-2;
      pointer-events:none;
    }

    .safe{
      padding: clamp(14px, 3.2vw, 22px);
      padding-bottom: calc(clamp(14px, 3.2vw, 22px) + env(safe-area-inset-bottom));
      min-height:100%;
      display:flex;
      justify-content:center;
    }
    .app{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
      position:relative;
    }

    /* body scroll lock (modal) */
    body.modal-open{
      position: fixed;
      width: 100%;
      overflow: hidden;
      left:0;
    }

    /* 共通パネル */
    .panel{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel-in{ padding:16px; }

    .screen{ display:none; }
    .screen.show{ display:block; }

    /* タイトル */
    .titleHero{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      text-align:center;
      padding:28px 16px;
    }
    .logoImg{
      width:min(520px, 96%);
      margin: 0 auto;
      aspect-ratio: 2 / 1;
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
    }
    .logoImg img{
      width:100%; height:100%;
      object-fit:contain;
      display:block;
    }
    .titleText{
      font-size:22px;
      font-weight:1100;
      letter-spacing:.04em;
      margin:0;
      text-shadow: 0 10px 50px rgba(0,0,0,.60);
    }
    .titleSub{
      margin:0;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }

    /* ボタン */
    .btnRow{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px; }
    .btn{
      border:0;
      cursor:pointer;
      border-radius: 16px;
      padding:14px 16px;
      font-weight:1100;
      letter-spacing:.02em;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
      justify-content:center;
      position: relative;
      overflow:hidden;
    }
    .btn:active{ transform: scale(.985); }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; filter:saturate(.75); }
    .btnPrimary{
      color:#081022;
      background: linear-gradient(180deg, #ffd54a, #ff7a00);
      box-shadow: 0 18px 44px rgba(255,122,0,.25);
    }
    .btnBlue{
      color:#071021;
      background: linear-gradient(180deg, rgba(0,217,255,.95), rgba(0,140,255,.95));
      box-shadow: 0 18px 44px rgba(0,140,255,.22);
    }
    .btnOrange{
      color:#091021;
      background: linear-gradient(180deg, rgba(255,213,74,.95), rgba(255,138,42,.95));
      box-shadow: 0 18px 44px rgba(255,138,42,.20);
    }
    .btnDark{
      color: rgba(255,255,255,.92);
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 18px 44px rgba(0,0,0,.35);
    }

    /* ボタン枠画像（任意） */
    .btn.frame::before{
      content:"";
      position:absolute; inset:0;
      background: url("assets/button_frame.png") center/cover no-repeat;
      opacity:.95;
      pointer-events:none;
      mix-blend-mode: screen;
    }

    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      font-size:12px;
      color: rgba(255,255,255,.92);
      font-weight:1000;
      white-space:nowrap;
    }
    .miniGem{
      width:14px;height:14px;
      background: url("assets/gem.png") center/contain no-repeat;
      filter: drop-shadow(0 8px 18px rgba(0,0,0,.35));
    }
    .small{font-size:12px;color:var(--muted)}
    .topRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .gemsBox{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      min-width: 180px;
    }
    .gemIcon{
      width:22px;height:22px;
      background: url("assets/gem.png") center/contain no-repeat;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .gemsNum{font-weight:1000; letter-spacing:.02em}

    /* メニュー中央ポップ */
    .menuPopup{
      position:relative;
      padding:16px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.18));
      overflow:hidden;
    }
    .menuPopup::before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 40% 40%, rgba(255,213,74,.16), transparent 55%);
      pointer-events:none;
    }
    .popupHead{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .popupTitle{
      margin:0;
      font-size:18px;
      font-weight:1200;
      letter-spacing:.03em;
    }
    .dragonArt{
      width:92px;height:92px; border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .dragonArt img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* 提供割合 UI */
    .rateBox{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }
    .rateHead{
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-weight:1100;
      color: rgba(255,255,255,.92);
      font-size:13px;
    }
    .rateTable{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
    }
    .rateTable th,.rateTable td{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      vertical-align:middle;
      color: rgba(255,255,255,.90);
    }
    .rateTable th{ color: var(--muted); font-weight:1000; font-size:12px; }
    .dot{
      width:10px;height:10px;border-radius:99px; display:inline-block; margin-right:8px;
      box-shadow: 0 0 18px rgba(255,255,255,.08);
    }
    .dot.ssr{ background: var(--ssr); box-shadow: 0 0 22px rgba(255,213,74,.18); }
    .dot.sr{ background: var(--sr); box-shadow: 0 0 22px rgba(255,138,42,.18); }
    .dot.r{ background: var(--r); box-shadow: 0 0 22px rgba(0,217,255,.18); }
    .dot.n{ background: var(--n); box-shadow: 0 0 22px rgba(142,160,201,.14); }
    .rateNote{ padding:10px 12px; color:var(--muted); font-size:12px; }

    /* 下部：ガチャボタン */
    .bottomBar{
      display:flex;
      gap:12px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 12px;
    }
    .bottomBar .btn{
      min-width: min(460px, 100%);
      justify-content:space-between;
      padding:14px 14px;
    }
    .btnMainText{
      display:flex; flex-direction:column; gap:2px; align-items:flex-start;
    }
    .btnMainText b{ font-size:14px; }
    .btnMainText span{ font-size:12px; color: rgba(0,0,0,.65); font-weight:900; }
    .btnRight{
      display:flex; align-items:center; gap:10px; flex:0 0 auto;
    }
    .stamp{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1200;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.92);
      white-space:nowrap;
    }

    /* 初期化は最下部 */
    .footer{
      margin-top: 8px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .resetBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.90);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1100;
      cursor:pointer;
    }

    /* Sticky bonus toast (消えない) */
    .toastSticky{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(12px + env(safe-area-inset-bottom));
      width: min(92vw, 720px);
      z-index: 90;
      display:none;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.70);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .toastSticky.show{ display:flex; }
    .toastSticky .txt{
      font-size:13px; color: rgba(255,255,255,.92);
      line-height:1.35;
    }
    .toastSticky .actions{
      display:flex; gap:8px; flex:0 0 auto;
    }
    .toastSticky button{
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1100;
      cursor:pointer;
      white-space:nowrap;
      background: rgba(255,213,74,.18);
      color: rgba(255,255,255,.95);
    }

    /* Overlay / Modal */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.78);
      display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      z-index:100;
    }
    .overlay.show{ display:flex; }
    .modal{
      width:min(980px, 100%);
      max-height: calc(100vh - 32px);
      overflow:auto;
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(900px 520px at 35% 20%, rgba(124,77,255,.22), transparent 60%),
        radial-gradient(900px 520px at 70% 90%, rgba(0,217,255,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.22));
      box-shadow: 0 30px 120px rgba(0,0,0,.70);
      position:relative;
    }
    .modalIn{ padding:16px; }
    .modalTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .modalTitle{ font-weight:1200; font-size:16px; margin:0; }
    .modalSub{ font-size:12px; color:var(--muted); margin-top:6px; }
    .modalClose{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: rgba(255,255,255,.92);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1100;
      cursor:pointer;
      white-space:nowrap;
    }

    /* ボーナス */
    .bonusBox{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:14px;
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
    }
    .gift{
      width:92px;height:92px;border-radius:22px;
      background: conic-gradient(from 160deg, #00d9ff, #7c4dff, #ff7a00, #00d9ff);
      box-shadow: 0 0 30px rgba(0,217,255,.14), 0 0 70px rgba(124,77,255,.12);
      position:relative;
    }
    .gift::after{
      content:"";
      position:absolute; inset:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.18);
    }
    .bonusAmt{
      font-size:40px; font-weight:1300; letter-spacing:.02em;
      display:flex; align-items:center; gap:10px;
    }

    /* ガチャ結果：カード grid */
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (min-width: 720px){
      .grid{ grid-template-columns: repeat(5, 1fr); }
    }

    .cardSlot{
      border-radius:18px;
      position:relative;
      aspect-ratio: 4/3;
      perspective: 900px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .cardSlot.disabled{ opacity:.55; pointer-events:none; }

    .cardInner{
      width:100%; height:100%;
      position:relative;
      transform-style: preserve-3d;
      transition: transform .55s cubic-bezier(.2,.9,.2,1);
    }
    .cardSlot.revealed .cardInner{
      transform: rotateY(180deg);
    }

    .face{
      position:absolute; inset:0;
      border-radius:18px;
      backface-visibility:hidden;
      overflow:hidden;
      border:2px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 44px rgba(0,0,0,.35);
    }

    /* back: 画像 */
    .back{
      background: rgba(0,0,0,.20);
    }
    .back::before{
      content:"";
      position:absolute; inset:0;
      background: url("assets/card_back.png") center/cover no-repeat;
      opacity: .98;
      filter: saturate(1.05);
    }
    .tapBadge{
      position:absolute;
      left:10px; bottom:10px;
      font-size:12px;
      font-weight:1200;
      color: rgba(255,255,255,.90);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
    }
    .idxTxt{
      position:absolute; top:10px; left:10px;
      font-size:12px; color: rgba(255,255,255,.80);
      padding:6px 10px; border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      z-index: 5;
    }

    /* front: 背景柄は置かない（オーラだけ） */
    .front{
      transform: rotateY(180deg);
      background: rgba(0,0,0,.14);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-align:center;
      padding:10px;
      position: relative;
      z-index: 6; /* 数字最前面 */
    }

    /* キャラは数字の背面 */
    .charLayer{
      position:absolute; inset:0;
      pointer-events:none;
      display:none;
      z-index: 4;
    }
    .cardSlot.hasChar .charLayer{ display:block; }
    .charImg{
      position:absolute;
      left:50%;
      top:54%;
      transform: translate(-50%,-50%);
      width: 88%;
      height: 88%;
      object-fit: contain;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.55)) saturate(1.05);
      opacity: .30; /* 読みやすさ優先 */
    }

    .rarTxt{
      font-weight:1300;
      letter-spacing:.14em;
      font-size:14px;
      text-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .amtTxt{
      font-weight:1400;
      font-size:34px;
      letter-spacing:.02em;
      text-shadow: 0 18px 60px rgba(0,0,0,.55);
    }

    /* オーラ/粒子（画像なしで派手） */
    .aura{
      position:absolute; inset:-30%;
      opacity:0;
      pointer-events:none;
      mix-blend-mode: screen;
      filter: blur(10px) saturate(1.2);
      transform: rotate(0deg);
    }
    .spark{
      position:absolute; inset:-10%;
      opacity:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 30% 40%, rgba(255,255,255,.10), transparent 45%),
        radial-gradient(circle at 60% 55%, rgba(255,255,255,.08), transparent 45%),
        radial-gradient(circle at 45% 70%, rgba(255,255,255,.06), transparent 45%);
      mix-blend-mode: screen;
      filter: blur(1px);
    }

    .cardSlot.r .aura{ background: conic-gradient(from 180deg, rgba(0,217,255,0), rgba(0,217,255,.35), rgba(124,77,255,.25), rgba(0,217,255,.35), rgba(0,217,255,0)); }
    .cardSlot.sr .aura{ background: conic-gradient(from 180deg, rgba(255,138,42,0), rgba(255,138,42,.42), rgba(255,213,74,.25), rgba(255,138,42,.42), rgba(255,138,42,0)); }
    .cardSlot.ssr .aura{ background: conic-gradient(from 180deg, rgba(255,0,92,0), rgba(255,0,92,.28), rgba(255,214,0,.48), rgba(0,217,255,.28), rgba(124,77,255,.28), rgba(255,122,0,.38), rgba(255,0,92,.28), rgba(255,0,92,0)); }
    .cardSlot.n .aura{ background: conic-gradient(from 180deg, rgba(142,160,201,0), rgba(142,160,201,.22), rgba(255,255,255,.12), rgba(142,160,201,.22), rgba(142,160,201,0)); }

    .cardSlot.revealed .aura{
      opacity:1;
      animation: auraSpin 1.2s linear infinite;
    }
    .cardSlot.revealed .spark{
      opacity:1;
      animation: sparkPulse .9s ease-in-out infinite;
    }
    @keyframes auraSpin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }
    @keyframes sparkPulse{
      0%,100%{ transform: scale(1); opacity:.55; }
      50%{ transform: scale(1.03); opacity:1; }
    }

    /* “確定する”瞬間：溜め → パカッ */
    .charge{
      position:absolute; inset:0;
      opacity:0;
      pointer-events:none;
      background: radial-gradient(circle at 50% 55%, rgba(255,255,255,.28), rgba(255,255,255,0) 58%);
      mix-blend-mode: screen;
      filter: blur(2px);
    }
    .cardSlot.charging .charge{
      opacity:1;
      animation: charge .25s ease both;
    }
    @keyframes charge{
      0%{ transform: scale(.96); opacity:0; }
      100%{ transform: scale(1.02); opacity:1; }
    }

    /* 開封時フラッシュ＆揺れ（SSR強、SR弱） */
    .flash{
      position: fixed; inset:0;
      background: rgba(255,255,255,.0);
      pointer-events:none;
      z-index: 140;
      opacity:0;
    }
    .flash.on{
      animation: flash .22s ease both;
    }
    @keyframes flash{
      0%{ opacity:0; }
      35%{ opacity:.18; }
      100%{ opacity:0; }
    }
    .shake{
      animation: shake .25s ease both;
    }
    .shake-strong{
      animation: shake .35s ease both;
    }
    @keyframes shake{
      0%{ transform: translate3d(0,0,0); }
      20%{ transform: translate3d(-2px, 1px,0); }
      40%{ transform: translate3d(2px, -1px,0); }
      60%{ transform: translate3d(-1px, 1px,0); }
      80%{ transform: translate3d(1px, -1px,0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* SSR 登場：回転→割れる→光（既存強化） */
    .ssrCrack{
      position:absolute; inset:0;
      opacity:0;
      pointer-events:none;
      background:
        linear-gradient(45deg, rgba(255,255,255,.0) 45%, rgba(255,255,255,.35) 50%, rgba(255,255,255,.0) 55%),
        linear-gradient(-20deg, rgba(255,255,255,.0) 45%, rgba(255,255,255,.25) 50%, rgba(255,255,255,.0) 55%),
        radial-gradient(120px 90px at 60% 40%, rgba(255,213,74,.22), transparent 60%);
      transform: scale(1.02);
      z-index: 7;
    }
    .ssrLight{
      position:absolute; inset:-20%;
      opacity:0;
      pointer-events:none;
      background: radial-gradient(circle at 50% 55%, rgba(255,213,74,.85), rgba(255,213,74,.18) 45%, rgba(255,213,74,0) 70%);
      filter: blur(2px);
      mix-blend-mode: screen;
      z-index: 7;
    }
    .cardSlot.ssr.ssr-reveal .ssrCrack{ animation: ssrCrack 520ms ease-in-out both; }
    .cardSlot.ssr.ssr-reveal .ssrLight{ animation: ssrLight 680ms ease-in-out both; }
    @keyframes ssrCrack{
      0%{opacity:0; transform: scale(1.02)}
      35%{opacity:.25}
      55%{opacity:.95}
      100%{opacity:0}
    }
    @keyframes ssrLight{
      0%{opacity:0; transform: scale(.96)}
      40%{opacity:.55}
      60%{opacity:1}
      100%{opacity:0}
    }

    /* SSR確定スタンプ：中心ドン → 右上へ */
    .stampCenter{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 130;
      pointer-events:none;
    }
    .stampCenter.show{ display:flex; }
    .stampCenter img{
      width: min(640px, 86vw);
      max-width: 640px;
      transform: rotate(-6deg) scale(.75);
      opacity:0;
      filter: drop-shadow(0 30px 80px rgba(0,0,0,.65));
      animation: stampBoom 1.05s ease both;
    }
    @keyframes stampBoom{
      0%{ transform: translateY(-12px) rotate(-10deg) scale(.7); opacity:0; }
      18%{ opacity:1; transform: translateY(0) rotate(-6deg) scale(1.05); }
      40%{ transform: translateY(0) rotate(-6deg) scale(1); }
      100%{ transform: translate(320px,-160px) rotate(-2deg) scale(.24); opacity:.92; }
    }

    /* 召喚陣（10連開始） */
    .magicCircle{
      position: absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 120;
      pointer-events:none;
    }
    .magicCircle.show{ display:flex; }
    .circle{
      width: min(560px, 86vw);
      aspect-ratio: 1/1;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.14);
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.10), transparent 55%),
        conic-gradient(from 180deg, rgba(0,217,255,.0), rgba(0,217,255,.35), rgba(124,77,255,.35), rgba(255,122,0,.30), rgba(0,217,255,.0));
      filter: blur(.1px) saturate(1.15);
      box-shadow: 0 18px 90px rgba(0,0,0,.6);
      animation: circleSpin 1.05s linear both;
      opacity: .92;
    }
    .circle::before, .circle::after{
      content:"";
      position:absolute; inset: 10%;
      border-radius: 999px;
      border: 1px dashed rgba(255,255,255,.16);
    }
    .circle::after{
      inset: 22%;
      border-style: solid;
      border-color: rgba(255,213,74,.18);
    }
    @keyframes circleSpin{
      0%{ transform: scale(.92) rotate(0deg); opacity:0; }
      20%{ opacity:1; transform: scale(1) rotate(90deg); }
      100%{ transform: scale(1.03) rotate(360deg); opacity:0; }
    }

    /* 合計演出 */
    .sumBox{
      margin-top:14px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding:14px;
      text-align:center;
      display:none;
      position:relative;
      overflow:hidden;
    }
    .sumBox.show{ display:block; }
    .sumBox::before{
      content:"";
      position:absolute; inset:-60%;
      background: radial-gradient(circle at 50% 50%, rgba(255,213,74,.22), transparent 60%);
      pointer-events:none;
    }
    .sumLabel{ color: var(--muted); font-weight:1100; font-size:12px; letter-spacing:.12em; }
    .sumMoney{
      font-size:56px;
      font-weight:1500;
      letter-spacing:.02em;
      margin-top:6px;
      text-shadow: 0 18px 80px rgba(0,0,0,.65);
    }
    .sumMoney.pop{ animation: pop 520ms ease both; }
    @keyframes pop{
      0%{ transform: scale(.90); opacity:.2; filter: blur(1px); }
      45%{ transform: scale(1.06); opacity:1; filter: blur(0); }
      100%{ transform: scale(1); opacity:1; }
    }

    /* 紙吹雪Canvas */
    #confetti{
      position: fixed;
      inset:0;
      z-index: 160;
      pointer-events:none;
      display:none;
    }
    #confetti.show{ display:block; }

    /* スマホ調整 */
    @media (max-width: 430px){
      .btn{ min-width: 100%; }
      .bottomBar .btn{ min-width: 100%; }
      .amtTxt{ font-size:30px; }
      .sumMoney{ font-size:48px; }
    }
  </style>
</head>

<body>
  <div class="safe">
    <div class="app">

      <!-- TITLE SCREEN -->
      <div class="screen panel" id="screenTitle">
        <div class="titleHero">
          <div class="logoImg">
            <img src="assets/logo.png" alt="最大30,000円 お年玉ガチャ！">
          </div>
          <h1 class="titleText">最大30,000円 お年玉ガチャ！</h1>
          <p class="titleSub">
            ログインで <b>10,000ジェム</b> を受け取ってスタート。<br>
            開封は順番固定（1/10→2/10…）。最後に合計ド派手演出。
          </p>
          <div class="btnRow">
            <button class="btn btnPrimary" id="btnLogin">ログイン</button>
          </div>
          <div class="small">※ 端末内のみ（サーバー無し）</div>
        </div>
      </div>

      <!-- MENU SCREEN -->
      <div class="screen" id="screenMenu">
        <div class="topRow">
          <div class="gemsBox panel">
            <div class="panel-in" style="display:flex;align-items:center;gap:10px;padding:12px;">
              <div class="gemIcon"></div>
              <div>
                <div class="gemsNum"><span id="gems">0</span> <span class="small">GEMS</span></div>
                <div class="small">所持ジェム</div>
              </div>
            </div>
          </div>
          <div class="small" style="padding-top:6px;">※ 10連合計の最大は 30,000円（SSR=3,000円×10）</div>
        </div>

        <div class="panel">
          <div class="panel-in">
            <div class="menuPopup">
              <div class="popupHead">
                <div>
                  <p class="popupTitle">最大30,000円 お年玉ガチャ！</p>
                  <div class="small">提供割合（同ランク内は等確率）</div>
                </div>
                <div class="dragonArt">
                  <img src="assets/dragon_spirit.png" alt="">
                </div>
              </div>

              <div class="rateBox">
                <div class="rateHead">
                  <span>提供割合</span>
                  <span class="small">（同ランク内は均等）</span>
                </div>
                <table class="rateTable">
                  <thead>
                    <tr>
                      <th style="width:32%;">レアリティ</th>
                      <th>金額</th>
                      <th style="width:20%;">確率</th>
                    </tr>
                  </thead>
                  <tbody id="rateTbody"></tbody>
                </table>
                <div class="rateNote">※ 同ランク内の金額は等確率（例：SRは1000円/2000円が1:1）</div>
              </div>

              <div class="bottomBar">
                <button class="btn btnBlue frame" id="btnOne">
                  <div class="btnMainText">
                    <b>1回ガチャ</b>
                    <span>1回：1000ジェム</span>
                  </div>
                  <div class="btnRight">
                    <span class="chip"><span class="miniGem"></span><span>-1000</span></span>
                  </div>
                </button>

                <button class="btn btnOrange frame" id="btnTen">
                  <div class="btnMainText">
                    <b>10連ガチャ</b>
                    <span>10回：10000ジェム</span>
                  </div>
                  <div class="btnRight">
                    <span class="stamp" id="tenStampMini" style="display:none;">SSR確定！</span>
                    <span class="chip"><span class="miniGem"></span><span>-10000</span></span>
                  </div>
                </button>

                <button class="btn btnDark frame" id="btnPay">
                  <div class="btnMainText">
                    <b>課金</b>
                    <span>10000ジェム（10000円）</span>
                  </div>
                  <div class="btnRight">
                    <span class="chip">+10000</span>
                  </div>
                </button>
              </div>
            </div>

            <div class="footer">
              <button class="resetBtn" id="btnReset">初期化（親PIN）</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sticky bonus notice (消えない) -->
      <div class="toastSticky" id="bonusToast">
        <div class="txt">
          <b>ログインボーナス</b>：<b>10,000ジェム</b>を受け取れます
        </div>
        <div class="actions">
          <button id="btnOpenBonus">受け取る</button>
        </div>
      </div>

      <!-- Overlay / Modal -->
      <div class="overlay" id="overlay" role="dialog" aria-modal="true">
        <div class="modal" id="modal">
          <div class="modalIn">
            <div class="modalTop">
              <div>
                <p class="modalTitle" id="modalTitle">ログインボーナス</p>
                <div class="modalSub" id="modalSub">初回限定：ジェム10,000個をプレゼント！</div>
              </div>
              <button class="modalClose" id="modalClose">閉じる</button>
            </div>

            <!-- BONUS -->
            <div id="bonusArea">
              <div class="bonusBox">
                <div class="gift"></div>
                <div>
                  <div class="bonusAmt">+10000 <span class="small">GEMS</span></div>
                  <div class="small">タップで受け取り → メニューに反映</div>
                  <div class="btnRow" style="justify-content:flex-start;margin-top:10px;">
                    <button class="btn btnPrimary" id="btnTakeBonus" style="min-width:220px;">受け取る</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- GACHA RESULT -->
            <div id="gachaArea" style="display:none; position:relative;">
              <div class="modalSub" id="openGuide">順番にタップして1枚ずつ開封（0.3秒クールダウン）</div>

              <!-- 10連開始の召喚陣 -->
              <div class="magicCircle" id="magicCircle"><div class="circle"></div></div>

              <!-- SSR確定スタンプ：中心ドン→右上 -->
              <div class="stampCenter" id="stampCenter">
                <img src="assets/ssr_stamp.png" alt="SSR確定！">
              </div>

              <div class="grid" id="grid"></div>

              <div class="sumBox" id="sumBox">
                <div class="sumLabel" id="sumLabel">合計は・・・・・・</div>
                <div class="sumMoney" id="sumMoney"></div>
                <div class="small" id="sumSub"></div>
                <div class="btnRow" style="margin-top:12px;">
                  <button class="btn btnPrimary" id="btnDone" style="min-width:220px;">OK</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Flash + Confetti -->
      <div class="flash" id="flash"></div>
      <canvas id="confetti"></canvas>

    </div>
  </div>

  <script>
    /***************
     * 設定
     ***************/
    const CFG = {
      PARENT_PIN: "2525",

      // ジェム
      COST_ONE: 1000,
      COST_TEN: 10000,
      BONUS_GEMS: 10000,
      PAY_GEMS: 10000,
      PAY_YEN: 10000,

      // 金額（同ランク内は等確率）
      POOL: {
        N: [10, 50, 100],
        R: [300, 500],
        SR: [1000, 2000],
        SSR: [3000]
      },

      // 提供割合（合計100%）
      // ※ここは前回のまま（必要なら後でいじれる）
      RATE: {
        SSR: 0.09,
        SR:  0.39,
        R:   0.35,
        N:   0.17
      },

      // 10連SSR確定は「初回のみ」
      TEN_GUARANTEE_SSR_FIRST_ONLY: true,

      // 連打防止
      TAP_COOLDOWN_MS: 300,
    };

    const LS = {
      loggedIn: "otg_login_v2",
      gems: "otg_gems_v2",
      bonusTaken: "otg_bonus_taken_v2",
      firstTenUsed: "otg_first_ten_used_v2"
    };

    const $ = (id)=>document.getElementById(id);
    const yen = (n)=> "¥" + Number(n).toLocaleString("ja-JP");

    function clamp0(n){ n = Number(n); return Number.isFinite(n) ? Math.max(0, n) : 0; }

    function isLoggedIn(){ return localStorage.getItem(LS.loggedIn) === "1"; }
    function setLoggedIn(){ localStorage.setItem(LS.loggedIn, "1"); }

    function getGems(){ return clamp0(localStorage.getItem(LS.gems) || 0); }
    function setGems(n){ localStorage.setItem(LS.gems, String(clamp0(n))); renderHeader(); }

    function bonusTaken(){ return localStorage.getItem(LS.bonusTaken) === "1"; }
    function setBonusTaken(){ localStorage.setItem(LS.bonusTaken, "1"); }

    function firstTenUsed(){ return localStorage.getItem(LS.firstTenUsed) === "1"; }
    function setFirstTenUsed(){ localStorage.setItem(LS.firstTenUsed, "1"); }

    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function pickRarity(){
      const r = Math.random();
      let acc = 0;
      const order = ["SSR","SR","R","N"];
      for(const k of order){
        acc += CFG.RATE[k];
        if (r <= acc) return k;
      }
      return "N";
    }

    function drawOne(forceRarity=null){
      const rar = forceRarity || pickRarity();
      const amt = pick(CFG.POOL[rar]);
      return { rar, amt };
    }

    /***************
     * 画面制御（スクロール封鎖込み）
     ***************/
    let savedScrollY = 0;
    function lockBody(){
      savedScrollY = window.scrollY || 0;
      document.body.classList.add("modal-open");
      document.body.style.top = `-${savedScrollY}px`;
    }
    function unlockBody(){
      document.body.classList.remove("modal-open");
      const top = document.body.style.top;
      document.body.style.top = "";
      const y = top ? Math.abs(parseInt(top,10)) : savedScrollY;
      window.scrollTo(0, y);
    }

    function showScreen(name){
      $("screenTitle").classList.remove("show");
      $("screenMenu").classList.remove("show");
      if(name==="title") $("screenTitle").classList.add("show");
      if(name==="menu") $("screenMenu").classList.add("show");
    }

    function openModal(mode){
      $("overlay").classList.add("show");
      lockBody();
      if(mode==="bonus"){
        $("modalTitle").textContent = "ログインボーナス";
        $("modalSub").textContent = "初回限定：ジェム10,000個をプレゼント！";
        $("bonusArea").style.display = "block";
        $("gachaArea").style.display = "none";
      }else{
        $("bonusArea").style.display = "none";
        $("gachaArea").style.display = "block";
      }
    }
    function closeModal(){
      $("overlay").classList.remove("show");
      unlockBody();
    }

    /***************
     * 提供割合UI
     ***************/
    function renderRate(){
      const rows = [
        {k:"SSR", dot:"ssr", money:"¥3,000", rate: CFG.RATE.SSR},
        {k:"SR",  dot:"sr",  money:"¥1,000 / ¥2,000", rate: CFG.RATE.SR},
        {k:"R",   dot:"r",   money:"¥300 / ¥500", rate: CFG.RATE.R},
        {k:"N",   dot:"n",   money:"¥10 / ¥50 / ¥100", rate: CFG.RATE.N},
      ];
      const tb = $("rateTbody");
      tb.innerHTML = "";
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><span class="dot ${r.dot}"></span><b>${r.k}</b></td>
          <td>${r.money}</td>
          <td>${(r.rate*100).toFixed(1)}%</td>
        `;
        tb.appendChild(tr);
      }
    }

    /***************
     * ログインボーナス通知（受け取るまで消えない）
     ***************/
    function updateBonusToast(){
      const shouldShow = isLoggedIn() && !bonusTaken();
      $("bonusToast").classList.toggle("show", shouldShow);
    }

    function takeBonus(){
      if (bonusTaken()) return;
      setBonusTaken();
      setGems(getGems() + CFG.BONUS_GEMS);   // ← 10,000ジェム付与
      updateBonusToast();
      closeModal();
      // 受け取った感（軽い演出）
      flash();
      vibrate(35);
      sfxSR();
    }

    /***************
     * 課金（確認 → 付与。実課金はしない）
     ***************/
    function doPay(){
      const ok = confirm(`${CFG.PAY_YEN.toLocaleString("ja-JP")}円がかかります。課金しますか？\n（※実際の課金はされません）`);
      if (!ok) return;
      setGems(getGems() + CFG.PAY_GEMS);
      flash();
      vibrate(35);
      sfxSR();
    }

    /***************
     * フラッシュ / バイブ
     ***************/
    function flash(){
      const el = $("flash");
      el.classList.remove("on");
      void el.offsetWidth;
      el.classList.add("on");
    }
    function vibrate(ms){
      try{ if (navigator.vibrate) navigator.vibrate(ms); }catch(e){}
    }

    /***************
     * SE（WebAudio）
     ***************/
    let audioCtx;
    function beep(freq=440, dur=0.08, type="sine", vol=0.12){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(audioCtx.destination);
        const t = audioCtx.currentTime;
        o.start(t);
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(vol, t + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
        o.stop(t + dur + 0.02);
      }catch(e){}
    }
    function sfxN(){ beep(220,0.05,"square",0.08); }
    function sfxR(){ beep(330,0.06,"square",0.10); }
    function sfxSR(){ beep(440,0.08,"sawtooth",0.12); setTimeout(()=>beep(554,0.09,"sawtooth",0.12),90); }
    function sfxSSR(){
      // ジャーン系 3音
      beep(523,0.12,"sawtooth",0.16);
      setTimeout(()=>beep(784,0.16,"sawtooth",0.16),150);
      setTimeout(()=>beep(1046,0.22,"sine",0.18),340);
    }
    function sfxSum(){
      beep(262,0.10,"square",0.10);
      setTimeout(()=>beep(330,0.10,"square",0.11),110);
      setTimeout(()=>beep(392,0.12,"square",0.12),240);
      setTimeout(()=>beep(523,0.14,"square",0.13),380);
    }

    /***************
     * 紙吹雪（Canvas）少行数で豪華
     ***************/
    const confetti = {
      running:false, parts:[], raf:0
    };
    function startConfetti(ms=1200){
      const cvs = $("confetti");
      const ctx = cvs.getContext("2d");
      const resize = ()=>{
        cvs.width = window.innerWidth * devicePixelRatio;
        cvs.height = window.innerHeight * devicePixelRatio;
        ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      };
      resize();
      window.addEventListener("resize", resize, {passive:true});
      cvs.classList.add("show");

      confetti.parts = [];
      const colors = ["#ffd54a","#ff8a2a","#00d9ff","#7c4dff","#ff005c","#ffffff"];
      for(let i=0;i<160;i++){
        confetti.parts.push({
          x: Math.random()*window.innerWidth,
          y: -20 - Math.random()*window.innerHeight*0.4,
          vx: (Math.random()-0.5)*3.2,
          vy: 2.0 + Math.random()*4.4,
          r: 2 + Math.random()*4,
          a: Math.random()*Math.PI*2,
          va: (Math.random()-0.5)*0.25,
          c: colors[(Math.random()*colors.length)|0],
          life: 1.0
        });
      }
      confetti.running = true;

      const t0 = performance.now();
      const tick = (t)=>{
        const dt = Math.min(32, t - (confetti.lastT||t));
        confetti.lastT = t;

        ctx.clearRect(0,0,window.innerWidth,window.innerHeight);
        for(const p of confetti.parts){
          p.x += p.vx * dt/16;
          p.y += p.vy * dt/16;
          p.a += p.va * dt/16;
          p.life -= dt/(ms*1.05);

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.a);
          ctx.globalAlpha = Math.max(0, p.life);
          ctx.fillStyle = p.c;
          ctx.fillRect(-p.r, -p.r*0.6, p.r*2, p.r*1.2);
          ctx.restore();
        }

        if (t - t0 < ms){
          confetti.raf = requestAnimationFrame(tick);
        }else{
          stopConfetti();
          window.removeEventListener("resize", resize);
        }
      };
      confetti.raf = requestAnimationFrame(tick);
    }

    function stopConfetti(){
      confetti.running = false;
      cancelAnimationFrame(confetti.raf);
      $("confetti").classList.remove("show");
      const ctx = $("confetti").getContext("2d");
      ctx.clearRect(0,0,$("confetti").width,$("confetti").height);
    }

    /***************
     * ガチャ処理
     ***************/
    function requireGems(cost){
      if (getGems() < cost){
        alert("ジェムが足りません");
        return false;
      }
      return true;
    }

    /***************
     * カードUI：順番強制 + フリップ + 溜め
     ***************/
    let tapLocked = false;
    let lastTapAt = 0;
    function canTap(){
      const now = Date.now();
      if (tapLocked) return false;
      if (now - lastTapAt < CFG.TAP_COOLDOWN_MS) return false;
      lastTapAt = now;
      return true;
    }
    function lockFor(ms){
      tapLocked = true;
      setTimeout(()=>tapLocked = false, ms);
    }

    function makeCard(i, total){
      const slot = document.createElement("div");
      slot.className = "cardSlot n";
      slot.dataset.index = String(i);
      slot.dataset.opened = "0";
      slot.innerHTML = `
        <div class="idxTxt">${i+1}/${total}</div>
        <div class="cardInner">
          <div class="face back">
            <div class="tapBadge">TAP</div>
          </div>
          <div class="face front">
            <div class="charLayer">
              <img class="charImg" alt="">
            </div>
            <div class="aura"></div>
            <div class="spark"></div>
            <div class="charge"></div>
            <div class="ssrCrack"></div>
            <div class="ssrLight"></div>
            <div class="rarTxt">-</div>
            <div class="amtTxt">-</div>
          </div>
        </div>
      `;
      return slot;
    }

    function setRarityClass(slot, rar){
      slot.classList.remove("n","r","sr","ssr");
      slot.classList.add(rar==="SSR"?"ssr":rar==="SR"?"sr":rar==="R"?"r":"n");
    }

    function setChar(slot, rar){
      // SSRだけ：3枚合成表示（dragon_spirit + summoner + spiritを重ねる）
      // ※画像は既存3枚しかないのでCSS重ねで合成っぽく見せる
      const layer = slot.querySelector(".charLayer");
      const img = layer.querySelector(".charImg");

      if (rar === "SSR"){
        slot.classList.add("hasChar");
        img.src = "assets/dragon_spirit.png";
        img.style.opacity = "0.34";
      }else{
        slot.classList.remove("hasChar");
        img.removeAttribute("src");
      }
    }

    function applyShakeByRarity(rar){
      const modal = $("modal");
      modal.classList.remove("shake","shake-strong");
      void modal.offsetWidth;

      if (rar === "SSR"){
        modal.classList.add("shake-strong");
      }else if (rar === "SR"){
        modal.classList.add("shake");
      }
      // R/Nは無し
    }

    async function reveal(slot, res){
      // 溜め
      slot.classList.add("charging");
      flash();
      if (res.rar === "SSR") vibrate(30);
      await new Promise(r=>setTimeout(r, 250));
      slot.classList.remove("charging");

      // flip
      slot.classList.add("revealed");
      slot.dataset.opened = "1";

      setRarityClass(slot, res.rar);
      setChar(slot, res.rar);

      const rarEl = slot.querySelector(".rarTxt");
      const amtEl = slot.querySelector(".amtTxt");
      rarEl.textContent = res.rar;
      amtEl.textContent = yen(res.amt);

      // SSR crack/light
      if (res.rar === "SSR"){
        slot.classList.add("ssr-reveal");
      }

      // sfx + shake
      applyShakeByRarity(res.rar);
      if (res.rar === "SSR") sfxSSR();
      else if (res.rar === "SR") sfxSR();
      else if (res.rar === "R") sfxR();
      else sfxN();
    }

    async function showSum(total, count){
      const box = $("sumBox");
      const money = $("sumMoney");
      const sub = $("sumSub");

      box.classList.add("show");

      // “溜め” 表示（ここで0円は出さない）
      money.textContent = "";
      sub.textContent = "";

      // 溜め
      await new Promise(r=>setTimeout(r, 650));

      // フラッシュ + 紙吹雪 + 振動
      flash();
      startConfetti(1400);
      vibrate(60);
      sfxSum();

      // カウンターアップ
      const from = 0;
      const to = total;
      const dur = 650;
      const t0 = performance.now();
      money.classList.remove("pop");
      const step = (t)=>{
        const p = Math.min(1, (t - t0)/dur);
        const v = Math.floor(from + (to-from) * (1 - Math.pow(1-p, 3)));
        money.textContent = yen(v);
        if (p < 1) requestAnimationFrame(step);
        else{
          money.textContent = yen(to);
          money.classList.add("pop");
        }
      };
      requestAnimationFrame(step);

      sub.textContent = `開封数：${count} / 最大合計：${yen(30000)}`;
      $("btnDone").disabled = false;
    }

    async function gachaOpenUI(mode, results, withFirstTenGuaranteeStamp){
      openModal("gacha");

      $("sumBox").classList.remove("show");
      $("btnDone").disabled = true;

      // スタンプミニ表示（メニュー側）
      $("tenStampMini").style.display = withFirstTenGuaranteeStamp ? "inline-flex" : "none";

      // 10連開始：召喚陣
      if (mode==="ten"){
        $("magicCircle").classList.add("show");
        setTimeout(()=> $("magicCircle").classList.remove("show"), 1050);
      }else{
        $("magicCircle").classList.remove("show");
      }

      // SSR確定スタンプ：初回10連だけ「中心ドン→右上」
      if (mode==="ten" && withFirstTenGuaranteeStamp){
        $("stampCenter").classList.add("show");
        setTimeout(()=> $("stampCenter").classList.remove("show"), 1100);
      }else{
        $("stampCenter").classList.remove("show");
      }

      // カード生成
      const grid = $("grid");
      grid.innerHTML = "";
      const total = results.length;
      const slots = [];
      for(let i=0;i<total;i++){
        const s = makeCard(i,total);
        grid.appendChild(s);
        slots.push(s);
      }

      // 開封順強制：nextIndex以外は押せない
      let nextIndex = 0;
      const refreshLocks = ()=>{
        slots.forEach((s, idx)=>{
          const disabled = idx !== nextIndex || s.dataset.opened==="1";
          s.classList.toggle("disabled", disabled);
        });
      };
      refreshLocks();

      let opened = 0;
      let sum = 0;

      // 虹フラグ（UIだけ匂わせ）：SSRが含まれる場合、最初のSSR直前に一瞬フラッシュ増やす
      const firstSsrIndex = results.findIndex(x=>x.rar==="SSR");
      let rainbowDone = false;

      for(const s of slots){
        s.addEventListener("click", async ()=>{
          if (!canTap()) return;
          const idx = Number(s.dataset.index);
          if (idx !== nextIndex) return; // 順番以外は不可

          // 虹匂わせ（文言なし）
          if (!rainbowDone && firstSsrIndex !== -1 && idx === firstSsrIndex){
            rainbowDone = true;
            flash();
            beep(659,0.10,"sawtooth",0.12);
            lockFor(420);
            await new Promise(r=>setTimeout(r, 220));
          }

          lockFor(CFG.TAP_COOLDOWN_MS);

          const res = results[idx];
          await reveal(s, res);

          opened += 1;
          sum += res.amt;

          nextIndex += 1;
          refreshLocks();

          if (opened === total){
            await showSum(sum, opened);
          }
        }, {passive:true});
      }

      $("btnDone").onclick = ()=> closeModal();
      $("btnDone").disabled = true;
    }

    function doOne(){
      if (!requireGems(CFG.COST_ONE)) return;
      setGems(getGems() - CFG.COST_ONE);
      gachaOpenUI("one", [drawOne()], false);
    }

    function doTen(){
      if (!requireGems(CFG.COST_TEN)) return;
      setGems(getGems() - CFG.COST_TEN);

      const results = [];
      for(let i=0;i<10;i++) results.push(drawOne());

      // 初回10連のみ SSR確定（最低1枚）
      const isFirstTen = !firstTenUsed();
      if (CFG.TEN_GUARANTEE_SSR_FIRST_ONLY && isFirstTen){
        const hasSSR = results.some(x=>x.rar==="SSR");
        if (!hasSSR){
          const idx = Math.floor(Math.random()*10);
          results[idx] = drawOne("SSR");
        }
        setFirstTenUsed();
      }

      gachaOpenUI("ten", results, CFG.TEN_GUARANTEE_SSR_FIRST_ONLY && isFirstTen);
    }

    /***************
     * 初期化（親PIN）
     ***************/
    function resetAll(){
      const pin = prompt("親PINを入力してください");
      if (pin === null) return;
      if (pin !== CFG.PARENT_PIN){
        alert("PINが違います");
        return;
      }
      localStorage.removeItem(LS.loggedIn);
      localStorage.removeItem(LS.gems);
      localStorage.removeItem(LS.bonusTaken);
      localStorage.removeItem(LS.firstTenUsed);
      location.reload();
    }

    /***************
     * 表示更新
     ***************/
    function renderHeader(){
      $("gems").textContent = getGems();
      $("btnOne").disabled = getGems() < CFG.COST_ONE;
      $("btnTen").disabled = getGems() < CFG.COST_TEN;
    }

    /***************
     * 初期化
     ***************/
    function init(){
      renderRate();

      if (!isLoggedIn()){
        showScreen("title");
      }else{
        showScreen("menu");
      }

      renderHeader();
      updateBonusToast();

      $("btnLogin").addEventListener("click", ()=>{
        setLoggedIn();
        showScreen("menu");
        renderHeader();
        updateBonusToast(); // 受け取るまで消えない
      });

      $("btnOpenBonus").addEventListener("click", ()=>{
        openModal("bonus");
      });
      $("btnTakeBonus").addEventListener("click", takeBonus);

      $("btnOne").addEventListener("click", doOne);
      $("btnTen").addEventListener("click", doTen);

      $("btnPay").addEventListener("click", doPay);

      $("btnReset").addEventListener("click", resetAll);

      $("modalClose").addEventListener("click", closeModal);
      $("overlay").addEventListener("click", (e)=>{
        if (e.target === $("overlay")) closeModal();
      });
    }

    init();
  </script>
</body>
</html>
