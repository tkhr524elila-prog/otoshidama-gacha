<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070b18">
  <title>最大30000円 お年玉ガチャ！</title>

  <style>
    :root{
      --bg0:#050816; --bg1:#090d22; --bg2:#140a2b;
      --text:#eef3ff; --muted:#a9b4da;
      --line:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius:18px;

      --n:#9aa6c8;
      --r:#4be3ff;
      --sr:#ff8a2a;
      --ssr:#ffd54a;
      --ssr2:#ff4bd6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(124,77,255,.35), transparent 60%),
        radial-gradient(900px 550px at 95% 25%, rgba(75,227,255,.18), transparent 55%),
        radial-gradient(900px 650px at 55% 110%, rgba(255,122,0,.20), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
      min-height:100%;
      padding: calc(12px + env(safe-area-inset-top)) 12px calc(16px + env(safe-area-inset-bottom));
      overflow-x:hidden;
    }

    .wrap{max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
    .card{
      border:1px solid var(--line);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.18));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .in{padding:14px}

    /* top gems */
    .topRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .gemBox{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      box-shadow: 0 14px 40px rgba(0,0,0,.38);
      min-width: 200px;
    }
    .gemIcon{
      width:18px;height:18px;border-radius:6px;
      background: conic-gradient(from 160deg, #4be3ff, #7c4dff, #ff7a00, #4be3ff);
      box-shadow: 0 0 16px rgba(75,227,255,.25);
      transform: rotate(12deg);
      flex:0 0 auto;
    }
    .gemNum{font-weight:1100}
    .gemSmall{font-size:11px;color:var(--muted)}

    /* title */
    .title{font-weight:1300;letter-spacing:.03em;font-size:18px;margin-top:10px}
    .sub{font-size:12px;color:var(--muted);line-height:1.45;margin-top:6px}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      font-size:12px;font-weight:1000;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
    }

    /* rate table */
    .rateTitle{font-size:12px;color:var(--muted);font-weight:1000}
    .rateTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0 8px;
      margin-top:10px;
      font-size:13px;
    }
    .rateRow{
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
    }
    .rateTable td{padding:10px 10px;vertical-align:middle}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:1100;letter-spacing:.04em;text-transform:uppercase;
      min-width: 86px;justify-content:center;
    }
    .dot{width:8px;height:8px;border-radius:999px}
    .cN .dot{background:var(--n)}
    .cR .dot{background:var(--r)}
    .cSR .dot{background:var(--sr)}
    .cSSR .dot{background: linear-gradient(135deg, var(--ssr), var(--ssr2)); box-shadow:0 0 14px rgba(255,213,74,.25)}
    .vals{font-weight:1100}
    .rightText{color:var(--muted);font-size:12px;text-align:right}
    .noteSmall{font-size:11px;color:var(--muted);margin-top:8px;line-height:1.45}

    /* main start button */
    .startBtn{
      border:0;cursor:pointer;
      border-radius: 20px;
      padding: 16px 16px;
      font-weight:1300;
      letter-spacing:.02em;
      background: linear-gradient(180deg, #ffd54a, #ff7a00);
      color:#081022;
      box-shadow: 0 18px 40px rgba(255,122,0,.22);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      user-select:none;-webkit-tap-highlight-color: transparent;
    }
    .startBtn:active{transform:scale(.99)}
    .startSub{font-size:12px;font-weight:1100;opacity:.9}

    /* overlay base */
    .overlay{
      position:fixed;inset:0;
      background: rgba(0,0,0,.80);
      display:none;
      padding: 12px;
      z-index:80;
    }
    .overlay.show{display:block}

    .modal{
      max-width: 860px;
      margin: 0 auto;
      border-radius: 24px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(700px 420px at 28% 10%, rgba(124,77,255,.35), transparent 60%),
        radial-gradient(700px 420px at 75% 90%, rgba(75,227,255,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.22));
      box-shadow: 0 30px 110px rgba(0,0,0,.70);
      overflow:hidden;
    }

    /* IMPORTANT: modal internal scroll (iPhone) */
    .modalScroll{
      max-height: calc(100vh - 24px);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modalTop{
      padding: 14px 14px 0;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .mTitle{font-weight:1300}
    .mSub{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .xbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1200;
      cursor:pointer;
      flex:0 0 auto;
    }

    /* action sheet (1 / 10) */
    .sheet{
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .btn{
      border:0;cursor:pointer;
      border-radius: 18px;
      padding: 14px 14px;
      font-weight:1300;
      letter-spacing:.02em;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      box-shadow: 0 14px 34px rgba(0,0,0,.35);
      user-select:none;-webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform:scale(.99)}
    .btn[disabled]{opacity:.45;cursor:not-allowed;filter:saturate(.75)}
    .b1{background: linear-gradient(180deg, rgba(75,227,255,.95), rgba(124,77,255,.95)); color:#081022}
    .b10{background: linear-gradient(180deg, #ffd54a, #ff7a00); color:#081022; position:relative; overflow:hidden}
    .cost{
      display:inline-flex;align-items:center;gap:6px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.18);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:1300;
      color: rgba(10,14,25,.92);
    }
    .miniGem{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,#4be3ff,#7c4dff)}
    /* stamp moved (no overlap) */
    .stamp{
      position:absolute; left:12px; top:10px;
      transform: rotate(-10deg);
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:1400;
      border:1px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.20);
      color:#0b1022;
      box-shadow: 0 10px 26px rgba(255,122,0,.22);
      pointer-events:none;
    }

    /* opening area */
    .openArea{padding: 6px 14px 14px}
    .tapHint{
      text-align:center;
      color:var(--muted);
      font-size:12px;
      margin: 8px 0 8px;
      min-height: 18px;
    }
    .cards{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
      margin-top: 10px;
    }
    @media(min-width:520px){ .cards{grid-template-columns: repeat(3, 1fr);} }
    @media(min-width:720px){ .cards{grid-template-columns: repeat(5, 1fr);} }

    .gcard{
      position:relative;
      height: 104px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      transform: translateZ(0);
    }
    .gcard.back{cursor:pointer;user-select:none;-webkit-tap-highlight-color: transparent;}
    .gcard.back::before{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg, rgba(255,255,255,.0), rgba(255,255,255,.18), rgba(255,255,255,.0));
      animation: spin 1.25s linear infinite;
      opacity: .55;
      mix-blend-mode: screen;
    }
    .gcard.back::after{
      content:"";
      position:absolute; inset:10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(0,0,0,.18) 70%);
    }
    .cardNum{
      position:absolute;left:10px;top:10px;
      font-size:11px;color:rgba(255,255,255,.75);font-weight:1100;z-index:2;
    }

    /* TAP text: show ONLY before open */
    .tap{
      z-index:2;
      font-weight:1300;
      letter-spacing:.06em;
      color: rgba(255,255,255,.92);
      text-shadow: 0 8px 20px rgba(0,0,0,.55);
    }
    .gcard.opened .tap{display:none;} /* ✅消す */

    /* revealed face */
    .face{
      position:absolute;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:6px;
      opacity:0;transform: scale(.98);
      transition: opacity .18s ease, transform .18s ease;
      padding:10px;text-align:center;
    }
    .gcard.opened .face{opacity:1;transform:scale(1)}
    .rarTag{font-size:12px;font-weight:1400;letter-spacing:.10em}
    .amt{font-size:22px;font-weight:1500;letter-spacing:.02em;line-height:1.0}

    /* frame by rarity */
    .gcard.rN{border-color: rgba(154,166,200,.45)}
    .gcard.rR{border-color: rgba(75,227,255,.55); box-shadow: 0 14px 46px rgba(75,227,255,.12), 0 14px 40px rgba(0,0,0,.35)}
    .gcard.rSR{border-color: rgba(255,138,42,.60); box-shadow: 0 14px 50px rgba(255,138,42,.13), 0 14px 40px rgba(0,0,0,.35)}
    .gcard.rSSR{
      border-color: rgba(255,213,74,.70);
      box-shadow: 0 16px 70px rgba(255,213,74,.18), 0 14px 40px rgba(0,0,0,.35);
    }

    /* rainbow omen */
    .omen{
      position:absolute;left:10px;right:10px;bottom:10px;height:10px;border-radius:999px;
      background: linear-gradient(90deg, #ff4bd6, #ffd54a, #4be3ff, #7c4dff, #ff7a00);
      opacity:0;
      box-shadow: 0 0 16px rgba(255,213,74,.14);
      transition: opacity .18s ease;
      z-index:2;
    }
    .omen.show{opacity:1}

    /* total reveal */
    .totalArea{
      margin-top: 14px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding: 14px;
      overflow:hidden;
      position:relative;
      display:none;
    }
    .totalArea.show{display:block}
    .totalTitle{color:var(--muted);font-size:12px;font-weight:1000}
    .totalMoney{margin-top:8px;font-size:42px;font-weight:1500;letter-spacing:.02em;line-height:1.05}
    .totalRank{
      margin-top:10px;
      display:inline-flex;align-items:center;gap:8px;
      padding: 8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-weight:1200;letter-spacing:.08em;
    }
    .totalFx{
      position:absolute; inset:-60%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.45),
        rgba(255,214,0,.50),
        rgba(75,227,255,.45),
        rgba(124,77,255,.45),
        rgba(255,122,0,.50),
        rgba(255,0,92,.45),
        rgba(255,0,92,.0)
      );
      opacity:0;
      animation: spin 1.2s linear infinite;
      mix-blend-mode: screen;
      filter: blur(12px) saturate(1.2);
      pointer-events:none;
      transition: opacity .2s ease;
    }
    .totalArea.ssr .totalFx{opacity:.95}
    .totalFlash{position:absolute;inset:0;background:rgba(255,255,255,1);opacity:0;pointer-events:none}
    .totalArea.boom .totalFlash{animation: flash .55s ease}
    .totalArea.boom .totalMoney{animation: pop 700ms cubic-bezier(.2,.9,.2,1) both}
    @keyframes pop{0%{transform:scale(.92);opacity:.0}20%{transform:scale(1.08);opacity:1}100%{transform:scale(1);opacity:1}}
    @keyframes spin{to{transform: rotate(360deg)}}
    @keyframes flash{0%{opacity:0}12%{opacity:.95}100%{opacity:0}}

    /* toast bonus */
    .toast{
      position:fixed;left:12px;right:12px;
      top: calc(12px + env(safe-area-inset-top));
      max-width:900px;margin:0 auto;
      z-index:90;
      display:none;
    }
    .toast.show{display:block}
    .toastIn{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.34);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      padding:12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .toastTitle{font-weight:1200}
    .toastSub{font-size:12px;color:var(--muted);margin-top:2px}
    .toastBtn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      color:var(--text);
      border-radius:999px;
      padding:10px 12px;
      font-weight:1200;
      cursor:pointer;
      flex:0 0 auto;
    }
  </style>
</head>

<body>

  <!-- login bonus toast -->
  <div class="toast" id="toast">
    <div class="toastIn">
      <div>
        <div class="toastTitle">ログインボーナスが届きました！</div>
        <div class="toastSub">タップで「ジェム3,000個」を受け取る</div>
      </div>
      <button class="toastBtn" id="toastBtn">受け取る</button>
    </div>
  </div>

  <div class="wrap">

    <div class="card">
      <div class="in">
        <div class="topRow">
          <div class="gemBox">
            <div class="gemIcon"></div>
            <div>
              <div class="gemNum"><span id="gems">0</span> <span class="gemSmall">GEMS</span></div>
              <div class="gemSmall">所持ジェム</div>
            </div>
          </div>
        </div>

        <div class="title">最大30000円 お年玉ガチャ！</div>
        <div class="sub">
          SSR=3,000円。10連の合計最大は30,000円（SSR×10）。<br>
          まずはログインボーナスを受け取って回そう。
        </div>

        <div class="chipRow">
          <div class="chip">1回：300ジェム</div>
          <div class="chip">10連：3000ジェム（SSR確定）</div>
          <div class="chip">タップ受付：0.3秒クールダウン</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="in">
        <div class="rateTitle">提供割合</div>
        <table class="rateTable" aria-label="提供割合">
          <tr class="rateRow">
            <td><span class="pill cSSR"><span class="dot"></span>SSR</span></td>
            <td class="vals">3,000円</td>
            <td class="rightText">（10連はSSR確定）</td>
          </tr>
          <tr class="rateRow">
            <td><span class="pill cSR"><span class="dot"></span>SR</span></td>
            <td class="vals">1,000 / 2,000円</td>
            <td class="rightText">同ランク内は均等</td>
          </tr>
          <tr class="rateRow">
            <td><span class="pill cR"><span class="dot"></span>R</span></td>
            <td class="vals">300 / 500円</td>
            <td class="rightText">同ランク内は均等</td>
          </tr>
          <tr class="rateRow">
            <td><span class="pill cN"><span class="dot"></span>N</span></td>
            <td class="vals">10 / 50 / 100円</td>
            <td class="rightText">同ランク内は均等</td>
          </tr>
        </table>
        <div class="noteSmall" id="rateNote"></div>
      </div>
    </div>

    <button class="startBtn" id="startBtn">
      <div>
        <div>ガチャ開始</div>
        <div class="startSub">1回 or SSR確定10連 を選ぶ</div>
      </div>
      <div>▶</div>
    </button>

  </div>

  <!-- overlay -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalScroll">
        <div class="modalTop">
          <div>
            <div class="mTitle" id="mTitle">ガチャ</div>
            <div class="mSub" id="mSub">—</div>
          </div>
          <button class="xbtn" id="closeX">閉じる</button>
        </div>

        <!-- choose area -->
        <div class="sheet" id="sheet">
          <button class="btn b1" id="oneBtn">
            <span>1回ガチャ</span>
            <span class="cost"><span class="miniGem"></span>300</span>
          </button>

          <button class="btn b10" id="tenBtn">
            <span>SSR確定！10連ガチャ</span>
            <span class="cost"><span class="miniGem"></span>3000</span>
            <span class="stamp">SSR確定！</span>
          </button>
        </div>

        <!-- opening area -->
        <div class="openArea" id="openArea" style="display:none;">
          <div class="tapHint" id="tapHint">—</div>
          <div class="cards" id="cards"></div>

          <div class="totalArea" id="totalArea">
            <div class="totalFx"></div>
            <div class="totalFlash"></div>
            <div class="totalTitle" id="totalTitle">合計は……</div>
            <div class="totalMoney" id="totalMoney">¥0</div>
            <div class="totalRank" id="totalRank">READY</div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
/** ========= 設定 ========= */
const CFG = {
  BONUS_GEMS: 3000,

  COST_ONE: 300,
  COST_TEN: 3000,

  MAX_TOTAL: 30000,
  TAP_COOLDOWN_MS: 300,

  // 親PIN（開発用）
  PARENT_PIN: "2525",

  // ランク確率（同ランク内は均等）
  // 期待値は「それっぽく」1回あたり約1,000円寄せ（※微調整は後でOK）
  P_RANK_ONE: { N:0.28, R:0.20, SR:0.43, SSR:0.09 },

  AMOUNTS: {
    N: [10,50,100],
    R: [300,500],
    SR:[1000,2000],
    SSR:[3000]
  }
};

const LS = {
  gems: "otg_gems_v3",
  bonusTaken: "otg_bonus_taken_v3"
};

const $ = (id)=>document.getElementById(id);
const yen = (n)=>"¥"+Number(n).toLocaleString("ja-JP");

/** ========= 永続化 ========= */
function getGems(){
  const n = Number(localStorage.getItem(LS.gems));
  return Number.isFinite(n) ? n : 0;
}
function setGems(n){
  localStorage.setItem(LS.gems, String(n));
  render();
}
function bonusTaken(){
  return localStorage.getItem(LS.bonusTaken)==="1";
}
function setBonusTaken(){
  localStorage.setItem(LS.bonusTaken,"1");
}

/** ========= 期待値/表示 ========= */
function avg(arr){ return arr.reduce((s,x)=>s+x,0)/arr.length; }
function calcEV(){
  const p = CFG.P_RANK_ONE;
  return p.N*avg(CFG.AMOUNTS.N) + p.R*avg(CFG.AMOUNTS.R) + p.SR*avg(CFG.AMOUNTS.SR) + p.SSR*avg(CFG.AMOUNTS.SSR);
}
function pct(x){ return (x*100).toFixed(2).replace(/\.00$/,"")+"%"; }
function renderRateNote(){
  const p = CFG.P_RANK_ONE;
  $("rateNote").innerHTML =
    `【1回の提供割合】N:${pct(p.N)} / R:${pct(p.R)} / SR:${pct(p.SR)} / SSR:${pct(p.SSR)}（同ランク内は均等）<br>`+
    `期待値（参考）：<b>${yen(Math.round(calcEV()))}</b> / 1回`;
}

/** ========= 抽選（ランク→同ランク内均等） ========= */
function pickRank(){
  const r = Math.random();
  const p = CFG.P_RANK_ONE;
  let acc = 0;
  acc += p.SSR; if (r <= acc) return "SSR";
  acc += p.SR;  if (r <= acc) return "SR";
  acc += p.R;   if (r <= acc) return "R";
  return "N";
}
function pickAmountByRank(rank){
  const a = CFG.AMOUNTS[rank];
  return a[Math.floor(Math.random()*a.length)];
}
function pickOne(){
  const rank = pickRank();
  return { rar: rank, amt: pickAmountByRank(rank) };
}

/** ========= 音/バイブ（軽め） ========= */
let audioCtx;
function beep(seq){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const t0 = audioCtx.currentTime + 0.01;
    seq.forEach(s=>{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = s.type || "sine";
      o.frequency.value = s.f;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(t0 + s.at);
      g.gain.setValueAtTime(0.0001, t0 + s.at);
      g.gain.exponentialRampToValueAtTime(s.v || 0.12, t0 + s.at + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t0 + s.at + s.d);
      o.stop(t0 + s.at + s.d + 0.03);
    });
  }catch(e){}
}
function vibe(ms){ if (navigator.vibrate) navigator.vibrate(ms); }
const SFX = {
  click(){ beep([{at:0,f:260,d:0.08,v:0.07,type:"square"}]); },
  flip(){ beep([{at:0,f:330,d:0.08,v:0.07,type:"sine"}]); },
  omen(){ beep([{at:0,f:523.25,d:0.10,v:0.10,type:"triangle"},{at:0.11,f:659.25,d:0.12,v:0.11,type:"triangle"}]); },
  ssr(){ beep([{at:0,f:523.25,d:0.16,v:0.14,type:"sawtooth"},{at:0.18,f:783.99,d:0.20,v:0.16,type:"sawtooth"}]); },
  total(){ beep([{at:0,f:392,d:0.12,v:0.12,type:"square"},{at:0.12,f:523.25,d:0.12,v:0.12,type:"square"}]); },
  bonus(){ beep([{at:0,f:523.25,d:0.12,v:0.10,type:"square"},{at:0.12,f:659.25,d:0.12,v:0.11,type:"square"}]); }
};

/** ========= UI（モーダル） ========= */
let current = null; // {mode, pulls[], idx, opened[], total, cooldownUntil}
let omenShown = false;

function openOverlay(){
  $("overlay").classList.add("show");
}
function closeOverlay(){
  $("overlay").classList.remove("show");
  // 開封中状態を閉じたらリセット
  current = null;
  $("openArea").style.display = "none";
  $("sheet").style.display = "grid";
}
function setHint(t){ $("tapHint").textContent = t; }

function rankLabelTotal(total){
  if (total >= 30000) return "SSR（MAX）";
  if (total >= 20000) return "SR";
  if (total >= 10000) return "R";
  return "N";
}

/** cards */
function makeCard(i){
  const el = document.createElement("div");
  el.className = "gcard back";
  el.dataset.index = String(i);

  const num = document.createElement("div");
  num.className = "cardNum";
  num.textContent = (i+1)+"/10";
  el.appendChild(num);

  const tap = document.createElement("div");
  tap.className = "tap";
  tap.textContent = "TAP";
  el.appendChild(tap);

  const omen = document.createElement("div");
  omen.className = "omen";
  omen.id = "omen-"+i;
  el.appendChild(omen);

  const face = document.createElement("div");
  face.className = "face";

  const tag = document.createElement("div");
  tag.className = "rarTag";
  tag.id = "tag-"+i;

  const amt = document.createElement("div");
  amt.className = "amt";
  amt.id = "amt-"+i;

  face.appendChild(tag);
  face.appendChild(amt);
  el.appendChild(face);

  el.addEventListener("click", onCardTap);
  return el;
}

function colorByRar(r){
  if (r==="SSR") return "var(--ssr)";
  if (r==="SR") return "var(--sr)";
  if (r==="R") return "var(--r)";
  return "var(--n)";
}

/** SSR予兆：次がSSRなら虹バー */
function maybeShowOmen(nextIndex){
  if (!current || omenShown) return;
  if (current.mode !== "TEN") return;
  const next = current.pulls[nextIndex];
  if (next && next.rar === "SSR"){
    omenShown = true;
    const el = $("omen-"+nextIndex);
    if (el){
      el.classList.add("show");
      setHint("……虹の気配（次、SSR…？）");
      SFX.omen(); vibe(40);
      setTimeout(()=>{
        el.classList.remove("show");
        setHint("カードをタップして開封");
      }, 900);
    }
  }
}

async function onCardTap(e){
  if (!current) return;

  const now = Date.now();
  if (now < current.cooldownUntil) return; // 0.3秒クールダウン
  current.cooldownUntil = now + CFG.TAP_COOLDOWN_MS;

  const idx = Number(e.currentTarget.dataset.index);
  if (!Number.isFinite(idx)) return;

  // 順番通りに開封
  if (idx !== current.idx){
    setHint("順番に開封してね（次は "+(current.idx+1)+" 枚目）");
    SFX.click();
    return;
  }

  const cardEl = e.currentTarget;
  if (current.opened[idx]) return;

  maybeShowOmen(idx);

  const pull = current.pulls[idx];
  current.opened[idx] = true;

  await revealCard(cardEl, pull, idx);

  current.total += pull.amt;
  if (current.total > CFG.MAX_TOTAL) current.total = CFG.MAX_TOTAL;

  current.idx += 1;

  if (current.idx >= 10){
    await totalReveal(current.total);
  }else{
    setHint("次のカードをタップ（"+(current.idx+1)+"/10）");
  }
}

function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

async function revealCard(cardEl, pull, idx){
  cardEl.classList.remove("back");
  cardEl.classList.add("opened","r"+pull.rar);

  SFX.flip(); vibe(15);

  $("tag-"+idx).textContent = pull.rar;
  $("tag-"+idx).style.color = colorByRar(pull.rar);
  $("amt-"+idx).textContent = yen(pull.amt);

  if (pull.rar==="SSR"){
    // SSRはちょい派手（ここは後でさらに強化できる）
    SFX.ssr(); vibe(110);
    cardEl.animate(
      [{transform:"scale(1)"},{transform:"scale(1.08)"},{transform:"scale(1)"}],
      {duration:520,easing:"cubic-bezier(.2,.9,.2,1)"}
    );
  }
}

async function totalReveal(total){
  setHint("……合計は…………");
  await wait(650);

  const area = $("totalArea");
  area.className = "totalArea show";
  $("totalMoney").textContent = "……";
  $("totalRank").textContent = "—";
  $("totalTitle").textContent = "合計は…………";

  await wait(520);

  const label = rankLabelTotal(total);
  if (total >= 30000) area.classList.add("ssr");
  area.classList.add("boom");
  $("totalMoney").textContent = yen(total);
  $("totalRank").textContent = label;
  SFX.total(); vibe(total >= 30000 ? 180 : 90);

  setHint("結果確定！「閉じる」で戻る");
}

/** ========= ガチャ開始 ========= */
function startOpen(mode, pulls){
  current = {
    mode,
    pulls,
    idx:0,
    opened: Array(10).fill(false),
    total:0,
    cooldownUntil:0
  };
  omenShown = false;

  $("sheet").style.display = "none";
  $("openArea").style.display = "block";

  $("cards").innerHTML = "";
  for(let i=0;i<10;i++){
    $("cards").appendChild(makeCard(i));
  }

  $("totalArea").className = "totalArea";
  $("totalArea").style.display = "none";
  $("totalMoney").textContent = yen(0);
  $("totalRank").textContent = "READY";

  $("mTitle").textContent = mode==="TEN" ? "SSR確定！10連ガチャ" : "1回ガチャ（開封）";
  $("mSub").textContent = "1枚ずつタップで開封 → 最後に合計発表";
  setHint("カードをタップして開封（0.3秒クールダウン）");
}

function ensureGems(cost){
  if (getGems() < cost){
    alert("ジェムが足りません");
    return false;
  }
  setGems(getGems() - cost);
  return true;
}

function doOne(){
  if (!ensureGems(CFG.COST_ONE)) return;
  // 1回でもUIは10枠表示（1枠だけ本物、残りは0円ダミー）
  const p = pickOne();
  const pulls = [p, ...Array.from({length:9}, ()=>({rar:"N",amt:0}))];
  startOpen("ONE", pulls);
}

function doTen(){
  if (!ensureGems(CFG.COST_TEN)) return;

  // 10連：SSR確定（最低1枚はSSR）
  const pulls = Array.from({length:10}, ()=>pickOne());

  // SSRが1枚も無ければ、ランダム位置をSSRに置換
  if (!pulls.some(x=>x.rar==="SSR")){
    const pos = Math.floor(Math.random()*10);
    pulls[pos] = {rar:"SSR", amt:3000};
  }
  startOpen("TEN", pulls);
}

/** ========= ログインボーナス（通知→タップ受取） ========= */
function showToast(){ $("toast").classList.add("show"); }
function hideToast(){ $("toast").classList.remove("show"); }

function openBonusFlow(){
  const ok = confirm("ログインボーナス：ジェム3,000個を受け取りますか？");
  if (!ok) return;
  if (bonusTaken()){
    alert("ログインボーナスは受け取り済みです");
    hideToast();
    return;
  }
  setBonusTaken();
  setGems(getGems() + CFG.BONUS_GEMS);
  SFX.bonus(); vibe(55);
  hideToast();
  alert("ジェム3,000個を受け取りました！");
}

/** ========= 初期化 ========= */
function resetAll(){
  const pin = prompt("親PINを入力してください");
  if (pin===null) return;
  if (pin !== CFG.PARENT_PIN){
    alert("PINが違います");
    return;
  }
  localStorage.removeItem(LS.gems);
  localStorage.removeItem(LS.bonusTaken);
  render();
  alert("初期化しました（ログボも受け取り直せます）");
}

/** ========= 描画 ========= */
function render(){
  $("gems").textContent = getGems();
  $("oneBtn").disabled = getGems() < CFG.COST_ONE;
  $("tenBtn").disabled = getGems() < CFG.COST_TEN;

  if (!bonusTaken()) showToast(); else hideToast();
}

/** ========= イベント ========= */
function init(){
  renderRateNote();
  render();

  $("startBtn").addEventListener("click", ()=>{ SFX.click(); openOverlay(); });
  $("closeX").addEventListener("click", closeOverlay);
  $("overlay").addEventListener("click",(e)=>{ if(e.target===$("overlay")) closeOverlay(); });

  $("oneBtn").addEventListener("click", ()=>{ SFX.click(); doOne(); });
  $("tenBtn").addEventListener("click", ()=>{ SFX.click(); doTen(); });

  $("toastBtn").addEventListener("click", openBonusFlow);
  $("toast").addEventListener("click", openBonusFlow);

  // iOSで音を鳴らすため：最初のタップでAudioContext起動
  document.addEventListener("pointerdown", ()=>{
    if (!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
    }
  }, {once:true});

  // 開発用：親PIN初期化（ボタンは表に出さない）
  // どうしても欲しければURL末尾に ?reset=1 とつけると案内出す、とかも可能
  // 今回はひとまず残しません
}
init();
</script>
</body>
</html>
