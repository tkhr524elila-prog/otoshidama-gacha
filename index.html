<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ff7a00">
  <title>お年玉ガチャ（10連）</title>
  <style>
    :root{
      --bg1:#070b18; --bg2:#140a2b;
      --text:#eef3ff; --muted:#a9b4da;
      --accent:#ff7a00; --gold:#ffd54a;
      --cyan:#00e5ff; --vio:#7c4dff;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(124,77,255,.30), transparent 60%),
        radial-gradient(900px 600px at 90% 30%, rgba(0,229,255,.22), transparent 55%),
        radial-gradient(900px 600px at 60% 110%, rgba(255,122,0,.22), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding: clamp(12px, 3.5vw, 22px);
      padding-bottom: calc(clamp(12px, 3.5vw, 22px) + env(safe-area-inset-bottom));
      min-height:100%;
    }
    .wrap{max-width:720px;margin:0 auto;display:flex;flex-direction:column;gap:14px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px 14px;border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .title{font-weight:1100;letter-spacing:.03em}
    .sub{font-size:12px;color:var(--muted);line-height:1.25}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--text);font-weight:1000;
    }

    .gem{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      min-width:200px;justify-content:space-between;
    }
    .gemL{display:flex;align-items:center;gap:10px}
    .gemIcon{
      width:18px;height:18px;border-radius:6px;
      background: conic-gradient(from 160deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      box-shadow: 0 0 18px rgba(0,229,255,.34);
      transform: rotate(12deg);
    }
    .gemCount{font-weight:1100}
    .gemSmall{font-size:11px;color:var(--muted)}

    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(0,0,0,.16));
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cardIn{padding:16px}

    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    input, textarea{
      width:100%;
      color:var(--text);
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:84px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:6px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:0;cursor:pointer;
      border-radius:16px;
      padding:14px 16px;
      font-weight:1100;
      letter-spacing:.02em;
      color:#091021;
      background: linear-gradient(180deg, #ffd54a, #ff7a00);
      box-shadow: 0 16px 32px rgba(255,122,0,.30);
      display:flex;align-items:center;gap:10px;
      transition: transform .08s ease, filter .12s ease, opacity .12s ease;
      user-select:none;-webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: scale(.985)}
    .btn[disabled]{opacity:.45;cursor:not-allowed;filter:saturate(.75)}
    .btn2{
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      background: rgba(0,0,0,.16);
      box-shadow:none;
    }
    .costBadge{
      margin-left:auto;
      display:flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px;color:var(--text);
    }
    .miniGem{width:12px;height:12px;border-radius:4px;background:linear-gradient(135deg,var(--cyan),var(--vio));}

    .resultPanel{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .money{font-size:48px;font-weight:1200;letter-spacing:.02em;line-height:1.05}
    .rarity{
      display:inline-flex;align-items:center;gap:8px;
      margin-top:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      font-size:12px;font-weight:1100;
      text-transform:uppercase;
    }
    .rarDot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.25)}
    .smallnote{font-size:11px;color:var(--muted);margin-top:10px}

    /* Login bonus modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.78);
      display:none;align-items:center;justify-content:center;
      padding:18px;z-index:60;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(680px, 100%);
      border-radius:24px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(700px 400px at 30% 10%, rgba(124,77,255,.38), transparent 60%),
        radial-gradient(700px 400px at 70% 90%, rgba(0,229,255,.28), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.18));
      box-shadow: 0 30px 110px rgba(0,0,0,.70);
      overflow:hidden;
      position:relative;
    }
    .modalIn{padding:18px}
    .modalTitle{font-weight:1200;font-size:16px}
    .modalSub{font-size:12px;color:var(--muted);margin-top:6px}
    .heroRow{display:flex;gap:14px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .gift{
      width:86px;height:86px;border-radius:22px;
      background: conic-gradient(from 160deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      box-shadow: 0 0 30px rgba(0,229,255,.18), 0 0 60px rgba(124,77,255,.18);
      position:relative;
    }
    .gift::after{
      content:"";
      position:absolute;inset:10px;border-radius:18px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.18);
    }
    .bonusAmt{
      font-size:38px;font-weight:1300;letter-spacing:.02em
    }
    .bonusRow{display:flex;align-items:center;gap:10px}
    .tinyGem{width:14px;height:14px;border-radius:5px;background:linear-gradient(135deg,var(--cyan),var(--vio))}
    .footerRow{display:flex;gap:10px;justify-content:flex-end;margin-top:14px;flex-wrap:wrap}
    .okbtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      font-weight:1200;
      cursor:pointer;
    }

    /* Gacha cinematic overlay (reuse same overlay) */
    .stage{
      margin-top:12px;
      height:290px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      position:relative;overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .beam{
      position:absolute;inset:-40%;
      background: conic-gradient(from 180deg, rgba(255,213,74,.0), rgba(255,213,74,.45), rgba(255,122,0,.0));
      animation: beam 1.05s linear infinite;
      mix-blend-mode: screen;
      opacity:0;
    }
    @keyframes beam{to{transform: rotate(360deg)}}

    .orb{
      width:132px;height:132px;border-radius:999px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.16) 30%, rgba(0,0,0,.0) 60%),
        conic-gradient(from 140deg, var(--cyan), var(--vio), var(--accent), var(--cyan));
      filter:saturate(1.25);
      box-shadow: 0 0 50px rgba(124,77,255,.30), 0 0 90px rgba(0,229,255,.18);
      animation: float 1.7s ease-in-out infinite;
    }
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-11px)}}
    .spinny .orb{animation: spin 0.95s linear infinite}
    .spinny .beam{opacity:.9}
    @keyframes spin{to{transform: rotate(360deg)}}

    .rainbow{
      position:absolute;inset:-60%;
      background: conic-gradient(from 180deg,
        rgba(255,0,92,.0), rgba(255,0,92,.55),
        rgba(255,214,0,.55),
        rgba(0,229,255,.55),
        rgba(124,77,255,.55),
        rgba(255,122,0,.55),
        rgba(255,0,92,.55),
        rgba(255,0,92,.0)
      );
      opacity:0;
      filter: blur(10px) saturate(1.25);
      animation: spin 1.2s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .rainbow.show{opacity:.95}
    .flash{
      position:absolute;inset:0;background: rgba(255,255,255,1);
      opacity:0;pointer-events:none;
    }
    .flash.on{animation: flash 0.55s ease}
    @keyframes flash{0%{opacity:0}12%{opacity:.95}100%{opacity:0}}

    .chars{position:absolute;inset:0;pointer-events:none}
    .char{
      position:absolute;bottom:18px;
      width:156px;height:190px;border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      backdrop-filter: blur(6px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
      opacity:0; transform: translateY(10px);
      transition: opacity .22s ease, transform .22s ease;
    }
    .char.show{opacity:1;transform: translateY(0)}
    .char.left{left:14px}
    .char.right{right:14px}
    .charFace{
      position:absolute;left:16px;top:16px;
      width:56px;height:56px;border-radius:16px;
      background: linear-gradient(135deg, rgba(255,255,255,.20), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.10);
    }
    .charFace::before,.charFace::after{
      content:"";position:absolute;top:20px;width:8px;height:10px;border-radius:6px;background:rgba(255,255,255,.75);
    }
    .charFace::before{left:16px}
    .charFace::after{right:16px}
    .charName{position:absolute;left:84px;top:18px;font-weight:1200;font-size:12px}
    .charRole{position:absolute;left:84px;top:38px;font-weight:1000;font-size:11px;color:var(--muted)}
    .bubble{
      position:absolute;left:12px;right:12px;top:84px;
      padding:10px 10px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size:12px;line-height:1.35;
    }
    .bubble small{color:var(--muted)}

    .reveal{
      position:absolute;inset:0;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:6px;text-align:center;padding:16px;
      opacity:0;transform: scale(.98);
      transition: opacity .22s ease, transform .22s ease;
    }
    .reveal.show{opacity:1;transform:scale(1)}
    .revealMoney{font-size:54px;font-weight:1300}
    .revealRarity{font-size:14px;font-weight:1200;letter-spacing:.08em}
    .rollSummary{margin-top:8px;font-size:12px;color:var(--muted);max-width:520px}
    .pills{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:8px}
    .pill{
      font-size:11px;font-weight:1100;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      color: var(--text);
    }
    .pill.ssr{border-color: rgba(255,213,74,.45);box-shadow: 0 0 24px rgba(255,213,74,.18)}
    .confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">お年玉ガチャ（10連）</div>
        <div class="sub">
          <span class="badge">10連：100ジェム</span>
          <span class="badge">最大値採用</span>
          <span class="badge">最大30,000円</span>
        </div>
      </div>
      <div class="gem">
        <div class="gemL">
          <div class="gemIcon"></div>
          <div>
            <div class="gemCount"><span id="gems">--</span> <span class="gemSmall">GEMS</span></div>
            <div class="gemSmall">所持ジェム</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="cardIn">

        <div class="actions" style="margin-top:0">
          <button class="btn btn2" id="loginBonusBtn">ログインボーナスを受け取る</button>
          <button class="btn btn2" id="resetBtn">初期化（親PIN）</button>
        </div>

        <label style="margin-top:10px;">候補金額（カンマ区切り）</label>
        <input id="candidates" />
        <div class="hint">SSRは 3,000円（虹演出）。SSRが出ると10連最大 30,000円！</div>

        <label style="margin-top:10px;">確率（任意：金額:重み）</label>
        <textarea id="weights"></textarea>
        <div class="hint">重みが大きいほど出やすい。書かなければ均等抽選。</div>

        <div class="actions">
          <button class="btn" id="tenRollBtn">
            10連ガチャを回す
            <span class="costBadge"><span class="miniGem"></span>-<span id="cost">100</span></span>
          </button>
        </div>

        <div class="resultPanel">
          <div class="money" id="money">¥---</div>
          <div class="rarity" id="rarity"><span class="rarDot"></span><span id="rarText">READY</span></div>
          <div class="smallnote">※ ジェムが無いと回せません（ゲームと同じ）</div>
        </div>

      </div>
    </div>
  </div>

  <!-- Overlay (ログインボーナス & ガチャ演出) -->
  <div class="overlay" id="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="rainbow" id="rainbow"></div>
      <div class="flash" id="flash"></div>
      <div class="confetti" id="confetti"></div>
      <div class="modalIn">
        <div class="modalTitle" id="modalTitle">ログインボーナス</div>
        <div class="modalSub" id="modalSub">受け取って10連を回そう！</div>

        <div id="bonusArea">
          <div class="heroRow">
            <div class="gift"></div>
            <div>
              <div class="bonusRow">
                <div class="tinyGem"></div>
                <div class="bonusAmt">+3000</div>
                <div class="badge">GEMS</div>
              </div>
              <div class="modalSub">初回限定：ジェム3,000個をプレゼント！</div>
            </div>
          </div>

          <div class="footerRow">
            <button class="okbtn" id="bonusGetBtn">受け取る</button>
            <button class="okbtn" id="bonusCloseBtn">あとで</button>
          </div>
        </div>

        <div id="gachaArea" style="display:none;">
          <div class="stage spinny" id="stage">
            <div class="beam" aria-hidden="true"></div>
            <div class="orb" aria-hidden="true"></div>

            <div class="chars">
              <div class="char left" id="charL">
                <div class="charFace"></div>
                <div class="charName">召喚士 ハヤブサ</div>
                <div class="charRole">煽り担当</div>
                <div class="bubble" id="lineL">いくぞ… 最大値を掴め。</div>
              </div>
              <div class="char right" id="charR">
                <div class="charFace"></div>
                <div class="charName">精霊 ミオ</div>
                <div class="charRole">運命担当</div>
                <div class="bubble" id="lineR">SSRは3,000円。虹が見えたら勝ち。</div>
              </div>
            </div>

            <div class="reveal" id="reveal">
              <div class="revealRarity" id="revealRarity">R</div>
              <div class="revealMoney" id="revealMoney">¥---</div>
              <div class="rollSummary" id="rollSummary">10回の結果：—</div>
              <div class="pills" id="pills"></div>
              <div class="modalSub">スクショ推奨：これが今回の結果</div>
            </div>
          </div>

          <div class="footerRow">
            <button class="okbtn" id="closeBtn" disabled>OK</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    const CFG = {
      BONUS_GEMS: 3000,         // ログボで受け取る量
      COST_TENROLL: 100,        // 10連コスト
      MAX_TENROLL_PAYOUT: 30000,// 最大3万円
      SSR_AMOUNT: 3000,         // SSR=3000円
      PARENT_PIN: "2525",
      CANDIDATES: "500,1000,2000,3000",
      WEIGHTS: `500:55
1000:30
2000:12
3000:3`
    };

    const LS = {
      gems: "otg3_gems_v1",
      bonusTaken: "otg3_bonus_taken_v1"
    };

    const $ = (id) => document.getElementById(id);
    const yen = (n) => "¥" + Number(n).toLocaleString("ja-JP");

    function getGems(){
      const v = localStorage.getItem(LS.gems);
      if (!v) return 0;
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }
    function setGems(n){
      localStorage.setItem(LS.gems, String(n));
      render();
    }

    function parseCandidates() {
      const raw = $("candidates").value.trim();
      const arr = raw.split(",").map(s => s.trim()).filter(Boolean).map(Number).filter(n => Number.isFinite(n) && n >= 0);
      return arr.length ? arr : [500,1000,2000,3000];
    }
    function parseWeights() {
      const text = $("weights").value.trim();
      if (!text) return null;
      const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
      const map = new Map();
      for (const line of lines) {
        const [a,b] = line.split(":").map(s => s.trim());
        const amount = Number(a);
        const w = Number(b);
        if (Number.isFinite(amount) && Number.isFinite(w) && w > 0) map.set(amount, w);
      }
      return map.size ? map : null;
    }
    function weightedPick(cands, weightMap) {
      if (!weightMap) return cands[Math.floor(Math.random() * cands.length)];
      const items = cands.map(a => ({ a, w: weightMap.get(a) ?? 1 })).filter(x => x.w > 0);
      const total = items.reduce((s,x) => s + x.w, 0);
      let r = Math.random() * total;
      for (const it of items) {
        r -= it.w;
        if (r <= 0) return it.a;
      }
      return items[items.length - 1].a;
    }

    function setDot(r){
      const dot = $("rarity").querySelector(".rarDot");
      dot.style.background =
        r==="SSR" ? "rgba(255,213,74,.95)" :
        r==="SR" ? "rgba(255,122,0,.95)" :
        r==="R" ? "rgba(0,229,255,.95)" :
        r==="N" ? "rgba(168,179,214,.65)" :
        "rgba(255,255,255,.25)";
    }

    function rarityFromPayout(p){
      if (p >= 30000) return "SSR";
      if (p >= 20000) return "SR";
      if (p >= 10000) return "R";
      return "N";
    }

    // WebAudio (no files)
    let audioCtx;
    function beep(seq){
      try{
        audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const t0 = audioCtx.currentTime + 0.01;
        seq.forEach((s)=>{
          const o = audioCtx.createOscillator();
          const g = audioCtx.createGain();
          o.type = s.type || "sine";
          o.frequency.value = s.f;
          g.gain.value = 0.0001;
          o.connect(g); g.connect(audioCtx.destination);
          o.start(t0 + s.at);
          g.gain.setValueAtTime(0.0001, t0 + s.at);
          g.gain.exponentialRampToValueAtTime(s.v || 0.12, t0 + s.at + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t0 + s.at + s.d);
          o.stop(t0 + s.at + s.d + 0.03);
        });
      }catch(e){}
    }
    function vibe(ms){ if (navigator.vibrate) navigator.vibrate(ms); }

    function sfxBonus(){ beep([{at:0,f:523.25,d:0.12,v:0.10,type:"square"},{at:0.12,f:659.25,d:0.12,v:0.11,type:"square"}]); }
    function sfxTenStart(){ beep([{at:0,f:196,d:0.10,v:0.10,type:"square"},{at:0.10,f:247,d:0.10,v:0.10,type:"square"}]); }
    function sfxDrum(){ beep([{at:0,f:110,d:0.07,v:0.08,type:"sine"},{at:0.08,f:98,d:0.08,v:0.08,type:"sine"}]); }
    function sfxSSR(){
      beep([
        {at:0.00,f:523.25,d:0.14,v:0.14,type:"sawtooth"},
        {at:0.14,f:659.25,d:0.14,v:0.14,type:"sawtooth"},
        {at:0.28,f:783.99,d:0.22,v:0.16,type:"sawtooth"},
        {at:0.52,f:1046.5,d:0.25,v:0.18,type:"sine"}
      ]);
    }
    function sfxNormal(r){
      if (r==="SR") beep([{at:0,f:392,d:0.14,v:0.12},{at:0.14,f:523.25,d:0.20,v:0.13}]);
      else if (r==="R") beep([{at:0,f:330,d:0.14,v:0.10},{at:0.14,f:440,d:0.18,v:0.11}]);
      else beep([{at:0,f:262,d:0.12,v:0.08}]);
    }

    function flash(){
      const f = $("flash");
      f.classList.remove("on"); void f.offsetWidth; f.classList.add("on");
    }

    function confettiBurst(kind){
      const wrap = $("confetti");
      wrap.innerHTML = "";
      const count = kind==="SSR" ? 70 : (kind==="SR" ? 36 : (kind==="R" ? 22 : 12));
      for(let i=0;i<count;i++){
        const el = document.createElement("div");
        el.style.position="absolute";
        el.style.top="-24px";
        el.style.left = (Math.random()*100) + "%";
        const w = 6 + Math.random()*10;
        const h = 10 + Math.random()*18;
        el.style.width = w+"px";
        el.style.height = h+"px";
        el.style.borderRadius = "4px";
        const col =
          kind==="SSR" ? ["rgba(255,0,92,.95)","rgba(255,214,0,.95)","rgba(0,229,255,.95)","rgba(124,77,255,.95)","rgba(255,122,0,.95)"][Math.floor(Math.random()*5)]
          : kind==="SR" ? (Math.random()<.5 ? "rgba(255,213,74,.95)" : "rgba(255,122,0,.95)")
          : kind==="R" ? (Math.random()<.5 ? "rgba(0,229,255,.95)" : "rgba(255,255,255,.85)")
          : (Math.random()<.5 ? "rgba(255,255,255,.75)" : "rgba(168,179,214,.75)");
        el.style.background = col;

        const dur = 800 + Math.random()*900;
        const rot = Math.random()*360;
        const drift = (Math.random()*140 - 70);
        el.animate(
          [
            { transform:`translate(0px,-10px) rotate(${rot}deg)`, opacity:1 },
            { transform:`translate(${drift}px,340px) rotate(${rot+700}deg)`, opacity:0.95 }
          ],
          { duration: dur, delay: Math.random()*180, easing: "linear", fill:"forwards" }
        );
        wrap.appendChild(el);
      }
    }

    const LINES_L = {
      start: [
        "いくぞ… 最大値を掴め。",
        "ジェム100の価値、見せてみろ。",
        "虹が見えたら…終わりだ。勝ちだ。"
      ],
      mid: [
        "…来い、SSR（3,000円）",
        "最大3万円。引けるか？",
        "その指で運命を決めろ。"
      ],
      end: [
        "よし、受け取れ。",
        "スクショしろ。証拠は強い。",
        "次は…ジェムがある時だけだ。"
      ]
    };
    const LINES_R = {
      start: [
        "10回の運命が、動き出すよ。",
        "最大値だけが残る…強い。",
        "SSRは3,000円。虹で祝福するね。"
      ],
      mid: [
        "虹、見たい？見せてあげる。",
        "SSRが出たら…画面が光るよ。",
        "最大30,000円。届くかな？"
      ],
      end: [
        "おめでとう。これが今回の結果。",
        "ジェムが足りない時は…また今度。",
        "保存してね。"
      ]
    };
    function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function showOverlay(mode){
      $("overlay").classList.add("show");
      if (mode==="bonus"){
        $("modalTitle").textContent = "ログインボーナス";
        $("modalSub").textContent = "初回限定：ジェム3,000個をプレゼント！";
        $("bonusArea").style.display = "block";
        $("gachaArea").style.display = "none";
      }else{
        $("bonusArea").style.display = "none";
        $("gachaArea").style.display = "block";
      }
    }
    function hideOverlay(){
      $("overlay").classList.remove("show");
    }

    async function cinematic(rolls, payout, rar){
      showOverlay("gacha");
      $("reveal").classList.remove("show");
      $("closeBtn").disabled = true;
      $("stage").classList.add("spinny");
      $("confetti").innerHTML = "";
      $("rainbow").classList.remove("show");

      $("charL").classList.add("show");
      $("charR").classList.add("show");
      $("lineL").innerHTML = randPick(LINES_L.start) + "<br><small>（最大値採用）</small>";
      $("lineR").innerHTML = randPick(LINES_R.start) + "<br><small>（SSR=3,000円）</small>";

      sfxTenStart(); vibe(25);

      for(let i=0;i<10;i++){
        await new Promise(r=>setTimeout(r, 140));
        sfxDrum();
        if (i%2===0) vibe(10);
        if (i===4){
          $("lineL").textContent = randPick(LINES_L.mid);
          $("lineR").textContent = randPick(LINES_R.mid);
        }
      }

      await new Promise(r=>setTimeout(r, 420));
      $("stage").classList.remove("spinny");

      if (rar==="SSR"){
        $("rainbow").classList.add("show");
        flash(); setTimeout(flash, 180); setTimeout(flash, 360);
        sfxSSR(); vibe(140);
      }else{
        sfxNormal(rar);
        vibe(rar==="SR" ? 80 : (rar==="R" ? 45 : 25));
      }
      confettiBurst(rar);

      const pills = $("pills");
      pills.innerHTML = "";
      rolls.forEach(v=>{
        const p = document.createElement("div");
        p.className = "pill" + (v===3000 ? " ssr" : "");
        p.textContent = yen(v);
        pills.appendChild(p);
      });

      $("revealMoney").textContent = yen(payout);
      $("revealRarity").textContent = rar + "（結果）";
      $("rollSummary").textContent = "10回の結果：" + rolls.map(yen).join(" / ");

      $("lineL").textContent = randPick(LINES_L.end);
      $("lineR").textContent = randPick(LINES_R.end);

      $("reveal").classList.add("show");
      $("closeBtn").disabled = false;
      renderResult(payout, rar);
    }

    function render(){
      $("gems").textContent = getGems();
      $("tenRollBtn").disabled = getGems() < CFG.COST_TENROLL;
      $("candidates").value ||= CFG.CANDIDATES;
      $("weights").value ||= CFG.WEIGHTS;
    }

    function renderResult(payout, rar){
      $("money").textContent = yen(payout);
      $("rarText").textContent = rar;
      setDot(rar);
    }

    function doTenRoll(){
      const gems = getGems();
      if (gems < CFG.COST_TENROLL){
        alert("ジェムが足りません（10連は100ジェム必要）");
        return;
      }
      setGems(gems - CFG.COST_TENROLL);

      const cands = parseCandidates();
      const weightMap = parseWeights();
      const rolls = Array.from({length:10}, ()=>weightedPick(cands, weightMap));

      const max = Math.max(...rolls);
      // “10連で最大3万円”を成立させる：最大値×10（SSR=3000なら30000）
      const payout = Math.min(max * 10, CFG.MAX_TENROLL_PAYOUT);

      const rar = rarityFromPayout(payout);

      cinematic(rolls, payout, rar);
      render();
    }

    function takeBonus(){
      const taken = localStorage.getItem(LS.bonusTaken) === "1";
      if (taken){
        alert("ログインボーナスは受け取り済みです");
        return;
      }
      const next = getGems() + CFG.BONUS_GEMS;
      localStorage.setItem(LS.bonusTaken, "1");
      setGems(next);
      sfxBonus(); vibe(40);
      confettiBurst("SSR"); // 派手に
      setTimeout(()=>{ hideOverlay(); }, 400);
    }

    function resetAll(){
      const pin = prompt("親PINを入力してください");
      if (pin === null) return;
      if (pin !== CFG.PARENT_PIN){
        alert("PINが違います");
        return;
      }
      localStorage.removeItem(LS.gems);
      localStorage.removeItem(LS.bonusTaken);
      renderResult(0, "READY");
      render();
      alert("初期化しました（ボーナスも受け取り直せます）");
    }

    function init(){
      $("candidates").value = CFG.CANDIDATES;
      $("weights").value = CFG.WEIGHTS;

      $("tenRollBtn").addEventListener("click", doTenRoll);
      $("loginBonusBtn").addEventListener("click", ()=>showOverlay("bonus"));
      $("bonusGetBtn").addEventListener("click", takeBonus);
      $("bonusCloseBtn").addEventListener("click", hideOverlay);
      $("resetBtn").addEventListener("click", resetAll);

      $("closeBtn").addEventListener("click", hideOverlay);
      $("overlay").addEventListener("click", (e)=>{
        if (e.target === $("overlay")) hideOverlay();
      });

      render();
    }
    init();
  </script>
</body>
</html>
